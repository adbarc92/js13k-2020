(()=>{window.running=!0,window.addEventListener("load",async()=>{await ae(),$e(),I(),(()=>{const t=ce();le(t),window.world=t;const e=t.party,n=V(ct,"Jeremiah"),a=V(lt,"Seph"),s=V(ht,"Kana");zt(e,n),zt(e,a),zt(e,s);const r=performance.now();let o=r;const i=n=>{const a=(n-o)/16.666;X(a>2?2:a),W(n-r),o=n,Ie();const s=A();if(s)Me(s);else{const n=de(t),a=jt(e).actor;y(t),ke(n,0,0,2),Ce(a,2)}window.running&&requestAnimationFrame(i)};i(r)})()});const t=t=>Math.abs(t)/t,e=(t,e,n,a)=>[t,e,t+n,e+a],n=(t,e)=>[t,e],a=(t,e)=>t.map((t,n)=>((t,e)=>{const[n,a]=t,[s,r,o,i]=e;return n>s&&n<o&&a>r&&a<i})(t,e)?n:-1).filter(t=>t>-1),s=t=>{const[e,a,s,r]=t,o=s-e,i=e+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(e+o/4,c),n(s-o/4,c)]},r=(t,e)=>t.allies.includes(e),o=async t=>new Promise(e=>{setTimeout(e,t)}),i=(t,e)=>he().pause?0:Math.floor(q()%((t+1)*e)/e);window.addEventListener("keydown",t=>{Z()||Ft(t.key)}),window.addEventListener("keyup",t=>{At(t.key)});const c=async(t,e)=>(e||Ee("cutscene"),new Promise(e=>{Ae(t,e)})),l=async(t,e)=>{Ee(e||"menuConfirm"),c("",!0);const n=he();n.pause=!0,await o(250);for(let e=0;e<t.length;e++){const n=t[e].trim();n&&await c(n)}Ee("menuCancel"),n.pause=!1},h=async t=>{const e=(t=>[`This sign says: "${t}"`])(t);await l(e),Ge()},p=t=>{const e=he(),n=jt(e.party),a=t.actor;T(a,n.actor.x<a.x?b:S)},d=async(t,e,n)=>{let a=[""];const s=he().party,r=Ut(s,e),i=e.name+"_fixed";ye(i)?a=["You have fixed this statue."]:r?(await l(`\nYou place the '${r.name}' inside the statue.\n...\nSomething awakens inside it.\n`.split("\n")),Ht(s,r),await o(150),Ee("item"),t.actor.spriteIndex=12,await o(2e3),a=["You have fixed the statue!"],me(i,!0)):a=`\nThere's a plaque beneath this statue.\nIt says, "${n}"\nThis statue appears to be missing a something...\n`.split("\n"),await l(a),Ge()},u=async(t,e)=>{const n=he(),{name:a,dsc:s}=e,r=["You acquired: "+a,s];n.pause=!0,await l(r,"item"),Ge();const o=de(n);qt(o,t),Dt(n.party,e)},m=(t,e)=>{const n=t[e];n<0?t[e]+=1.2:n>0&&(t[e]-=1.2),Math.abs(t[e])<=1.2&&(t[e]=0)},y=t=>{if(t.pause)return;const e=de(t),{characters:n}=e;n.forEach(t=>{g(t.actor,e)}),f(t.party,e,t)},f=(t,e,n)=>{const r=jt(t).actor,{ax:o,ay:i,isGround:c}=r;L(r,k),et(null);let l=o,h=i;const p=c?1.2:.04;Ot(Lt)&&(l=-p,T(r,b),L(r,C)),Ot(Pt)&&(l=p,T(r,S),L(r,C)),Ot(Bt)&&r.isGround&&(Ee("jump"),h=-5.1,r.vy=0,r.isGround=!1),Ot(Yt)&&(r.disablePlatformCollision=!0),r.isGround||L(r,M),P(r,l,h);const[d,u]=g(r,e);(d||u)&&pe(d,u,n);const m=s(Y(r));for(let t in e.characters){const n=e.characters[t],s=n.actor;K("",n);const r=Y(s);let o=!1;a(m,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&K(i,n),et(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},g=(n,r)=>{(t=>{const e=N();t.ay+=t.isGround?1e-4*e:.2*e})(n);let o=0,i=0;const c=N();let{x:l,y:h,vx:p,vy:d,ax:u,ay:y,w:f,h:g}=n,w=p+u*c,I=d+y*c;Math.abs(w)>1.2&&(w=1.2*t(w)),Math.abs(I)>3.2&&(I=3.2*t(I)),E(n,w,I);let x=l+p*c,v=h+d*c;const[b,S]=Wt(r);return x<0?(x=0,o=-1):x+f>b&&(x=b-f,o=1),v<0?(v=0,i=-1):v+g>S&&(v=S-g,i=1),_(n,x,v),((t,n)=>{let r,o,i=!1,c=0;const l=Kt(n);do{c++,r=!1,o=!1;const n=s(e(t.x,t.y,t.w,t.h)),h={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=e(s.px,s.py,s.size,s.size);Vt(s)?a(n,i).forEach(t=>{r=!0,h[t]=s}):t.y+t.h/2<s.py&&a(n,i).forEach(e=>{0!==e||t.disablePlatformCollision||(o=!0,r=!0,h[e]=s)})});const p=h[1],d=h[2],u=h[3],m=1;h[0]?t.vy>0&&(t.y=16*Math.floor((t.y+8)/16),i=!0):p&&(o||(t.y+=m,t.vy=0)),d?t.x+=m:u&&(t.x-=m)}while(r&&c<10);i===t.isGround||i||(t.vy=0),t.isGround=i})(n,r),0===u&&m(n,"vx"),0===y&&m(n,"vy"),P(n,0,0),[o,i]},w={},I=()=>{w["1,1,10,15"]=pt,w["1,1,11,11"]=ut,w["1,1,4,9"]=dt,w["1,1,5,15"]=mt,w["0,1,9,15"]=yt,w["0,1,7,11"]=vt,w["0,1,9,11"]=vt,w["0,1,11,11"]=vt,w["0,1,13,11"]=vt,w["0,1,8,7"]=vt,w["0,1,10,7"]=vt,w["0,1,12,7"]=vt,w["0,1,14,7"]=St,w["0,1,7,3"]=vt,w["0,1,9,3"]=vt,w["0,1,11,3"]=vt,w["0,1,13,3"]=bt,w["2,2,2,15"]=kt,w["2,2,3,3"]=Tt,w["2,2,2,12"]=Ct,w["2,2,1,12"]=Ct,w["2,1,5,15"]=Ct,w["2,1,3,15"]=Ct,w["2,1,4,15"]=Ct,w["2,1,3,13"]=Ct,w["2,1,9,9"]=Ct,w["2,1,1,15"]=ft,w["2,1,8,5"]=Ct,w["2,1,10,15"]=Ct,w["2,0,2,2"]=gt,w["3,0,2,3"]=wt,w["3,0,4,10"]=Ct,w["3,0,11,14"]=Ct,w["3,1,2,7"]=Ct,w["3,0,1,14"]=Ct,w["3,0,14,7"]=Ct,w["3,1,12,7"]=Ct,w["3,1,3,14"]=Ct,w["3,2,1,5"]=Ct,w["3,1,14,10"]=Ct,w["3,1,9,12"]=Ct,w["3,1,6,12"]=Ct,w["3,2,2,8"]=Ct,w["3,2,11,4"]=Ct,w["3,2,11,12"]=Ct,w["3,0,7,3"]=Ct,w["3,2,14,12"]=Ct,w["3,3,3,15"]=Ct,w["3,3,14,7"]=Ct,w["3,0,7,9"]=Ct,w["3,1,4,5"]=Ct,w["3,2,4,7"]=Ct,w["3,2,7,7"]=Ct,w["3,2,5,7"]=Ct,w["3,2,5,13"]=Ct,w["3,3,8,5"]=Ct,w["3,3,7,5"]=Ct,w["3,1,7,12"]=Ct,w["3,1,6,4"]=Ct,w["3,3,8,15"]=It,w["3,3,1,3"]=_t,w["0,3,3,15"]=Ct,w["0,3,3,11"]=Ct,w["0,3,8,4"]=Ct,w["0,3,5,3"]=Ct,w["0,3,11,10"]=Ct,w["0,3,12,6"]=Ct,w["0,3,14,12"]=Ct,w["0,3,7,15"]=Ct,w["0,3,1,6"]=Ct,w["0,0,11,5"]=Ct,w["0,0,12,15"]=Ct,w["0,0,7,5"]=Ct,w["0,0,6,15"]=Ct,w["0,0,3,5"]=Ct,w["0,0,3,15"]=Ct,w["0,0,9,15"]=Ct,w["0,0,4,9"]=Ct,w["0,0,6,9"]=Ct,w["0,0,8,9"]=Ct,w["0,0,10,9"]=Ct,w["0,0,12,9"]=Ct,w["1,0,11,13"]=$t,w["1,0,2,15"]=xt,w["1,0,13,8"]=_t,w["2,0,3,9"]=Mt,w["2,0,4,9"]=Mt,w["2,0,5,9"]=Mt,w["2,0,6,8"]=Mt,w["2,0,2,8"]=Mt,w["2,0,8,9"]=_t,w["0,2,4,15"]=_t,w["0,0,15,9"]=Mt,w["1,0,0,9"]=Mt};var x,v;x=(t=1,e=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,h=0,p=0,d=0,u=0,m=0,y=0,f=0,g=1,w=0,I=44100,x=99+a*I,b=s*I,S=r*I,k=w*I,C=f*I,M=2*Math.PI,T=(t=>0<t?1:-1),_=x+k+b+S+C,$=(c*=500*M/I**2),E=(n*=(1+2*e*Math.random()-e)*M/I),P=T(m)*M/4,L=0,Y=0,B=0,F=0,G=0,A=0,O=1,j=[],z=v.createBufferSource(),D=v.createBuffer(1,_,I))=>{for(z.connect(v.destination);B<_;j[B++]=A)++G>100*y&&(G=0,A=L*n*Math.sin(Y*m*M/I-P),A=T(A=o?1<o?2<o?3<o?Math.sin((A%M)**3):Math.max(Math.min(Math.tan(A),1),-1):1-(2*A/M%2+2)%2:1-4*Math.abs(Math.round(A/M)-A/M):Math.sin(A))*Math.abs(A)**i*t*.3*(B<x?B/x:B<x+k?1-(B-x)/k*(1-g):B<x+k+b?g:B<_-C?(_-B-C)/S*g:0),A=C?A/2+(C>B?0:(B<_-C?1:(B-_)/C)*j[B-C|0]/2):A),L+=1-u+1e9*(Math.sin(B)+1)%2*u,Y+=1-u+1e9*(Math.sin(B)**2+1)%2*u,n+=c+=500*l*M/I**3,O&&++O>p*I&&(n+=h*M/I,E+=h*M/I,O=0),d&&++F>d*I&&(n=E,c=$,F=1,O=O||1);return D.getChannelData(0).set(j),z.buffer=D,z.start(),z},v=new AudioContext;const b=0,S=1,k=0,C=1,M=2,T=(t,e)=>{t.facing=e},_=(t,e,n)=>{t.x=e,t.y=n},$=t=>[t.x,t.y],E=(t,e,n)=>{t.vx=e,t.vy=n},P=(t,e,n)=>{t.ax=e,t.ay=n},L=(t,e)=>{t.anim=e},Y=t=>e(t.x,t.y,t.w,t.h),B=t=>{const e=[];for(let n=0;n<4;n++)e.push([t,28*n+80]);return e},F=B(40),G=B(200),A=()=>null,O=t=>t.rounds[t.roundIndex];let j=null,z=1,D=0;const H=(t,e)=>{const n=document.createElement("canvas");return n.width=t,n.height=e,[n,n.getContext("2d"),t,e]},U=()=>{var t;if(j)return j;{const[e,n]=H(512,512);return e.id="canv",n.imageSmoothingEnabled=!1,null===(t=document.getElementById("innerDiv"))||void 0===t||t.appendChild(e),j=e,e}},R=()=>U().getContext("2d"),X=t=>{z=t},N=()=>z,W=t=>{D=t},q=()=>D,K=(t,e)=>{e.aText=t},V=(t,e)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,name:c}=t,l={sprite:"actors",spriteIndex:n,facing:b,anim:k,isGround:!1,disablePlatformCollision:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return a&&(l.sprite=a),{name:e||c,actor:l,label:r||"",action:o,col:i,aText:"",unit:s?se(c,l,t,0,0):void 0}};let J=!1,Q=null;const Z=()=>J,tt=t=>{J=t},et=t=>Q=t,nt=(t,e,n,a,s)=>({hp:t,dmg:e,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),at={name:"Bomb",dsc:"It destroys all enemies!",onUse:()=>{}},st={name:"Statue's Legs",dsc:"Good for running.",onUse:()=>{}},rt={name:"Statue's Voice",dsc:"The sound a mouth makes.  Not the game show.",onUse:()=>{}},ot={name:"Statue's MIND",dsc:"Arguably necessary to have.",onUse:()=>{}},it=(nt(30,20,30,1,5),nt(20,8,5,5,15),nt(20,30,5,1,15),nt(40,30,14,1,14),{name:"",stats:{bS:nt(90,25,16,5,20),ai:0},sprI:0}),ct={name:"",stats:{bS:nt(85,25,13,6,15),ai:0},sprI:0},lt={name:"",stats:{bS:nt(80,19,18,4,6),ai:0},sprI:0},ht={name:"",stats:{bS:nt(75,23,12,7,10),ai:0},sprI:0},pt={name:"Old Man",sprI:15,action:async t=>{p(t);const e="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\n:)\nIt may be prudent for you to find what is not found and restore them.\n  ".split("\n");await l(e),Ge()}},dt={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async t=>{d(t,st,"The Runner.")}},ut={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async t=>{d(t,ot,"The Thinker.")}},mt={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async t=>{d(t,rt,"The Speaker.")}},yt={name:"Sign",spr:"terrain",sprI:5,action:()=>h("Probably nothing is in these pots.")},ft={name:"Sign",spr:"terrain",sprI:5,action:()=>h("SPIKES are dangerous.")},gt={name:"Sign",spr:"terrain",sprI:5,action:()=>h("This fall is pointless.")},wt={name:"Sign",spr:"terrain",sprI:5,action:()=>h("This fall is pointy.")},It={name:"Sign",spr:"terrain",sprI:5,action:()=>h("(There is a picture of an arrow pointing upwards followed by a `?`)")},xt={name:"Sign",spr:"terrain",sprI:5,action:()=>h("The SHRINE of LEGS.")},vt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const t="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await l(t),Ge()}},bt={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const t="\nThere's something strange about this pot...\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await l(t),Ge()}},St={name:"Pot",spr:"terrain",sprI:4,action:async t=>{const e="\nYou check the pot...\n  ".split("\n");await l(e),await u(t,rt),await l(["How did that get in there?"]),Ge()}},kt={name:"Pate",sprI:3,action:async t=>{p(t);let e=[""];e=fe("talked_to_pate")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\nNo? Come back when you have!\n      ".split("\n"),await l(e),Ge()}},Ct={name:"",spr:"terrain",sprI:6,col:async()=>{const t=he();t.pause=!0,Ee("spikes"),await o(1e3),t.pause=!1,ue(he())}},Mt={name:"",spr:"terrain",sprI:1},Tt={name:"A gleaming item...",spr:"terrain",sprI:4,action:async()=>{const t="\nA gleaming marble radiating shifting hues...\n    ".split("\n");await l(t),Ge()}},_t={name:"Item",spr:"terrain",sprI:11,action:t=>u(t,at)},$t={name:"Item",spr:"terrain",sprI:11,action:t=>u(t,st)},Et={},Pt="ArrowRight",Lt="ArrowLeft",Yt="ArrowDown",Bt=" ",Ft=t=>{if(1===t.length&&(t=t.toUpperCase()),!Et[t]){if(Et[t]=!0,"Q"===t&&(window.running=!1),Z())return;if(A(),"X"===t||"Enter"===t){const t=Q;t&&t()}}};let Gt=-1;const At=t=>{if(1===t.length&&(t=t.toUpperCase()),t===Yt){const t=he(),e=jt(t.party).actor;e.disablePlatformCollision&&(clearTimeout(Gt),Gt=setTimeout(()=>{e.disablePlatformCollision=!1},150))}Et[t]=!1},Ot=t=>(1===t.length&&(t=t.toUpperCase()),Et[t]),jt=t=>t.characters[0],zt=(t,e)=>{t.characters.push(e)},Dt=(t,e)=>{const n=Object.assign({},e);t.inv.push(n),Oe(t.inv,!0)},Ht=(t,e)=>{const n=t.inv.indexOf(e);n>-1&&t.inv.splice(n,1),Oe(t.inv,!0)},Ut=(t,e)=>{for(let n in t.inv){const{name:a}=t.inv[n];if(a===e.name)return t.inv[n]}return null},Rt={0:[156,100,52],1:[171,82,54],2:[0,228,54],3:[0,135,81],4:[29,43,83],5:[95,87,79],6:[194,195,199],7:[255,241,232],8:[255,0,77],15:[0,0,0]},Xt={};for(let t in Rt)Xt[Rt[t].join("")]=+t;const Nt=(t,e,n,a)=>{const s=[],r=[],[,o]=H(16,16);Se(t,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let t=0;t<i.length;t+=4){let e=Xt[`${i[t+0]}${i[t+1]}${i[t+2]}`]||0;const o=c%16,l=Math.floor(c/16);let h=null;const p=w[[n,a,o,l].join(",")];p&&(h=V(p)),h&&(_(h.actor,16*o,16*l-16),r.push(h)),s.push({id:e,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:e}},Wt=t=>[16*t.w,16*t.h],qt=(t,e)=>{const n=t.characters.indexOf(e);n>-1&&t.characters.splice(n,1)},Kt=t=>t.tiles.filter(t=>[0,1,2,7].includes(t.id)),Vt=t=>[0,1,7].includes(t.id),Jt=(t,e,n,a,s)=>[t,e,n,a,s];let Qt=null;const Zt=t=>{const[e,n,a,s]=H(t.width,t.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(t,-r,-o),e},te=t=>{const[e,n,a]=H(t.width,t.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(t,0,0),e},ee=t=>{const[,,,e,n]=t,[a,s]=H(e,n);return Se(t,0,0,1,s),a},ne=(t,e,n,a,s)=>{const r=(e,n,a,s,r,o)=>t[e]=Jt(n,a,s,r,o),o=(t,e,n)=>{let o=t;for(let t=0;t<n;t++)o=Zt(o);r(`${e}_r${n}`,o,0,0,a,s)},i=e.width/a,c=e.height/s;for(let t=0;t<c;t++)for(let c=0;c<i;c++){const l=`${n}_${t*i+c}`,h=r(l,e,c*a,t*s,a,s);o(ee(h),l,1),o(ee(h),l,2),o(ee(h),l,3),r(l+"_f",te(ee(h)),0,0,a,s),r(l+"_fr1",Zt(te(ee(h))),0,0,a,s)}},ae=async()=>{const t={},e=await new Promise(t=>{const e=new Image;e.onload=()=>{t(e)},e.src="packed.png"}),n=ee(Jt(e,0,0,64,64));ne(t,n,"actors",16,16);const a=ee(Jt(e,64,0,64,64));ne(t,a,"terrain",16,16);const s=ee(Jt(e,0,64,64,64));ne(t,s,"map",16,16);const r=ee(Jt(e,64,64,64,64));ne(t,r,"monsters",16,16),Qt=t},se=(t,e,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${t}' has no stats!`);const o={name:t,actor:e,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return T(o.actor,o.allegiance?b:S),re(o),o},re=t=>{const[e,n]=(a=t.i,0===t.allegiance?F[a]:G[a]);var a;_(t.actor,e,n)};let oe=null;const ie={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},ce=()=>{const t={characters:[V(it,"Runner")],inv:[],worldX:0,worldY:0},e=jt(t);_(e.actor,128,180);const n={rooms:[],party:t,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let t=0;t<16;t++)n.rooms.push(Nt("map_"+t,ie[t],t%4,Math.floor(t/4)));return n},le=t=>{oe=t},he=()=>oe,pe=(t,e,n)=>{((t,e,n)=>{n.roomI=4*e+t})((n.roomI%4+t+4)%4,(Math.floor(n.roomI/4)+e+4)%4,n);const a=de(n),s=jt(n.party).actor,[r,o]=Wt(a);let i=0,c=0;t>0&&(i=0,c=s.y),t<0&&(i=r-16,c=s.y),e>0&&(i=s.x,c=0),e<0&&(i=s.x,c=o-16),_(s,i,c),n.lastX=i,n.lastY=c},de=t=>t.rooms[t.roomI],ue=t=>{const e=jt(t.party);_(e.actor,t.lastX,t.lastY)},me=(t,e)=>{he().state[t]=e},ye=t=>he().state[t],fe=t=>void 0===ye(t)&&(me(t,!0),!0),ge={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},we={},Ie=()=>{const t=U();be(0,0,t.width,t.height,"#557","#aaf")},xe=(t,e,n,a,s,r,o)=>{(o=o||R()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](t,e,n,a)},ve=(t,e,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},ge),a||{});(s=s||R()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(t,e,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(t,e,n))},be=(t,e,n,a,s,r)=>{const o=R(),i=`${t},${e},${n},${a},${s},${r}`;if(!we[i]){const t=o.createLinearGradient(0,a,0,0);t.addColorStop(0,s),t.addColorStop(1,r),we[i]=t}o.fillStyle=we[i],o.fillRect(t,e,n,a)},Se=(t,e,n,a,s)=>{a=a||1,s=s||R();const[r,o,i,c,l]="string"==typeof t?Qt[t]:t;s.drawImage(r,o,i,c,l,e,n,c*a,l*a)},ke=(t,e,n,a)=>{const s=a||1;t.tiles.forEach(r=>{const{id:o,x:i,y:c,size:l}=r,h=(e+i*l)*s,p=(n+c*l)*s;Se(t.bgSprite,h,p,a),15!=o&&Se("terrain_"+o,h,p,a)}),t.characters.forEach(t=>{const e=t.actor;Ce(e,a);const{x:n,y:r}=e,o=t.aText;o&&ve(o,n*s+16*s/2,r*s-16*s/2,{size:16,align:"center"})})},Ce=(t,e)=>{e=e||1;const{x:n,y:a}=t,s=n*e,r=a*e,[o,c,l]=(t=>{let{facing:e,sprite:n,spriteIndex:a,anim:s}=t,r=s,o=a<3,c=0;s===C?r-=i(1,100):3===s?o?r=2-i(1,250):(r=0,c=2*i(1,100)):4===s&&(r=o?2:0);let l="";switch(e){case 0:l="_f";break;case 2:l="_r3";break;case 3:l="_fr1"}return[n+"_"+(a+r+l),0,c]})(t);Se(o,s+c,r+l,e)},Me=t=>{Ie();const e=(n=O(t)).turnOrder[n.currentIndex]||null;var n;Pe(5,15,150,20),ve("Turn: "+(null==e?void 0:e.name),10,26);const{allies:a,enemies:s}=t;for(let t=0;t<a.length;t++){const[e,n]=$(a[t].actor);_(a[t].actor,e,n),Ce(a[t].actor,2),ve(""+a[t].name,2*e+16,2*n-5,{align:"center"})}Ye(t,0),Ye(t,1);for(let t=0;t<s.length;t++){const[e,n]=$(s[t].actor);Ce(s[t].actor,2),ve(`${s[t].name}: ${""+s[t].cS.hp}/${""+s[t].bS.hp}`,2*e+5,2*n-5,{align:"center"})}t.text&&Le(t.text),Be(t)};let Te=null;const _e=(t,e,n)=>{t[e]=n},$e=()=>{const t={};_e(t,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),_e(t,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),_e(t,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),_e(t,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),_e(t,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),_e(t,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),_e(t,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),_e(t,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),_e(t,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),_e(t,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),_e(t,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),_e(t,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),_e(t,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),Te=t},Ee=t=>{x(...Te[t])},Pe=(t,e,n,a,s)=>{xe(t,e,n,a,s=s||"#000"),xe(t,e,n,a,"#FFF",!0)},Le=t=>{Pe(0,90,512,50),ve(t,256,116,{align:"center",size:20})},Ye=(t,e)=>{const n=1===e?312:0;Pe(n,422,200,90),Pe(0,397,200,25),ve("Unit",10,409.5),ve("HP",80,409.5),ve("Chg",140,409.5),ve("Int",170,409.5);const a=1===e?t.enemies:t.allies;for(let t=0;t<a.length;t++){const s=a[t],{name:r,bS:o,cS:i}=s;0===e?(ve(r.slice(0,8),n+10,437+20*t),ve(`${i.hp}/${o.hp}`,n+80,437+20*t),ve(""+i.cCnt,n+145,437+20*t),ve(""+i.iCnt,n+175,437+20*t)):ve(r.slice(0,8),n+100,437+20*t,{align:"center"})}},Be=t=>{const{turnOrder:e}=O(t),n=e.length,a=35*n;let s=512-512/3-a/2;Pe(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:o}=e[a],{sprite:i,spriteIndex:c}=o,l=10+(O(t).currentIndex===a?20:10);Pe(s,l,30,40,r(t,e[a])?"#29ADFF":"#FF004D");const h=r(t,e[a])?l-5:l+40+8;ve(n.slice(0,5),s+15,h,{size:12,align:"center",strokeColor:"#FFF"}),Se(`${i}_${c}`,s,l+5,2)}};let Fe=null,Ge=()=>{const t=document.getElementById("dialogBox");window.removeEventListener("keypress",Fe),t.style.opacity="0",t.style.width="0",tt(!1)};const Ae=(t,e)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",Fe),n.innerHTML=`<div style="width:476px">${t}</div>`,n.style.opacity="1",n.style.width="512px",Fe=t=>{const n=t.key.toUpperCase();n!==Bt&&"X"!==n||(window.removeEventListener("keypress",Fe),e())},setTimeout(()=>{window.addEventListener("keypress",Fe)},25),tt(!0)},Oe=(t,e)=>{const n=document.getElementById("itemBox");n.innerHTML=`<span class="item">${t.length?"Items:":""}</span>`;for(let e=0;e<t.length;e++){const a=document.createElement("span");a.innerHTML=t[e].name+(e<t.length-1?",":""),a.className="item",n.appendChild(a)}n.style.display=e?"flex":"none"}})();