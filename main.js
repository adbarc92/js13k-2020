(()=>{window.running=!0,window.addEventListener("load",async()=>{await Oe(),Ne(),(()=>{const e=r();o(e);const t=performance.now();let n=t;const a=r=>{Ke(e);const o=(r-n)/16.666;fe(o>2?2:o),me(r-t),n=r,window.running&&requestAnimationFrame(a)};a(t)})()});const e=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),t=e=>Math.floor(Math.random()*Math.floor(e)),n=(e,t)=>e.allies.includes(t),a=async e=>new Promise(t=>{setTimeout(t,e)}),r=()=>{const e=_e("Jimothy",100,10,5,5,5,0,E),t=_e("Seph",100,10,5,5,4,1,E),n=_e("Kana",100,8,3,2,7,2,E),a=_e("Karst",100,10,5,5,5,0,A),r=_e("Urien",100,10,5,5,5,1,A),o=_e("Shrike",100,8,6,3,2,2,A),c=L([e,t,n],[a,r,o]),s=ee([e,a,t,r,n,o]);return Y(c,s),G(c),J(!1),c},o=async e=>{for(;!oe(e);)await c(e);setTimeout(()=>{r()},2e3)},c=async e=>{const t=Z(e);for(l(t);!re(t);)await s(e,t),te(t);const n=d(t);Y(e,n),ne(e)},s=async(e,a)=>{const r=ae(a);if(!Be(r))return void a.nextTurnOrder.push(r);if(r.cS.def!==r.bS.def&&He(r),0===r.cS.spd)return void(r.cS.spd=r.bS.spd);const{x:o,y:c}=r.actor,s=n(e,r)?o+20:o-20;return C(r.actor,s,c),new Promise(o=>{V(o);const c=e.actionMenuStack[0];n(e,r)?(c.disabledItems=r.cS.iCnt<=0?[2,4]:[],c.i=-1,xe(c,1,!0),J(!0)):setTimeout(()=>{const n=(r=e.allies)[t(r.length)];var r;i($,a,n)},1e3)})},i=async(e,t,r)=>{J(!1);const o=K(),c=ae(t);switch(Ae(c),v(c.actor,x),o.text=ce(e),await a(1e3),Le(c,e),e){case $:const t=u(c,r);if(o.text="Did "+-t+" damage.",v(r.actor,y),Qe("actionStrike"),await a(800),v(r.actor,k),!Be(r)){const e=n(o,r)?w:b;M(r.actor,e)}break;case F:h(c),Qe("actionCharge");break;case O:g(c),Qe("actionDefend");break;case P:m(c);break;case T:f(c,r);default:console.error("No action:",e,"exists.")}t.nextTurnOrder.push(c),await a(2e3),De(c),v(c.actor,k),o.text="",await a(500),X()()},l=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},d=e=>ee(e.nextTurnOrder),u=(e,t)=>{const{cS:n,bS:a}=t,{def:r}=n,{dmg:o}=e.bS,c=-Math.floor(Math.max(o-r,1));return Ee(n,a,c),c},h=e=>{const{cS:t}=e;t.cCnt++},f=(e,n)=>{75+(e.bS.mag-n.bS.mag>0?e.bS.mag-n.bS.mag:0)>t(100)?(n.cS.spd=0,n.cS.cCnt=0,U("Interrupted!")):U("Interrupt failed...")},m=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},g=e=>{const{cS:t}=e;t.def*=1.5};var p,S;window.addEventListener("keydown",e=>{if(we(e.key),"q"===e.key&&(window.running=!1),N()){const t=K(),n=e.key,a=t.actionMenuStack[0];"ArrowDown"===n?xe(a,1):"ArrowUp"===n?xe(a,-1):"Enter"===n?ye(a):"Escape"===n&&t.actionMenuStack.length>1&&Me(a)}}),window.addEventListener("keyup",e=>{be(e.key)}),p=(e=1,t=.05,n=220,a=0,r=0,o=.1,c=0,s=1,i=0,l=0,d=0,u=0,h=0,f=0,m=0,g=0,p=0,w=1,b=0,k=44100,x=99+a*k,y=r*k,M=o*k,C=b*k,I=p*k,v=2*Math.PI,$=(e=>0<e?1:-1),F=x+C+y+M+I,T=(i*=500*v/k**2),O=(n*=(1+2*t*Math.random()-t)*v/k),P=$(m)*v/4,_=0,E=0,A=0,D=0,B=0,H=0,L=1,R=[],U=S.createBufferSource(),j=S.createBuffer(1,F,k))=>{for(U.connect(S.destination);A<F;R[A++]=H)++B>100*g&&(B=0,H=_*n*Math.sin(E*m*v/k-P),H=$(H=c?1<c?2<c?3<c?Math.sin((H%v)**3):Math.max(Math.min(Math.tan(H),1),-1):1-(2*H/v%2+2)%2:1-4*Math.abs(Math.round(H/v)-H/v):Math.sin(H))*Math.abs(H)**s*e*.3*(A<x?A/x:A<x+C?1-(A-x)/C*(1-w):A<x+C+y?w:A<F-I?(F-A-I)/M*w:0),H=I?H/2+(I>A?0:(A<F-I?1:(A-F)/I)*R[A-I|0]/2):H),_+=1-f+1e9*(Math.sin(A)+1)%2*f,E+=1-f+1e9*(Math.sin(A)**2+1)%2*f,n+=i+=500*l*v/k**3,L&&++L>u*k&&(n+=d*v/k,O+=d*v/k,L=0),h&&++D>h*k&&(n=O,i=T,D=1,L=L||1);return j.getChannelData(0).set(R),U.buffer=j,U.start(),U},S=new AudioContext;const w=2,b=3,k=0,x=3,y=4,M=(e,t)=>{e.facing=t},C=(e,t,n)=>{e.x=t,e.y=n},I=e=>[e.x,e.y],v=(e,t)=>{e.anim=t},$=0,F=1,T=2,O=3,P=4,_=["Strike","Charge","Break","Defend","Heal","Use","Flee"],E=0,A=1,D=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,48*n+70]);return t},B=D(40),H=D(200),L=(e,t)=>{const n=pe();return{allies:e,enemies:t,rounds:[],roundIndex:0,actionMenuStack:[ke(n/2-50,n-20*_.length,100,_,z,[],!0,20)],text:""}},R=(e,t)=>t===E?B[e]:H[e],U=e=>{K().text=e},j=async e=>new Promise(t=>{const n=e.enemies,[a,r]=R(0,A),o=ke(2*a-Ve,2*r+Xe/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},e.enemies.filter(e=>!Be(e)).map((e,t)=>t),!1,96);o.i=-1,xe(o,1),e.actionMenuStack.unshift(o)}),z=async e=>{const t=K(),n=Z(t);switch(e){case $:let a=await j(t);if(!a)return;i($,n,a);break;case F:i(F,n,null);break;case O:i(O,n,null);break;case P:i(P,n,null);break;case T:const r=await j(t);if(!r)return;i(T,n,r);break;default:console.error("Action",e,"Is not implemented yet.")}};let q=null;const G=e=>{q=e},K=()=>q;let W=!1;const J=e=>{W=e},N=()=>W;let Q=()=>{};const V=e=>{Q=e},X=()=>Q,Y=(e,t)=>{e.rounds.push(t)},Z=e=>e.rounds[e.roundIndex],ee=e=>({turnOrder:e,nextTurnOrder:[],currentIndex:0}),te=e=>{e.currentIndex++},ne=e=>{e.roundIndex++},ae=e=>e.turnOrder[e.currentIndex]||null,re=e=>null===ae(e),oe=t=>e(t.enemies)||e(t.allies),ce=e=>_[e];let se=null,ie=1,le=0;const de=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},ue=()=>{if(se)return se;{const[e,t]=de(512,512);return e.id="canv",t.imageSmoothingEnabled=!1,document.body.appendChild(e),se=e,e}},he=()=>ue().getContext("2d"),fe=e=>{ie=e},me=e=>{le=e},ge=()=>le,pe=()=>512,Se={},we=e=>{Se[e]||(Se[e]=!0)},be=e=>{Se[e]=!1},ke=(e,t,n,a,r,o,c,s)=>({x:e,y:t,w:n,h:(s=s||16)*a.length,i:0,cb:r,disabledItems:o,items:a,lineHeight:s,bg:!!c}),xe=(e,t,n)=>{const a=e.items.length;let r=0,o=0,c=e.i;do{if(r++,r>30)break;o=c+t,o<0?o=a-1:o>=a&&(o=0),c=o}while(e.disabledItems.includes(o));e.i=o,n||Qe("menuMove")},ye=e=>{e.cb(e.i),Qe("menuConfirm")},Me=e=>{e.cb(-1),Qe("menuCancel")},Ce=(e,t,n,a,r)=>[e,t,n,a,r];let Ie=null;const ve=e=>{const[t,n,a,r]=de(e.width,e.height),o=a/2,c=r/2;return n.translate(o,c),n.rotate(Math.PI/2),n.drawImage(e,-o,-c),t},$e=e=>{const[t,n,a]=de(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},Fe=e=>{const[,,,t,n]=e,[a,r]=de(t,n);return qe(e,0,0,1,r),a},Te=(e,t,n,a,r)=>{const o=(t,n,a,r,o,c)=>e[t]=Ce(n,a,r,o,c),c=(e,t,n)=>{let c=e;for(let e=0;e<n;e++)c=ve(c);o(`${t}_r${n}`,c,0,0,a,r)},s=t.width/a,i=t.height/r;for(let e=0;e<i;e++)for(let i=0;i<s;i++){const l=`${n}_${e*s+i}`,d=o(l,t,i*a,e*r,a,r);c(Fe(d),l,1),c(Fe(d),l,2),c(Fe(d),l,3),o(l+"_f",$e(Fe(d)),0,0,a,r),o(l+"_fr1",ve($e(Fe(d))),0,0,a,r)}},Oe=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=Fe(Ce(t,0,0,64,64));Te(e,n,"actors",16,16);const a=Fe(Ce(t,64,0,64,64));Te(e,a,"terrain",16,16);const r=Fe(Ce(t,0,64,64,64));Te(e,r,"map",16,16),Ie=e},Pe=(e,t,n,a,r)=>({hp:e,dmg:t,def:n,mag:a,spd:r,iCnt:a,cCnt:0}),_e=(e,t,n,a,r,o,c,s,i)=>{M(i=i||{sprite:"actors",spriteIndex:0,facing:0,anim:k,isGround:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16},s?0:1);const l={name:e,bS:Pe(t,n,a,r,o),cS:Pe(t,n,a,r,o),actor:i,i:c,allegiance:s};return De(l),l},Ee=(e,t,n)=>{const{hp:a}=e,{hp:r}=t;let o=a+n;o>r?o=r:o<0&&(o=0),e.hp=o},Ae=e=>{const{allegiance:t}=e,[n,a]=R(e.i,t);C(e.actor,n+(t?-50:50),a)},De=e=>{const[t,n]=R(e.i,e.allegiance);C(e.actor,t,n)},Be=e=>e.cS.hp>0,He=e=>{e.cS.def=e.bS.def},Le=(e,t)=>{const{cS:n}=e;switch(t){case $:case F:n.spd+=2;break;case T:n.spd+=0;break;case O:n.spd+=3;break;case P:n.spd-=1;break;case 5:n.spd-=2;break;case 6:n.spd-=3}},Re={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},Ue={},je=(e,t,n,a,r,o,c)=>{(c=c||he()).lineWidth=1,c[o?"strokeStyle":"fillStyle"]=r,c[o?"strokeRect":"fillRect"](e,t,n,a)},ze=(e,t,n,a,r)=>{const{font:o,size:c,color:s,align:i,strokeColor:l}=Object.assign(Object.assign({},Re),a||{});(r=r||he()).font=`${c}px ${o}`,r.fillStyle=s,r.textAlign=i,r.textBaseline="middle",r.fillText(e,t,n),l&&(r.strokeStyle=l,r.lineWidth=.5,r.strokeText(e,t,n))},qe=(e,t,n,a,r)=>{a=a||1,r=r||he();const[o,c,s,i,l]="string"==typeof e?Ie[e]:e;r.drawImage(o,c,s,i,l,t,n,i*a,l*a)},Ge=(e,t)=>{t=t||1;const{x:n,y:a}=e,r=n*t,o=a*t,c=(e=>{let{facing:t,sprite:n,spriteIndex:a,anim:r}=e;1===r?r-=Math.floor(ge()%200/100):r===x?r=2-Math.floor(ge()%500/250):r===y&&(r=2);let o="";switch(t){case 0:o="_f";break;case 2:o="_r3";break;case 3:o="_fr1"}return n+"_"+(a+r+o)})(e);qe(c,r,o,t)},Ke=e=>{(()=>{const e=ue();((e,t,n,a,r,o)=>{const c=he(),s=`0,0,${n},${a},#557,#aaf`;if(!Ue[s]){const e=c.createLinearGradient(0,a,0,0);e.addColorStop(0,"#557"),e.addColorStop(1,"#aaf"),Ue[s]=e}c.fillStyle=Ue[s],c.fillRect(0,0,n,a)})(0,0,e.width,e.height)})(),ze("Round: "+(e.roundIndex+1),10,40);const t=ae(Z(e));ze("Turn: "+(null==t?void 0:t.name),10,60);const{allies:n,enemies:a,actionMenuStack:r}=e,o=r[0];for(let e=0;e<n.length;e++){const[t,a]=I(n[e].actor);C(n[e].actor,t,a),Ge(n[e].actor,2),ze(""+n[e].name,2*t+16,2*a-5,{align:"center"})}tt(e,E),tt(e,A);for(let e=0;e<a.length;e++){const[t,n]=I(a[e].actor);Ge(a[e].actor,2),ze(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}N()&&Ze(o),e.text&&et(e.text),nt(e)};let We=null;const Je=(e,t,n)=>{e[t]=n},Ne=()=>{const e={};Je(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),Je(e,"menuConfirm",[,,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),Je(e,"menuCancel",[,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),Je(e,"jump",[,,223,.01,.1,.22,1,1.35,.1,,,,,.4,,,,.55,.09]),Je(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),Je(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),Je(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),Je(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),Je(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),Je(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),We=e},Qe=e=>{p(...We[e])},Ve=16,Xe=16,Ye=(e,t,n,a,r)=>{je(e,t,n,a,r=r||"#000"),je(e,t,n,a,"#FFF",!0)},Ze=e=>{const{x:t,y:n,w:a,h:r,i:o,bg:c,items:s,lineHeight:i}=e;c&&Ye(t,n,a,r),s.forEach((r,o)=>{let c="#FFF";e.disabledItems.includes(o)&&(c="#999"),ze(r,t+a/2,n+o*i+i/2,{align:"center",color:c})}),((e,t)=>{const n=he(),a=Xe,r=Ve;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(r,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+i*o)},et=e=>{const t=pe();Ye(0,0,t,30),ze(e,pe()/2,16,{align:"center"})},tt=(e,t)=>{const n=pe(),a=t===A?n-200:0,r=n-90;Ye(a,r,200,90),((e,t)=>{const n=t-25;Ye(0,n,200,25),ze("Unit",10,n+12.5),ze("HP",80,n+12.5),ze("Chg",140,n+12.5),ze("Int",170,n+12.5)})(0,r);const o=t===A?e.enemies:e.allies;for(let e=0;e<o.length;e++){const n=o[e],{name:c,bS:s,cS:i}=n;t===E?(ze(c.slice(0,8),a+10,r+15+20*e),ze(`${i.hp}/${s.hp}`,a+80,r+15+20*e),ze(""+i.cCnt,a+145,r+15+20*e),ze(""+i.iCnt,a+175,r+15+20*e)):ze(c.slice(0,8),a+100,r+15+20*e,{align:"center"})}},nt=e=>{const{turnOrder:t}=Z(e),a=t.length;let r=pe()/2-a/2*30-5;for(let o=0;o<a;o++,r+=35){const{name:a,actor:c}=t[o],{sprite:s,spriteIndex:i}=c,l=Z(e).currentIndex===o?50:40;Ye(r,l,30,40);const d=n(e,t[o])?l:l+40;ze(a.slice(0,5),r+15,d,{size:"10",align:"center",strokeColor:"#FFF"}),qe(`${s}_${i}`,r,l,2)}}})();