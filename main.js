(()=>{window.running=!0,window.addEventListener("load",async()=>{await Tn(),oa(),O(),(()=>{const e=Hn();Yn(e),window.world=e;const t=e.party,n=qe(lt,"Jeremiah"),a=qe(pt,"Kana");pn(t,n),pn(t,a),hn(t,Object.assign({},st));const s=performance.now();let r=s;const o=n=>{const a=(n-r)/18;Ue(a>2?2:a),Re(n-s),r=n,Vn();const i=be();if(i)aa(i);else{const n=zn(e),a=ln(t).actor;_(e),na(n,0,0,2),ta(a,e.pause,2)}window.running&&requestAnimationFrame(o)};o(s)})()});const e=e=>Math.abs(e)/e,t=(e,t,n,a)=>[e,t,e+n,t+a],n=(e,t)=>[e,t],a=(e,t)=>e.map((e,n)=>((e,t)=>{const[n,a]=e,[s,r,o,i]=t;return n>s&&n<o&&a>r&&a<i})(e,t)?n:-1).filter(e=>e>-1),s=e=>{const[t,a,s,r]=e,o=s-t,i=t+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(t+o/4,c),n(s-o/4,c)]},r=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),o=e=>Math.floor(Math.random()*Math.floor(e)),i=(e,t)=>e.allies.includes(t),c=async e=>new Promise(t=>{setTimeout(t,e)}),l=(e,t)=>Math.floor(Xe()%((e+1)*t)/t),p=async e=>{const t=Te(e);for(u(t);!Pe(t);)await h(e,t),Ae(t);const n=y(t);Me(e,n),_e(e)},h=async(e,t)=>{const n=$e(t);if(Fn(n)&&!Fe(e)){if(n.cS.def!==n.bS.def&&Ln(n),0!==n.cS.spd)return _n(n),new Promise(a=>{ve(a);const s=e.actionMenuStack[0];i(e,n)?(n.cS.iCnt<=0?s.disabledItems.push(2,4):s.disabledItems=s.disabledItems.filter(e=>2!==e&&4!==e),s.i=-1,rn(s,1,!0),Ie(!0)):setTimeout(()=>{((e,t,n)=>{const a=(s=e.allies)[o(s.length)];var s;const{roundIndex:r,aiSeed:i}=e;switch(n.ai){case et:n.cS.cCnt<n.cS.iCnt?d(ae,t,null):d(ne,t,a);break;case tt:d(ne,t,a);break;case nt:d(r%(i+2)==0?se:ne,t,a)}})(e,t,n)},1e3)});n.cS.spd=n.bS.spd}},d=async(e,t,n,a)=>{Ie(!1);const s=be(),r=$e(t);switch($n(r),Q(r.actor,R),s.text=Oe(e),await c(1e3),Bn(r,e),e){case ne:const t=f(r,n);if(s.text="Did "+-t+" damage.",ia("actionStrike"),Q(n.actor,X),await c(800),Q(n.actor,j),!Fn(n)){const e=i(s,n)?H:Y;W(n.actor,e)}break;case ae:g(r),ia("actionCharge");break;case re:S(r),ia("actionDefend");break;case oe:b(r);break;case se:w(r,n);break;case ce:I();break;case ie:a&&a.onUse&&a.onUse(a);break;default:console.error("No action:",e,"exists.")}await c(1250),Pn(r),Q(r.actor,j),s.text="",await c(500),Ce()(),m(t)&&On(r)},m=e=>{const{turnOrder:t}=e;let n=!1;for(let e=0;e<t.length;e++)Fn(t[e])||(t.splice(e,1),n=!0);return n},u=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},y=e=>Ee(e.turnOrder),f=(e,t)=>{const{cS:n,bS:a}=t,{def:s}=n,{dmg:r}=e.bS,{cCnt:o}=e.cS,i=-Math.floor(Math.max((o>0?r*(o+1):r)-s,1));return e.cS.cCnt=0,An(n,a,i),i},g=e=>{const{cS:t}=e;t.cCnt++},w=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},b=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},S=e=>{const{cS:t}=e;t.def*=1.5},I=()=>{be().completionState=te};window.addEventListener("keydown",e=>{Je()||en(e.key)}),window.addEventListener("keyup",e=>{nn(e.key)});const x=async(e,t)=>(t||ia("cutscene"),new Promise(t=>{ga(e,t)})),k=async(e,t)=>{ia(t||"menuConfirm"),x("",!0);const n=jn();n.pause=!0,await c(250);for(let t=0;t<e.length;t++){const n=e[t].trim();n&&await x(n)}ia("menuCancel"),n.pause=!1},v=async e=>{const t=(e=>[`This sign says: "${e}"`])(e);await k(t),fa()},C=e=>{const t=jn(),n=ln(t.party),a=e.actor;W(a,n.actor.x<a.x?D:G)},M=async(e,t,n)=>{let a=[""];const s=jn().party,r=mn(s,t),o=t.name+"_fixed";Nn(o)?a=["You have fixed this statue."]:r?(await k(`\nYou place the '${r.name}' inside the statue.\n...\nSomething awakens inside it.\n`.split("\n")),dn(s,r),await c(150),ia("item"),e.actor.spriteIndex=12,await c(2e3),a=["You have fixed the statue!"],Xn(o,!0)):a=`\nThere's a plaque beneath this statue.\nIt says, "${n}"\nThis statue appears to be missing a something...\n`.split("\n"),await k(a),fa()},T=async(e,t,n)=>{const a=jn();a.pause=!0;const s=a.party,r=ln(a.party),[o,i]=K(r.actor),c=me(s,t);await(async e=>new Promise(async t=>{for(we(e),Ie(!1);!Fe(e);)await p(e);we(null),t()}))(c);const l=zn(a);if(wn(l,e),q(r.actor,o,i),V(r.actor,0,0),c.completionState===ee&&n)for(let e in n)await E(n[e]);a.pause=!1},E=async(e,t)=>{const n=jn(),{name:a,dsc:s}=e,r=["You acquired: "+a,s];n.pause=!0,await k(r,"item"),fa();const o=zn(n);t&&wn(o,t),hn(n.party,e)},A=(e,t)=>{const n=e[t];n<0?e[t]+=1.2:n>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},_=e=>{if(e.pause)return;const t=zn(e),{characters:n}=t;n.forEach(e=>{P(e.actor,t)}),$(e.party,t,e)},$=(e,t,n)=>{const r=ln(e).actor,{ax:o,ay:i,isGround:c}=r;Q(r,j),Ze(null);let l=o,p=i;const h=c?1.2:.04;an(Jt)&&(l=-h,W(r,D),Q(r,U)),an(Vt)&&(l=h,W(r,G),Q(r,U)),an(Zt)&&r.isGround&&(ia("jump"),p=-5.6,r.vy=0,r.isGround=!1),an(Qt)&&(r.disablePlatformCollision=!0),r.isGround||Q(r,z),J(r,l,p);const[d,m]=P(r,t);(d||m)&&Un(d,m,n);const u=s(Z(r));for(let e in t.characters){const n=t.characters[e],s=n.actor;We("",n);const r=Z(s);let o=!1;a(u,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&We(i,n),Ze(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},P=(n,r)=>{if(n.plAi===N){const{ax:e}=n;let t=e;Q(n,j),n.facing===D?(Q(n,U),t=-.5):(Q(n,U),t=.5),J(n,t,0)}(e=>{const t=ze();e.ay+=e.isGround?1e-4*t:.185})(n);let o=0,i=0;const c=ze();let{x:l,y:p,vx:h,vy:d,ax:m,ay:u,w:y,h:f}=n,g=h+m*c,w=d+u*c;Math.abs(g)>1.2&&(g=1.2*e(g)),Math.abs(w)>3.6&&(w=3.6*e(w)),V(n,g,w);let b=l+h*c,S=p+d*c;const[I,x]=gn(r);return b<0?(b=0,o=-1):b+y>I&&(b=I-y,o=1),S<0?(S=0,i=-1):S+f>x&&(S=x-f,i=1),q(n,b,S),((e,n)=>{let r,o,i=!1,c=0;const l=bn(n);do{c++,r=!1,o=!1;const n=s(t(e.x,e.y,e.w,e.h)),p={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=t(s.px,s.py,s.size,s.size);Sn(s)?a(n,i).forEach(e=>{r=!0,p[e]=s}):(e.y+e.h/2<s.py||e.plAi===N)&&a(n,i).forEach(t=>{0!==t||e.disablePlatformCollision||(o=!0,r=!0,p[t]=s),2===t&&e.plAi===N&&(r=!0,p[t]=s),3===t&&e.plAi===N&&(r=!0,p[t]=s)})});const h=p[1],d=p[2],m=p[3],u=1;p[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),i=!0):h&&(o||(e.y+=u,e.vy=0)),d?(e.x+=u,e.plAi===N&&W(e,G)):m&&(e.x-=u,e.plAi===N&&W(e,D))}while(r&&c<10);i===e.isGround||i||(e.vy=0),e.isGround=i})(n,r),0===m&&A(n,"vx"),0===u&&A(n,"vy"),J(n,0,0),[o,i]},F={},O=()=>{F["1,1,13,15"]=It,F["1,1,11,11"]=kt,F["1,1,4,9"]=xt,F["1,1,5,13"]=vt,F["0,1,9,15"]=Ct,F["0,1,7,11"]=Pt,F["0,1,9,11"]=Pt,F["0,1,11,11"]=Pt,F["0,1,13,11"]=Pt,F["0,1,8,7"]=Pt,F["0,1,10,7"]=Pt,F["0,1,12,7"]=Pt,F["0,1,14,7"]=Ot,F["0,1,7,3"]=Pt,F["0,1,9,3"]=Pt,F["0,1,11,3"]=Pt,F["0,1,13,3"]=Ft,F["2,2,2,15"]=Lt,F["2,2,2,12"]=zt,F["2,2,1,12"]=zt,F["2,1,5,15"]=zt,F["2,1,3,15"]=zt,F["2,1,4,15"]=zt,F["2,1,3,13"]=zt,F["2,1,9,9"]=zt,F["2,1,1,15"]=Mt,F["2,1,8,5"]=zt,F["2,1,10,15"]=zt,F["2,0,2,2"]=Tt,F["3,0,2,3"]=Et,F["3,0,4,10"]=zt,F["3,0,11,14"]=zt,F["3,1,2,7"]=zt,F["3,0,1,14"]=zt,F["3,0,14,7"]=zt,F["3,1,12,7"]=zt,F["3,1,3,14"]=zt,F["3,2,1,5"]=zt,F["3,1,14,10"]=zt,F["3,1,9,12"]=zt,F["3,1,6,12"]=zt,F["3,2,2,8"]=zt,F["3,2,11,6"]=zt,F["3,2,11,12"]=zt,F["3,0,7,3"]=zt,F["3,2,14,12"]=zt,F["3,3,3,15"]=zt,F["3,3,14,7"]=zt,F["3,0,7,9"]=zt,F["3,1,4,5"]=zt,F["3,2,4,7"]=zt,F["3,2,7,7"]=zt,F["3,2,5,7"]=zt,F["3,2,5,13"]=zt,F["3,3,8,5"]=zt,F["3,3,7,5"]=zt,F["3,1,7,12"]=zt,F["3,1,6,4"]=zt,F["3,3,8,15"]=At,F["3,3,1,3"]=Nt,F["0,3,3,15"]=zt,F["0,3,3,11"]=zt,F["0,3,8,4"]=zt,F["0,3,5,3"]=zt,F["0,3,11,10"]=zt,F["0,3,12,6"]=zt,F["0,3,14,12"]=zt,F["0,3,7,15"]=zt,F["0,3,1,6"]=zt,F["0,0,11,5"]=zt,F["0,0,12,15"]=zt,F["0,0,7,5"]=zt,F["0,0,6,15"]=zt,F["0,0,3,5"]=zt,F["0,0,3,15"]=zt,F["0,0,9,15"]=zt,F["0,0,4,9"]=zt,F["0,0,6,9"]=zt,F["0,0,8,9"]=zt,F["0,0,10,9"]=zt,F["0,0,12,9"]=zt,F["1,0,9,14"]=qt,F["1,0,2,15"]=_t,F["1,0,9,8"]=Nt,F["2,0,3,9"]=Rt,F["2,0,4,9"]=Rt,F["2,0,5,9"]=Rt,F["2,0,6,8"]=Rt,F["2,0,2,8"]=Rt,F["2,0,8,9"]=Nt,F["0,2,4,15"]=Nt,F["1,1,8,8"]=Wt,F["2,2,2,3"]=Xt,F["2,2,3,12"]=zt,F["2,2,11,3"]=Nt,F["2,3,9,15"]=zt,F["2,3,8,15"]=zt,F["2,3,7,15"]=zt,F["2,3,6,15"]=zt,F["2,3,5,15"]=zt,F["2,3,4,15"]=zt,F["2,3,3,15"]=zt,F["2,3,2,15"]=zt,F["2,3,10,15"]=zt,F["2,3,11,15"]=zt,F["2,3,12,15"]=zt,F["2,3,13,15"]=zt,F["2,3,1,15"]=zt,F["1,3,10,10"]=$t,F["2,3,15,12"]=Rt,F["3,3,0,12"]=Rt,F["2,2,11,7"]=Dt,F["2,2,5,4"]=Gt,F["1,3,2,15"]=Ht,F["1,3,7,15"]=Yt,F["1,3,9,15"]=jt,F["1,3,11,15"]=Ut,F["2,1,12,7"]=Bt,F["0,0,15,9"]=Rt,F["1,0,0,9"]=Rt};var L,B;L=(e=1,t=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,p=0,h=0,d=0,m=0,u=0,y=0,f=0,g=1,w=0,b=44100,S=99+a*b,I=s*b,x=r*b,k=w*b,v=f*b,C=2*Math.PI,M=(e=>0<e?1:-1),T=S+k+I+x+v,E=(c*=500*C/b**2),A=(n*=(1+2*t*Math.random()-t)*C/b),_=M(u)*C/4,$=0,P=0,F=0,O=0,L=0,D=0,G=1,H=[],Y=B.createBufferSource(),j=B.createBuffer(1,T,b))=>{for(Y.connect(B.destination);F<T;H[F++]=D)++L>100*y&&(L=0,D=$*n*Math.sin(P*u*C/b-_),D=M(D=o?1<o?2<o?3<o?Math.sin((D%C)**3):Math.max(Math.min(Math.tan(D),1),-1):1-(2*D/C%2+2)%2:1-4*Math.abs(Math.round(D/C)-D/C):Math.sin(D))*Math.abs(D)**i*e*.3*(F<S?F/S:F<S+k?1-(F-S)/k*(1-g):F<S+k+I?g:F<T-v?(T-F-v)/x*g:0),D=v?D/2+(v>F?0:(F<T-v?1:(F-T)/v)*H[F-v|0]/2):D),$+=1-m+1e9*(Math.sin(F)+1)%2*m,P+=1-m+1e9*(Math.sin(F)**2+1)%2*m,n+=c+=500*l*C/b**3,G&&++G>h*b&&(n+=p*C/b,A+=p*C/b,G=0),d&&++O>d*b&&(n=A,c=E,O=1,G=G||1);return j.getChannelData(0).set(H),Y.buffer=j,Y.start(),Y},B=new AudioContext;const D=0,G=1,H=2,Y=3,j=0,U=1,z=2,R=3,X=4,N=1,W=(e,t)=>{e.facing=t},q=(e,t,n)=>{e.x=t,e.y=n},K=e=>[e.x,e.y],V=(e,t,n)=>{e.vx=t,e.vy=n},J=(e,t,n)=>{e.ax=t,e.ay=n},Q=(e,t)=>{e.anim=t},Z=e=>t(e.x,e.y,e.w,e.h),ee=0,te=2,ne=0,ae=1,se=2,re=3,oe=4,ie=5,ce=6,le=["Strike","Charge","Break","Defend","Heal","Item","Flee"],pe=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,28*n+80]);return t},he=pe(40),de=pe(200),me=(e,t,n)=>{n=n||0;const a=Ne(),s=[sn(a/2-50,a-20*le.length,100,le,fe,e.inv.filter(e=>!!e.onUse).length?[]:[ie],!0,20)],r=(e=>{const t=[];for(let n=0;n<e.length;n++){const{unit:a,name:s}=e[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,Pn(a),W(a.actor,G),t.push(a)}return t})(e.characters),i=(e=>{const t=[];for(let n=0;n<e.length;n++){const a=qe(e[n]).unit;a.i=n,a.allegiance=1,W(a.actor,D),Pn(a),t.push(a)}return t})(t.enemies),c={party:e,allies:r,enemies:i,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:o(3)+1,completionState:3};Le(c,n);const l=Ee(r.concat(i));return Me(c,l),c},ue=(e,t)=>0===t?he[e]:de[e],ye=async e=>new Promise(t=>{const n=e.enemies,[a,s]=ue(0,1),r=e.enemies.map((e,t)=>t).filter(t=>!Fn(e.enemies[t])),o=sn(2*a-ca,2*s+la/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},r,!1,56);o.i=-1,rn(o,1),e.actionMenuStack.unshift(o)}),fe=async e=>{const t=be(),n=Te(t);switch(e){case ne:{let e=await ye(t);e&&d(ne,n,e);break}case ae:d(ae,n,null);break;case re:d(re,n,null);break;case oe:d(oe,n,null);break;case ce:d(ce,n,null);break;case ie:{const e=await(async e=>new Promise(t=>{const n={},a=e.party;let s=0;const r=a.inv.filter((e,t)=>(n[s]=t,s++,!!e.onUse)).map(e=>e.name),o=Ne(),i=sn(o/2-50,o-o/2,100,r,e=>{t(a.inv[n[e]])},[],!0,20);i.i=-1,rn(i,1),e.actionMenuStack.unshift(i)}))(t);e&&d(ie,n,null,e),t.actionMenuStack.shift();break}case se:{const e=await ye(t);e||d(se,n,e);break}default:console.error("Action",e,"Is not implemented yet.")}};let ge=null;const we=e=>{ge=e},be=()=>ge;let Se=!1;const Ie=e=>{Se=e},xe=()=>Se;let ke=()=>{};const ve=e=>{ke=e},Ce=()=>ke,Me=(e,t)=>{e.rounds.push(t)},Te=e=>e.rounds[e.roundIndex],Ee=e=>({turnOrder:e,currentIndex:0}),Ae=e=>{e.currentIndex++},_e=e=>{e.roundIndex++},$e=e=>e.turnOrder[e.currentIndex]||null,Pe=e=>null===$e(e),Fe=e=>r(e.enemies)||r(e.allies)||3!==e.completionState,Oe=e=>le[e],Le=(e,t)=>{if(0===t)return;const n=1===t?e.allies:e.enemies;for(let e=0;e<n.length;e++)n[e].cS.spd+=5};let Be=null,De=1,Ge=0;const He=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},Ye=()=>{var e;if(Be)return Be;{const[t,n]=He(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Be=t,t}},je=()=>Ye().getContext("2d"),Ue=e=>{De=e},ze=()=>De,Re=e=>{Ge=e},Xe=()=>Ge,Ne=()=>512,We=(e,t)=>{t.aText=e},qe=(e,t)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,plAi:c,name:l}=e,p={sprite:"actors",spriteIndex:n,facing:D,anim:j,isGround:!1,disablePlatformCollision:!1,plAi:0,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return p.plAi=c||0,a&&(p.sprite=a),{name:t||l,actor:p,label:r||"",action:o,col:i,aText:"",unit:s?En(l,p,e,0,0):void 0}};let Ke=!1,Ve=null;const Je=()=>Ke,Qe=e=>{Ke=e},Ze=e=>Ve=e,et=1,tt=2,nt=3,at=(e,t,n,a,s)=>({hp:e,dmg:t,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),st={name:"Bomb",dsc:"It destroys all enemies!",onUse:async e=>{const t=be();dn(t.party,e),t.completionState=ee,ia("actionStrike")}},rt={name:"Statue's Legs",dsc:"Good for running."},ot={name:"Statue's Voice",dsc:"The sound a mouth makes.  Not the game show."},it={name:"Statue's MIND",dsc:"Arguably necessary to have."},ct={name:"",stats:{bS:at(90,25,16,5,20),ai:0},sprI:0},lt={name:"",stats:{bS:at(85,25,13,6,15),ai:0},sprI:0},pt=(at(80,19,18,4,6),{name:"",stats:{bS:at(75,23,12,7,10),ai:0},sprI:0}),ht={name:"Golem",stats:{bS:at(30,20,30,1,5),ai:tt},sprI:5},dt={name:"Fairy",stats:{bS:at(20,8,5,5,15),ai:tt},sprI:4},mt={name:"Ape",stats:{bS:at(20,30,5,1,15),ai:tt},sprI:6},ut={name:"Breaker",stats:{bS:at(40,30,14,1,14),ai:nt},sprI:7},yt={enemies:[dt,ht,dt]},ft={enemies:[mt,mt,dt]},gt={enemies:[mt,mt,ht,ht]},wt={enemies:[ut,ut,ut]},bt={enemies:[ut,mt,dt]},St={enemies:[dt]},It={name:"Old Man",sprI:15,action:async e=>{C(e);const t="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\n:)\nIt may be prudent for you to find what is not found and restore them.\n  ".split("\n");await k(t),fa()}},xt={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{M(e,rt,"The Runner.")}},kt={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{M(e,it,"The Thinker.")}},vt={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{M(e,ot,"The Speaker.")}},Ct={name:"Sign",spr:"terrain",sprI:5,action:()=>v("Probably nothing is in these pots.")},Mt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("SPIKES are dangerous.")},Tt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("This fall is pointless.")},Et={name:"Sign",spr:"terrain",sprI:5,action:()=>v("This fall is pointy.")},At={name:"Sign",spr:"terrain",sprI:5,action:()=>v("(There is a picture of an arrow pointing upwards followed by a `?`)")},_t={name:"Sign",spr:"terrain",sprI:5,action:()=>v("The SHRINE of LEGS.")},$t={name:"Sign",spr:"terrain",sprI:5,action:()=>v("Choose wisely")},Pt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(e),fa()}},Ft={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const e="\nThere's something strange about this pot...\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(e),fa()}},Ot={name:"Pot",spr:"terrain",sprI:4,action:async e=>{const t="\nYou check the pot...\n  ".split("\n");await k(t),await E(ot,e),await k(["How did that get in there?"]),fa()}},Lt={name:"Pate",sprI:3,action:async e=>{C(e);let t=[""];t=Wn("talked_to_pate")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\nNo? Come back when you have!\n      ".split("\n"),await k(t),fa()}},Bt={name:"",sprI:8,col:async e=>{await T(e,St,[st])},plAi:N},Dt={name:"",sprI:8,col:async e=>{await T(e,gt,[st])},plAi:N},Gt={name:"",sprI:8,col:async e=>{await T(e,yt,[st])},plAi:N},Ht={name:"",sprI:8,col:async e=>{await T(e,ft,[st])},plAi:N},Yt={name:"",sprI:8,col:async e=>{await T(e,wt,[st])},plAi:N},jt={name:"",sprI:8,col:async e=>{await T(e,bt,[st])},plAi:N},Ut={name:"",sprI:8,col:async e=>{await T(e,ft,[st])},plAi:N},zt={name:"",spr:"terrain",sprI:6,col:async()=>{const e=jn();e.pause=!0,ia("spikes"),await c(1e3),e.pause=!1,Rn(jn())}},Rt={name:"",spr:"terrain",sprI:1},Xt={name:"A gleaming item...",spr:"terrain",sprI:11,action:async()=>{const e="\nA gleaming marble radiating shifting hues...\n    ".split("\n");await k(e),fa()}},Nt={name:"Item",spr:"terrain",sprI:11,action:e=>E(st,e)},Wt={name:"Orange",sprI:0,stats:{bS:at(75,23,12,7,10),ai:tt},action:async e=>{C(e);const t="\nI am the strongest man!\nFight me and I will join you!\n    ".split("\n"),n="\n    Onward, then!\n    ".split("\n");await k(t),fa();const a={enemies:[Wt]};await T(e,a);const s=jn();pn(s.party,e),await k(n),fa()}},qt={name:"Item",spr:"terrain",sprI:11,action:e=>E(rt,e)},Kt={},Vt="ArrowRight",Jt="ArrowLeft",Qt="ArrowDown",Zt=" ",en=e=>{if(1===e.length&&(e=e.toUpperCase()),!Kt[e]){if(Kt[e]=!0,"Q"===e&&(window.running=!1),Je())return;const t=be();if(xe()&&t){const n=t.actionMenuStack[0];e===Qt?rn(n,1):"ArrowUp"===e?rn(n,-1):"Enter"===e||"X"===e||e===Zt?on(n):"Escape"===e&&t.actionMenuStack.length>1&&cn(n)}else if("X"===e||"Enter"===e){const e=Ve;e&&e()}}};let tn=-1;const nn=e=>{if(1===e.length&&(e=e.toUpperCase()),e===Qt){const e=jn(),t=ln(e.party).actor;t.disablePlatformCollision&&(clearTimeout(tn),tn=setTimeout(()=>{t.disablePlatformCollision=!1},150))}Kt[e]=!1},an=e=>(1===e.length&&(e=e.toUpperCase()),Kt[e]),sn=(e,t,n,a,s,r,o,i)=>({x:e,y:t,w:n,h:(i=i||16)*a.length,i:0,cb:s,disabledItems:r,items:a,lineHeight:i,bg:!!o}),rn=(e,t,n)=>{const a=e.items.length;let s=0,r=0,o=e.i;do{if(s++,s>30)break;r=o+t,r<0?r=a-1:r>=a&&(r=0),o=r}while(e.disabledItems.includes(r));e.i=r,n||ia("menuMove")},on=e=>{e.cb(e.i),ia("menuConfirm")},cn=e=>{e.cb(-1),ia("menuCancel")},ln=e=>e.characters[0],pn=(e,t)=>{t.unit.ai=0,e.characters.push(t)},hn=(e,t)=>{const n=Object.assign({},t);e.inv.push(n),wa(e.inv,!0)},dn=(e,t)=>{const n=e.inv.indexOf(t);n>-1&&e.inv.splice(n,1),wa(e.inv,!0)},mn=(e,t)=>{for(let n in e.inv){const{name:a}=e.inv[n];if(a===t.name)return e.inv[n]}return null},un={0:[156,100,52],1:[171,82,54],2:[0,228,54],7:[255,241,232],15:[0,0,0]},yn={};for(let e in un)yn[un[e].join("")]=+e;const fn=(e,t,n,a)=>{const s=[],r=[],[,o]=He(16,16);ea(e,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let e=0;e<i.length;e+=4){let t=yn[`${i[e+0]}${i[e+1]}${i[e+2]}`]||0;const o=c%16,l=Math.floor(c/16);let p=null;const h=F[[n,a,o,l].join(",")];h&&(p=qe(h)),p&&(q(p.actor,16*o,16*l-16),r.push(p)),s.push({id:t,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:t}},gn=e=>[16*e.w,16*e.h],wn=(e,t)=>{const n=e.characters.indexOf(t);n>-1&&e.characters.splice(n,1)},bn=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),Sn=e=>[0,1,7].includes(e.id),In=(e,t,n,a,s)=>[e,t,n,a,s];let xn=null;const kn=e=>{const[t,n,a,s]=He(e.width,e.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(e,-r,-o),t},vn=e=>{const[t,n,a]=He(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},Cn=e=>{const[,,,t,n]=e,[a,s]=He(t,n);return ea(e,0,0,1,s),a},Mn=(e,t,n,a,s)=>{const r=(t,n,a,s,r,o)=>e[t]=In(n,a,s,r,o),o=(e,t,n)=>{let o=e;for(let e=0;e<n;e++)o=kn(o);r(`${t}_r${n}`,o,0,0,a,s)},i=t.width/a,c=t.height/s;for(let e=0;e<c;e++)for(let c=0;c<i;c++){const l=`${n}_${e*i+c}`,p=r(l,t,c*a,e*s,a,s);o(Cn(p),l,1),o(Cn(p),l,2),o(Cn(p),l,3),r(l+"_f",vn(Cn(p)),0,0,a,s),r(l+"_fr1",kn(vn(Cn(p))),0,0,a,s)}},Tn=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=Cn(In(t,0,0,64,64));Mn(e,n,"actors",16,16);const a=Cn(In(t,64,0,64,64));Mn(e,a,"terrain",16,16);const s=Cn(In(t,0,64,64,64));Mn(e,s,"map",16,16);const r=Cn(In(t,64,64,64,64));Mn(e,r,"monsters",16,16),xn=e},En=(e,t,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${e}' has no stats!`);const o={name:e,actor:t,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return W(o.actor,o.allegiance?D:G),Pn(o),o},An=(e,t,n)=>{const{hp:a}=e,{hp:s}=t;let r=a+n;r>s?r=s:r<0&&(r=0),e.hp=r},_n=e=>{const{allegiance:t}=e,[n,a]=ue(e.i,t);q(e.actor,n+(t?-20:20),a)},$n=e=>{const t=Ne()/2/2-8;q(e.actor,t,t)},Pn=e=>{const[t,n]=ue(e.i,e.allegiance);q(e.actor,t,n)},Fn=e=>e.cS.hp>0,On=e=>{e.cS.iCnt++},Ln=e=>{e.cS.def=e.bS.def},Bn=(e,t)=>{const{cS:n}=e;switch(t){case ne:n.spd+=0;break;case ae:n.spd-=2;break;case se:n.spd-=1;break;case re:n.spd+=3;break;case oe:n.spd-=1;break;case ie:case ce:n.spd-=2}};let Dn=null;const Gn={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},Hn=()=>{const e={characters:[qe(ct,"Runner")],inv:[],worldX:0,worldY:0},t=ln(e);q(t.actor,128,180);const n={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)n.rooms.push(fn("map_"+e,Gn[e],e%4,Math.floor(e/4)));return n},Yn=e=>{Dn=e},jn=()=>Dn,Un=(e,t,n)=>{((e,t,n)=>{n.roomI=4*t+e})((n.roomI%4+e+4)%4,(Math.floor(n.roomI/4)+t+4)%4,n);const a=zn(n),s=ln(n.party).actor,[r,o]=gn(a);let i=0,c=0;e>0&&(i=0,c=s.y),e<0&&(i=r-16,c=s.y),t>0&&(i=s.x,c=0),t<0&&(i=s.x,c=o-16),q(s,i,c),n.lastX=i,n.lastY=c},zn=e=>e.rooms[e.roomI],Rn=e=>{const t=ln(e.party);q(t.actor,e.lastX,e.lastY)},Xn=(e,t)=>{jn().state[e]=t},Nn=e=>jn().state[e],Wn=e=>void 0===Nn(e)&&(Xn(e,!0),!0),qn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},Kn={},Vn=()=>{const e=Ye();Zn(0,0,e.width,e.height,"#557","#aaf")},Jn=(e,t,n,a,s,r,o)=>{(o=o||je()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](e,t,n,a)},Qn=(e,t,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},qn),a||{});(s=s||je()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(e,t,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(e,t,n))},Zn=(e,t,n,a,s,r)=>{const o=je(),i=`${e},${t},${n},${a},${s},${r}`;if(!Kn[i]){const e=o.createLinearGradient(0,a,0,0);e.addColorStop(0,s),e.addColorStop(1,r),Kn[i]=e}o.fillStyle=Kn[i],o.fillRect(e,t,n,a)},ea=(e,t,n,a,s)=>{a=a||1,s=s||je();const[r,o,i,c,l]="string"==typeof e?xn[e]:e;s.drawImage(r,o,i,c,l,t,n,c*a,l*a)},ta=(e,t,n)=>{n=n||1;const{x:a,y:s}=e,r=a*n,o=s*n,[i,c,p]=((e,t)=>{let{facing:n,sprite:a,spriteIndex:s,anim:r}=e,o=r,i=s<3,c=0;t||(r===U?o-=l(1,100):r===R?i?o=2-l(1,250):(o=0,c=2*l(1,100)):r===X&&(o=i?2:0));let p="";switch(n){case 0:p="_f";break;case 2:p="_r3";break;case 3:p="_fr1"}return[a+"_"+(s+o+p),0,c]})(e,t);ea(i,r+c,o+p,n)},na=(e,t,n,a)=>{const s=jn(),r=a||1;e.tiles.forEach(s=>{const{id:o,x:i,y:c,size:l}=s,p=(t+i*l)*r,h=(n+c*l)*r;ea(e.bgSprite,p,h,a),15!=o&&ea("terrain_"+o,p,h,a)}),e.characters.forEach(e=>{const t=e.actor;ta(t,s.pause,a);const{x:n,y:o}=t,i=e.aText;i&&Qn(i,n*r+16*r/2,o*r-16*r/2,{size:16,align:"center"})})},aa=e=>{Vn();const t=$e(Te(e));pa(5,15,150,20),Qn("Turn: "+(null==t?void 0:t.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=e,r=s[0];for(let e=0;e<n.length;e++){const[t,a]=K(n[e].actor);q(n[e].actor,t,a),ta(n[e].actor,!1,2),Qn(""+n[e].name,2*t+16,2*a-5,{align:"center"})}ma(e,0),ma(e,1);for(let e=0;e<a.length;e++){const[t,n]=K(a[e].actor);ta(a[e].actor,!1,2),Qn(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}xe()&&ha(r),e.text&&da(e.text),ua(e)};let sa=null;const ra=(e,t,n)=>{e[t]=n},oa=()=>{const e={};ra(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),ra(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),ra(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),ra(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),ra(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),ra(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),ra(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),ra(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),ra(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),ra(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),ra(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),ra(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),ra(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),sa=e},ia=e=>{L(...sa[e])},ca=16,la=16,pa=(e,t,n,a,s)=>{Jn(e,t,n,a,s=s||"#000"),Jn(e,t,n,a,"#FFF",!0)},ha=e=>{const{x:t,y:n,w:a,h:s,i:r,bg:o,items:i,lineHeight:c}=e;o&&pa(t,n,a,s),i.forEach((s,r)=>{let o="#FFF";e.disabledItems.includes(r)&&(o="#999"),Qn(s,t+a/2,n+r*c+c/2,{align:"center",color:o})}),((e,t)=>{const n=je(),a=la,s=ca;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+c*r)},da=e=>{const t=Ne();pa(0,90,t,50),Qn(e,Ne()/2,116,{align:"center",size:20})},ma=(e,t)=>{const n=Ne(),a=1===t?n-200:0,s=n-90;pa(a,s,200,90),((e,t)=>{const n=t-25;pa(0,n,200,25),Qn("Unit",10,n+12.5),Qn("HP",80,n+12.5),Qn("Chg",140,n+12.5),Qn("Int",170,n+12.5)})(0,s);const r=1===t?e.enemies:e.allies;for(let e=0;e<r.length;e++){const n=r[e],{name:o,bS:i,cS:c}=n;0===t?(Qn(o.slice(0,8),a+10,s+15+20*e),Qn(`${c.hp}/${i.hp}`,a+80,s+15+20*e),Qn(""+c.cCnt,a+145,s+15+20*e),Qn(""+c.iCnt,a+175,s+15+20*e)):Qn(o.slice(0,8),a+100,s+15+20*e,{align:"center"})}},ua=e=>{const{turnOrder:t}=Te(e),n=t.length,a=35*n;let s=Ne()-Ne()/3-a/2;pa(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:r}=t[a],{sprite:o,spriteIndex:c}=r,l=10+(Te(e).currentIndex===a?20:10);pa(s,l,30,40,i(e,t[a])?"#29ADFF":"#FF004D");const p=i(e,t[a])?l-5:l+40+8;Qn(n.slice(0,5),s+15,p,{size:12,align:"center",strokeColor:"#FFF"}),ea(`${o}_${c}`,s,l+5,2)}};let ya=null,fa=()=>{const e=document.getElementById("dialogBox");window.removeEventListener("keypress",ya),e.style.opacity="0",e.style.width="0",Qe(!1)};const ga=(e,t)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",ya),n.innerHTML=`<div style="width:476px">${e}</div>`,n.style.opacity="1",n.style.width="512px",ya=e=>{const n=e.key.length>1?e.key:e.key.toUpperCase();n!==Zt&&"X"!==n&&"Enter"!==n||(window.removeEventListener("keypress",ya),t())},setTimeout(()=>{window.addEventListener("keypress",ya)},25),Qe(!0)},wa=(e,t)=>{const n=document.getElementById("itemBox");n.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){const a=document.createElement("span");a.innerHTML=e[t].name+(t<e.length-1?",":""),a.className="item",n.appendChild(a)}n.style.display=t?"flex":"none"}})();