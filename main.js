(()=>{window.running=!0,window.addEventListener("load",async()=>{await Ae(),Ze(),(()=>{const e=r();J(e),s(e);const t=performance.now();let n=t;const a=o=>{Ve(e);const r=(o-n)/16.666;ge(r>2?2:r),pe(o-t),n=o,window.running&&requestAnimationFrame(a)};a(t)})(),K()||it("Ho ho, friend. Look yonder. There's a tonne of treasure in that pit over there. I certainly won't kick you into the pit. Trust me. I'm Patches the Spider.")});const e=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),t=e=>Math.floor(Math.random()*Math.floor(e)),n=e=>e[t(e.length)],a=(e,t)=>e.allies.includes(t),o=async e=>new Promise(t=>{setTimeout(t,e)}),r=()=>{const e=He("Jimothy",100,10,5,5,5,0,A),t=He("Seph",100,10,5,5,4,1,A),n=He("Kana",100,8,3,2,7,2,A),a=He("Fairy1",20,10,10,10,1,0,D,I(4),1),o=He("Dogman1",200,10,5,1,10,1,D,I(5),2),r=R([e,t,n],[a,o]),s=ne([e,t,n,a,o]);return ee(r,s),J(r),Q(!1),r},s=async e=>{for(;!ce(e);)await c(e);setTimeout(()=>{r()},2e3)},c=async e=>{const t=te(e);for(d(t);!se(t);)await i(e,t),ae(t);const n=u(t);ee(e,n),oe(e)},i=async(e,t)=>{const o=re(t);if(!je(o))return void t.nextTurnOrder.push(o);if(o.cS.def!==o.bS.def&&Ue(o),0===o.cS.spd)return void(o.cS.spd=o.bS.spd);const{x:r,y:s}=o.actor,c=a(e,o)?r+20:r-20;return v(o.actor,c,s),new Promise(r=>{Y(r);const s=e.actionMenuStack[0];a(e,o)?(s.disabledItems=o.cS.iCnt<=0?[2,4]:[],s.i=-1,ve(s,1,!0),Q(!0)):setTimeout(()=>{((e,t,a)=>{switch(a.ai){case 1:if(a.cS.cCnt<a.cS.iCnt)l(E,t,null);else{const a=n(e.allies);l($,t,a)}break;case 2:const o=n(e.allies);l($,t,o)}})(e,t,o)},1e3)})},l=async(e,t,n)=>{Q(!1);const r=K(),s=re(t);switch(ze(s),s.allegiance===A&&F(s.actor,k),r.text=ie(e),await o(1e3),qe(s,e),e){case $:const t=h(s,n);if(r.text="Did "+-t+" damage.",et("actionStrike"),s.allegiance===D&&(F(n.actor,M),await o(800),F(n.actor,y)),!je(n)){const e=a(r,n)?x:b;C(n.actor,e)}break;case E:f(s),et("actionCharge");break;case P:p(s),et("actionDefend");break;case B:g(s);break;case O:m(s,n);default:console.error("No action:",e,"exists.")}t.nextTurnOrder.push(s),await o(2e3),Re(s),s.allegiance===A&&F(s.actor,y),r.text="",await o(500),Z()()},d=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},u=e=>ne(e.nextTurnOrder),h=(e,t)=>{const{cS:n,bS:a}=t,{def:o}=n,{dmg:r}=e.bS,s=-Math.floor(Math.max(r-o,1));return Le(n,a,s),s},f=e=>{const{cS:t}=e;t.cCnt++},m=(e,n)=>{75+(e.bS.mag-n.bS.mag>0?e.bS.mag-n.bS.mag:0)>t(100)?(n.cS.spd=0,n.cS.cCnt=0,U("Interrupted!")):U("Interrupt failed...")},g=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},p=e=>{const{cS:t}=e;t.def*=1.5};var S,w;window.addEventListener("keydown",e=>{if(be()||Me(e.key),"q"===e.key&&(window.running=!1)," "===e.key&&lt(),V()){const t=K(),n=e.key,a=t.actionMenuStack[0];"ArrowDown"===n?ve(a,1):"ArrowUp"===n?ve(a,-1):"Enter"===n?Te(a):"Escape"===n&&t.actionMenuStack.length>1&&Fe(a)}}),window.addEventListener("keyup",e=>{Ie(e.key)}),S=(e=1,t=.05,n=220,a=0,o=0,r=.1,s=0,c=1,i=0,l=0,d=0,u=0,h=0,f=0,m=0,g=0,p=0,S=1,x=0,b=44100,y=99+a*b,k=o*b,M=r*b,I=x*b,C=p*b,v=2*Math.PI,T=(e=>0<e?1:-1),F=y+I+k+M+C,$=(i*=500*v/b**2),E=(n*=(1+2*t*Math.random()-t)*v/b),O=T(m)*v/4,P=0,B=0,_=0,A=0,D=0,H=0,L=1,z=[],R=w.createBufferSource(),j=w.createBuffer(1,F,b))=>{for(R.connect(w.destination);_<F;z[_++]=H)++D>100*g&&(D=0,H=P*n*Math.sin(B*m*v/b-O),H=T(H=s?1<s?2<s?3<s?Math.sin((H%v)**3):Math.max(Math.min(Math.tan(H),1),-1):1-(2*H/v%2+2)%2:1-4*Math.abs(Math.round(H/v)-H/v):Math.sin(H))*Math.abs(H)**c*e*.3*(_<y?_/y:_<y+I?1-(_-y)/I*(1-S):_<y+I+k?S:_<F-C?(F-_-C)/M*S:0),H=C?H/2+(C>_?0:(_<F-C?1:(_-F)/C)*z[_-C|0]/2):H),P+=1-f+1e9*(Math.sin(_)+1)%2*f,B+=1-f+1e9*(Math.sin(_)**2+1)%2*f,n+=i+=500*l*v/b**3,L&&++L>u*b&&(n+=d*v/b,E+=d*v/b,L=0),h&&++A>h*b&&(n=E,i=$,A=1,L=L||1);return j.getChannelData(0).set(z),R.buffer=j,R.start(),R},w=new AudioContext;const x=2,b=3,y=0,k=3,M=4,I=e=>({sprite:"actors",spriteIndex:e,facing:0,anim:y,isGround:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16}),C=(e,t)=>{e.facing=t},v=(e,t,n)=>{e.x=t,e.y=n},T=e=>[e.x,e.y],F=(e,t)=>{e.anim=t},$=0,E=1,O=2,P=3,B=4,_=["Strike","Charge","Break","Defend","Heal","Use","Flee"],A=0,D=1,H=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,48*n+70]);return t},L=H(40),z=H(200),R=(e,t)=>{const n=we();return{allies:e,enemies:t,rounds:[],roundIndex:0,actionMenuStack:[Ce(n/2-50,n-20*_.length,100,_,G,[],!0,20)],text:""}},j=(e,t)=>t===A?L[e]:z[e],U=e=>{K().text=e},q=async e=>new Promise(t=>{const n=e.enemies,[a,o]=j(0,D),r=Ce(2*a-tt,2*o+nt/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},e.enemies.filter(e=>!je(e)).map((e,t)=>t),!1,96);r.i=-1,ve(r,1),e.actionMenuStack.unshift(r)}),G=async e=>{const t=K(),n=te(t);switch(e){case $:let a=await q(t);if(!a)return;l($,n,a);break;case E:l(E,n,null);break;case P:l(P,n,null);break;case B:l(B,n,null);break;case O:const o=await q(t);if(!o)return;l(O,n,o);break;default:console.error("Action",e,"Is not implemented yet.")}};let W=null;const J=e=>{W=e},K=()=>W;let N=!1;const Q=e=>{N=e},V=()=>N;let X=()=>{};const Y=e=>{X=e},Z=()=>X,ee=(e,t)=>{e.rounds.push(t)},te=e=>e.rounds[e.roundIndex],ne=e=>({turnOrder:e,nextTurnOrder:[],currentIndex:0}),ae=e=>{e.currentIndex++},oe=e=>{e.roundIndex++},re=e=>e.turnOrder[e.currentIndex]||null,se=e=>null===re(e),ce=t=>e(t.enemies)||e(t.allies),ie=e=>_[e];let le=null,de=1,ue=0;const he=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},fe=()=>{var e;if(le)return le;{const[t,n]=he(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),le=t,t}},me=()=>fe().getContext("2d"),ge=e=>{de=e},pe=e=>{ue=e},Se=()=>ue,we=()=>512;let xe=!1;const be=()=>xe,ye=()=>{xe=!xe},ke={},Me=e=>{ke[e]||(ke[e]=!0)},Ie=e=>{ke[e]=!1},Ce=(e,t,n,a,o,r,s,c)=>({x:e,y:t,w:n,h:(c=c||16)*a.length,i:0,cb:o,disabledItems:r,items:a,lineHeight:c,bg:!!s}),ve=(e,t,n)=>{const a=e.items.length;let o=0,r=0,s=e.i;do{if(o++,o>30)break;r=s+t,r<0?r=a-1:r>=a&&(r=0),s=r}while(e.disabledItems.includes(r));e.i=r,n||et("menuMove")},Te=e=>{e.cb(e.i),et("menuConfirm")},Fe=e=>{e.cb(-1),et("menuCancel")},$e=(e,t,n,a,o)=>[e,t,n,a,o];let Ee=null;const Oe=e=>{const[t,n,a,o]=he(e.width,e.height),r=a/2,s=o/2;return n.translate(r,s),n.rotate(Math.PI/2),n.drawImage(e,-r,-s),t},Pe=e=>{const[t,n,a]=he(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},Be=e=>{const[,,,t,n]=e,[a,o]=he(t,n);return Ne(e,0,0,1,o),a},_e=(e,t,n,a,o)=>{const r=(t,n,a,o,r,s)=>e[t]=$e(n,a,o,r,s),s=(e,t,n)=>{let s=e;for(let e=0;e<n;e++)s=Oe(s);r(`${t}_r${n}`,s,0,0,a,o)},c=t.width/a,i=t.height/o;for(let e=0;e<i;e++)for(let i=0;i<c;i++){const l=`${n}_${e*c+i}`,d=r(l,t,i*a,e*o,a,o);s(Be(d),l,1),s(Be(d),l,2),s(Be(d),l,3),r(l+"_f",Pe(Be(d)),0,0,a,o),r(l+"_fr1",Oe(Pe(Be(d))),0,0,a,o)}},Ae=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=Be($e(t,0,0,64,64));_e(e,n,"actors",16,16);const a=Be($e(t,64,0,64,64));_e(e,a,"terrain",16,16);const o=Be($e(t,0,64,64,64));_e(e,o,"map",16,16);const r=Be($e(t,64,64,64,64));_e(e,r,"monsters",16,16),Ee=e},De=(e,t,n,a,o)=>({hp:e,dmg:t,def:n,mag:a,spd:o,iCnt:a,cCnt:0}),He=(e,t,n,a,o,r,s,c,i,l)=>{i=i||I(0),l=l||0,C(i,c?0:1);const d={name:e,bS:De(t,n,a,o,r),cS:De(t,n,a,o,r),actor:i,i:s,allegiance:c,ai:l};return Re(d),d},Le=(e,t,n)=>{const{hp:a}=e,{hp:o}=t;let r=a+n;r>o?r=o:r<0&&(r=0),e.hp=r},ze=e=>{const{allegiance:t}=e,[n,a]=j(e.i,t);v(e.actor,n+(t?-50:50),a)},Re=e=>{const[t,n]=j(e.i,e.allegiance);v(e.actor,t,n)},je=e=>e.cS.hp>0,Ue=e=>{e.cS.def=e.bS.def},qe=(e,t)=>{const{cS:n}=e;switch(t){case $:case E:n.spd+=2;break;case O:n.spd+=0;break;case P:n.spd+=3;break;case B:n.spd-=1;break;case 5:n.spd-=2;break;case 6:n.spd-=3}},Ge={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},We={},Je=(e,t,n,a,o,r,s)=>{(s=s||me()).lineWidth=1,s[r?"strokeStyle":"fillStyle"]=o,s[r?"strokeRect":"fillRect"](e,t,n,a)},Ke=(e,t,n,a,o)=>{const{font:r,size:s,color:c,align:i,strokeColor:l}=Object.assign(Object.assign({},Ge),a||{});(o=o||me()).font=`${s}px ${r}`,o.fillStyle=c,o.textAlign=i,o.textBaseline="middle",o.fillText(e,t,n),l&&(o.strokeStyle=l,o.lineWidth=.5,o.strokeText(e,t,n))},Ne=(e,t,n,a,o)=>{a=a||1,o=o||me();const[r,s,c,i,l]="string"==typeof e?Ee[e]:e;o.drawImage(r,s,c,i,l,t,n,i*a,l*a)},Qe=(e,t)=>{t=t||1;const{x:n,y:a}=e,o=n*t,r=a*t,s=(e=>{let{facing:t,sprite:n,spriteIndex:a,anim:o}=e;1===o?o-=Math.floor(Se()%200/100):o===k?o=2-Math.floor(Se()%500/250):o===M&&(o=2);let r="";switch(t){case 0:r="_f";break;case 2:r="_r3";break;case 3:r="_fr1"}return n+"_"+(a+o+r)})(e);Ne(s,o,r,t)},Ve=e=>{(()=>{const e=fe();((e,t,n,a,o,r)=>{const s=me(),c=`0,0,${n},${a},#557,#aaf`;if(!We[c]){const e=s.createLinearGradient(0,a,0,0);e.addColorStop(0,"#557"),e.addColorStop(1,"#aaf"),We[c]=e}s.fillStyle=We[c],s.fillRect(0,0,n,a)})(0,0,e.width,e.height)})(),Ke("Round: "+(e.roundIndex+1),10,40);const t=re(te(e));Ke("Turn: "+(null==t?void 0:t.name),10,60);const{allies:n,enemies:a,actionMenuStack:o}=e,r=o[0];for(let e=0;e<n.length;e++){const[t,a]=T(n[e].actor);v(n[e].actor,t,a),Qe(n[e].actor,2),Ke(""+n[e].name,2*t+16,2*a-5,{align:"center"})}st(e,A),st(e,D);for(let e=0;e<a.length;e++){const[t,n]=T(a[e].actor);Qe(a[e].actor,2),Ke(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}V()&&ot(r),e.text&&rt(e.text),ct(e)};let Xe=null;const Ye=(e,t,n)=>{e[t]=n},Ze=()=>{const e={};Ye(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),Ye(e,"menuConfirm",[,,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),Ye(e,"menuCancel",[,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),Ye(e,"jump",[,,223,.01,.1,.22,1,1.35,.1,,,,,.4,,,,.55,.09]),Ye(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),Ye(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),Ye(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),Ye(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),Ye(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),Ye(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),Xe=e},et=e=>{S(...Xe[e])},tt=16,nt=16,at=(e,t,n,a,o)=>{Je(e,t,n,a,o=o||"#000"),Je(e,t,n,a,"#FFF",!0)},ot=e=>{const{x:t,y:n,w:a,h:o,i:r,bg:s,items:c,lineHeight:i}=e;s&&at(t,n,a,o),c.forEach((o,r)=>{let s="#FFF";e.disabledItems.includes(r)&&(s="#999"),Ke(o,t+a/2,n+r*i+i/2,{align:"center",color:s})}),((e,t)=>{const n=me(),a=nt,o=tt;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(o,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+i*r)},rt=e=>{const t=we();at(0,0,t,30),Ke(e,we()/2,16,{align:"center"})},st=(e,t)=>{const n=we(),a=t===D?n-200:0,o=n-90;at(a,o,200,90),((e,t)=>{const n=t-25;at(0,n,200,25),Ke("Unit",10,n+12.5),Ke("HP",80,n+12.5),Ke("Chg",140,n+12.5),Ke("Int",170,n+12.5)})(0,o);const r=t===D?e.enemies:e.allies;for(let e=0;e<r.length;e++){const n=r[e],{name:s,bS:c,cS:i}=n;t===A?(Ke(s.slice(0,8),a+10,o+15+20*e),Ke(`${i.hp}/${c.hp}`,a+80,o+15+20*e),Ke(""+i.cCnt,a+145,o+15+20*e),Ke(""+i.iCnt,a+175,o+15+20*e)):Ke(s.slice(0,8),a+100,o+15+20*e,{align:"center"})}},ct=e=>{const{turnOrder:t}=te(e),n=t.length;let o=we()/2-n/2*30-5;for(let r=0;r<n;r++,o+=35){const{name:n,actor:s}=t[r],{sprite:c,spriteIndex:i}=s,l=te(e).currentIndex===r?50:40;at(o,l,30,40);const d=a(e,t[r])?l:l+40;Ke(n.slice(0,5),o+15,d,{size:"10",align:"center",strokeColor:"#FFF"}),Ne(`${c}_${i}`,o,l,2)}},it=e=>{const t=document.getElementById("dialogBox"),n=we();t.innerHTML=e,t.style["font-size"]="24px",t.style.border="2px solid white",t.style.height="128px",t.style.width=n-54+"px",t.style.top=n-128+"px",ye()},lt=()=>{var e;null===(e=document.getElementById("dialogBox"))||void 0===e||e.setAttribute("style","display: none"),ye()}})();