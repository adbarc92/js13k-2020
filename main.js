(()=>{window.running=!0,window.addEventListener("load",async()=>{await La(),gn(),L(),(async()=>{let e=Va();Ja(e),window.world=e,cn(0,0,Ke(),Ke(),rn);let t="\n  Press X to continue...\n  ".split("\n");await C(t),_n();let a=e.party,n=performance.now(),r=n,i=t=>{let l=(t-r)/18;Ne(l>2?2:l),Ve(t-n),r=t,on();let s=ve();if(s)yn(s);else{let t=Za(e),n=ga(a).actor;O(e),hn(t,0,0,2),un(n,e.pause,2)}window.running&&requestAnimationFrame(i)};i(n)})()});let e=e=>Math.abs(e)/e,t=(e,t,a,n)=>[e,t,e+a,t+n],a=(e,t)=>[e,t],n=(e,t)=>e.map((e,a)=>((e,t)=>{let[a,n]=e,[r,i,l,s]=t;return a>r&&a<l&&n>i&&n<s})(e,t)?a:-1).filter(e=>e>-1),r=e=>{let[t,n,r,i]=e,l=r-t,s=t+l/2,o=n+(i-n)/2;return[a(s,i),a(s,n),a(t+l/4,o),a(r-l/4,o)]},i=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),l=(e,t)=>e.allies.includes(t),s=async e=>new Promise(t=>{setTimeout(t,e)}),o=(e,t)=>Math.floor(Je()%((e+1)*t)/t),c=e=>{let t=e[0];for(let a=0;a<e.length;a++)e[a].cS.hp<t.cS.hp&&(t=e[a]);return t},p=async e=>new Promise(async t=>{for(xe(e),Me(!1);!je(e);)await d(e);e.completionState===ie&&(e.completionState=i(e.allies)?ne:i(e.enemies)?ae:re),xe(null),t()}),d=async e=>{let t=Oe(e);for(y(t);!Ye(t);)await m(e,t),Fe(t);let a=f(t);$e(e,a),Ge(e)},m=async(e,t)=>{let a=Le(t);if(Da(a)&&!je(e)){if(a.cS.def!==a.bS.def&&Ra(a),0!==a.cS.spd)return Ha(a),new Promise(n=>{Ae(n);let r=e.actionMenuStack[0];l(e,a)?(a.cS.iCnt<=0?r.disabledItems.push(2,4):r.disabledItems=r.disabledItems.filter(e=>2!==e&&4!==e),r.i=-1,ya(r,1,!0),Me(!0)):setTimeout(()=>{((e,t,a)=>{let n=c(e.allies),{roundIndex:r,aiSeed:i}=e;switch(a.ai){case it:a.cS.cCnt<a.cS.iCnt?u(se,t,null):u(le,t,n);break;case lt:u(le,t,n);break;case st:u(r%(i+2)==0?oe:le,t,n);break;case ot:let l,s=c(e.allies);r%(i+2)==0?a.cS.iCnt<2?(l=ue,u(l,t,null)):(l=oe,s=c(e.allies),u(l,t,s)):(l=a.cS.cCnt<2?se:le,u(l,t,s))}})(e,t,a)},1e3)});a.cS.spd=a.bS.spd}},u=async(e,t,a,n)=>{Me(!1);let r=ve(),i=Le(t);switch(Ba(i),ee(i.actor,W),r.text=He(e),await s(1e3),Wa(i,e),e){case le:let t=w(i,a);if(r.text="Did "+-t+" damage.",Sn("actionStrike"),ee(a.actor,N),await s(800),ee(a.actor,z),!Da(a)){let e=l(r,a)?U:D;V(a.actor,e)}break;case se:g(i),Sn("actionCharge");break;case ce:b(i),Sn("actionDefend");break;case pe:I(i);break;case oe:S(i,a);break;case me:k();break;case ue:r.text="Powers replenished.",x(i);break;case de:n&&n.onUse&&n.onUse(n);break;default:console.error("No action:",e,"exists.")}await s(1250),Ua(i),ee(i.actor,z),r.text="",await s(500),Ee()(),h(t)&&za(i)},h=e=>{let{turnOrder:t}=e,a=!1;for(let e=0;e<t.length;e++)Da(t[e])||(t.splice(e,1),a=!0);return a},y=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},f=e=>Pe(e.turnOrder),w=(e,t)=>{let{cS:a,bS:n}=t,{def:r}=a,{dmg:i}=e.bS,{cCnt:l}=e.cS,s=-Math.floor(Math.max((l>0?i*(l+1):i)-r,1));return e.cS.cCnt=0,ja(a,n,s),s},g=e=>{let{cS:t}=e;t.cCnt++},S=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},I=e=>{let{cS:t,bS:a}=e;t.iCnt--,t.hp=a.hp},b=e=>{let{cS:t}=e;t.def*=1.5},k=()=>{ve().completionState=re},x=e=>{e.cS.iCnt=e.bS.mag};window.addEventListener("keydown",e=>{at()||pa(e.key)}),window.addEventListener("keyup",e=>{ma(e.key)});let v=async(e,t)=>(t||Sn("cutscene"),new Promise(t=>{An(e,t)})),C=async(e,t)=>{Sn(t||"menuConfirm"),v("",!0);let a=Ka();a.pause=!0,await s(250);for(let t=0;t<e.length;t++){let a=e[t].trim();a&&await v(a)}Sn("menuCancel"),a.pause=!1},M=async e=>{let t=(e=>[`SIGN: "${e}"`])(e);await C(t),_n()},T=e=>{let t=Ka(),a=ga(t.party),n=e.actor;V(n,a.actor.x<n.x?H:B)},_=async(e,t,a)=>{let n=[""],r=Ka().party,i=ka(r,t),l=t.name+"_fixed";if(an(l)?n=["You have fixed this statue."]:i?(await C(`\nYou place the '${i.name}' inside the statue.\n...\nIt awakens.\n`.split("\n")),ba(r,i),await s(150),Sn("item"),e.actor.spriteIndex=12,await s(2e3),n=["You have fixed the statue!"],tn(l,!0)):n=`\nA plaque says: "${a}"\nThis statue is missing a something...\n`.split("\n"),await C(n),_n(),an(dt.name+"_fixed")&&an(mt.name+"_fixed")&&an(ut.name+"_fixed")){let e="\n'Mwahaha'\n'You've done it!'\n'Now I shall rule over this world!'".split("\n");await C(e),_n();let t=ge(r,_t);return await p(t),void(t.completionState===ae?(await C(["Y THO"]),_n(),window.location.reload()):(await C(["Game Over"]),window.location.reload()))}},A=async(e,t,a)=>{let n=Ka();n.pause=!0;let r=n.party,i=ga(n.party),[l,s]=K(i.actor),o=ge(r,t);await p(o);let c=Za(n);if(Ta(c,e),J(i.actor,l,s),Q(i.actor,0,0),o.completionState===ae){if(a)for(let e in a)await E(a[e])}else if(o.completionState===re)for(let e=0;e<r.characters.length;e++)r.characters[e].unit.cS.spd-=3;else await C(["Game Over"]),window.location.reload();return n.pause=!1,o},E=async(e,t)=>{let a=Ka(),{name:n,dsc:r}=e,i=["You got: "+n,r];a.pause=!0,await C(i,"item"),_n();let l=Za(a);t&&Ta(l,t),Ia(a.party,e)},$=(e,t)=>{let a=e[t];a<0?e[t]+=1.2:a>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},O=e=>{if(e.pause)return;let t=Za(e),{characters:a}=t;a.forEach(e=>{F(e.actor,t)}),P(e.party,t,e)},P=(e,t,a)=>{let i=ga(e).actor,{ax:l,ay:s,isGround:o}=i;ee(i,z),rt(null);let c=l,p=s,d=o?1.2:.04;ua(sa)&&(c=-d,V(i,H),ee(i,R)),ua(la)&&(c=d,V(i,B),ee(i,R)),ua(ca)&&i.isGround&&(Sn("jump"),p=-5.6,i.vy=0,i.isGround=!1),ua(oa)&&(i.dpCol=!0),i.isGround||ee(i,X),Z(i,c,p);let[m,u]=F(i,t);(m||u)&&Qa(m,u,a);let h=r(te(i));for(let e in t.characters){let a=t.characters[e],r=a.actor;Qe("",a);let i=te(r),l=!1;n(h,i).forEach(()=>{l=!0});let s=a.label||a.name;l&&(s&&Qe(s,a),rt(()=>{a.action&&a.action(a)}),a.col&&a.col(a))}},F=(a,i)=>{if(a.plAi===q){let{ax:e}=a,t=e;ee(a,z),a.facing===H?(ee(a,R),t=-.5):(ee(a,R),t=.5),Z(a,t,0)}(e=>{let t=qe();e.ay+=e.isGround?1e-4*t:.185})(a);let l=0,s=0,o=qe(),{x:c,y:p,vx:d,vy:m,ax:u,ay:h,w:y,h:f}=a,w=d+u*o,g=m+h*o;Math.abs(w)>1.2&&(w=1.2*e(w)),Math.abs(g)>3.6&&(g=3.6*e(g)),Q(a,w,g);let S=c+d*o,I=p+m*o,[b,k]=Ma(i);return S<0?(S=0,l=-1):S+y>b&&(S=b-y,l=1),I<0?(I=0,s=-1):I+f>k&&(I=k-f,s=1),J(a,S,I),((e,a)=>{let i,l,s=!1,o=0,c=_a(a);do{o++,i=!1,l=!1;let a=r(t(e.x,e.y,e.w,e.h)),p={0:null,1:null,2:null,3:null};c.forEach(r=>{let s=t(r.px,r.py,r.size,r.size);Aa(r)?n(a,s).forEach(e=>{i=!0,p[e]=r}):(e.y+e.h/2<r.py||e.plAi===q)&&n(a,s).forEach(t=>{0!==t||e.dpCol||(l=!0,i=!0,p[t]=r),2===t&&e.plAi===q&&(i=!0,p[t]=r),3===t&&e.plAi===q&&(i=!0,p[t]=r)})});let d=p[1],m=p[2],u=p[3],h=1;p[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),s=!0):d&&(l||(e.y+=h,e.vy=0)),m?(e.x+=h,e.plAi===q&&V(e,B)):u&&(e.x-=h,e.plAi===q&&V(e,H))}while(i&&o<10);s===e.isGround||s||(e.vy=0),e.isGround=s})(a,i),0===u&&$(a,"vx"),0===h&&$(a,"vy"),Z(a,0,0),[l,s]},G={},L=()=>{G["1,1,13,15"]=At,G["1,1,11,11"]=$t,G["1,1,4,9"]=Et,G["1,1,5,13"]=Ot,G["0,1,9,15"]=Pt,G["0,1,7,11"]=Dt,G["0,1,9,11"]=Bt,G["0,1,11,11"]=Bt,G["0,1,13,11"]=Bt,G["0,1,8,7"]=Bt,G["0,1,10,7"]=Bt,G["0,1,12,7"]=Bt,G["0,1,14,7"]=zt,G["0,1,7,3"]=Bt,G["0,1,9,3"]=Bt,G["0,1,11,3"]=Bt,G["0,1,13,3"]=Ut,G["2,2,2,15"]=Rt,G["2,2,2,12"]=Qt,G["2,2,1,12"]=Qt,G["2,1,5,15"]=Qt,G["2,1,3,15"]=Qt,G["2,1,4,15"]=Qt,G["2,1,3,13"]=Qt,G["2,1,9,9"]=Qt,G["2,1,1,15"]=Ft,G["2,1,8,5"]=Qt,G["2,1,10,15"]=Qt,G["2,0,2,2"]=Gt,G["3,0,2,3"]=Lt,G["3,0,4,10"]=Qt,G["3,0,11,14"]=Qt,G["3,1,2,7"]=Qt,G["3,0,1,14"]=Qt,G["3,1,12,7"]=Qt,G["3,1,3,14"]=Qt,G["3,2,1,5"]=Qt,G["3,1,14,10"]=Qt,G["3,1,9,12"]=Qt,G["3,1,6,12"]=Qt,G["3,2,2,8"]=Qt,G["3,2,11,6"]=Qt,G["3,2,11,12"]=Qt,G["3,0,7,3"]=Qt,G["3,2,14,12"]=Qt,G["3,3,3,15"]=Qt,G["3,3,14,7"]=Qt,G["3,0,7,9"]=Qt,G["3,1,4,5"]=Qt,G["3,2,4,7"]=Qt,G["3,2,7,7"]=Qt,G["3,2,5,7"]=Qt,G["3,2,5,13"]=Qt,G["3,3,8,5"]=Qt,G["3,3,7,5"]=Qt,G["3,1,7,12"]=Qt,G["3,1,6,4"]=Qt,G["3,3,8,15"]=Yt,G["3,3,1,3"]=ta,G["0,3,3,15"]=Qt,G["0,3,3,11"]=Qt,G["0,3,8,4"]=Qt,G["0,3,5,3"]=Qt,G["0,3,11,10"]=Qt,G["0,3,12,6"]=Qt,G["0,3,14,12"]=Qt,G["0,3,7,15"]=Qt,G["0,3,1,6"]=Qt,G["0,0,11,5"]=Qt,G["0,0,12,15"]=Qt,G["0,0,7,5"]=Qt,G["0,0,6,15"]=Qt,G["0,0,3,5"]=Qt,G["0,0,3,15"]=Qt,G["0,0,9,15"]=Qt,G["0,0,4,9"]=Qt,G["0,0,6,9"]=Qt,G["0,0,8,9"]=Qt,G["0,0,10,9"]=Qt,G["0,0,12,9"]=Qt,G["1,0,9,14"]=na,G["1,0,2,15"]=jt,G["1,0,9,8"]=ta,G["2,0,3,9"]=Zt,G["2,0,4,9"]=Zt,G["2,0,5,9"]=Zt,G["2,0,6,8"]=Zt,G["2,0,2,8"]=Zt,G["2,0,8,9"]=ta,G["1,1,8,8"]=aa,G["2,2,2,3"]=ea,G["2,2,3,12"]=Qt,G["2,2,11,3"]=ta,G["2,3,9,15"]=Qt,G["2,3,8,15"]=Qt,G["2,3,7,15"]=Qt,G["2,3,6,15"]=Qt,G["2,3,5,15"]=Qt,G["2,3,4,15"]=Qt,G["2,3,3,15"]=Qt,G["2,3,2,15"]=Qt,G["2,3,10,15"]=Qt,G["2,3,11,15"]=Qt,G["2,3,12,15"]=Qt,G["2,3,13,15"]=Qt,G["2,3,1,15"]=Qt,G["1,3,10,10"]=Ht,G["2,3,15,12"]=Zt,G["3,3,0,12"]=Zt,G["2,2,11,7"]=Wt,G["2,2,5,4"]=Nt,G["1,3,2,15"]=qt,G["1,3,7,15"]=Vt,G["1,3,9,15"]=Jt,G["1,3,11,15"]=Kt,G["2,1,12,7"]=Xt,G["0,0,15,9"]=Zt,G["1,0,0,9"]=Zt,G["1,3,14,15"]=ra};var Y,j;Y=(e=1,t=.05,a=220,n=0,r=0,i=.1,l=0,s=1,o=0,c=0,p=0,d=0,m=0,u=0,h=0,y=0,f=0,w=1,g=0,S=44100,I=99+n*S,b=r*S,k=i*S,x=g*S,v=f*S,C=2*Math.PI,M=(e=>0<e?1:-1),T=I+x+b+k+v,_=(o*=500*C/S**2),A=(a*=(1+2*t*Math.random()-t)*C/S),E=M(h)*C/4,$=0,O=0,P=0,F=0,G=0,L=0,Y=1,H=[],B=j.createBufferSource(),U=j.createBuffer(1,T,S))=>{for(B.connect(j.destination);P<T;H[P++]=L)++G>100*y&&(G=0,L=$*a*Math.sin(O*h*C/S-E),L=M(L=l?1<l?2<l?3<l?Math.sin((L%C)**3):Math.max(Math.min(Math.tan(L),1),-1):1-(2*L/C%2+2)%2:1-4*Math.abs(Math.round(L/C)-L/C):Math.sin(L))*Math.abs(L)**s*e*.3*(P<I?P/I:P<I+x?1-(P-I)/x*(1-w):P<I+x+b?w:P<T-v?(T-P-v)/k*w:0),L=v?L/2+(v>P?0:(P<T-v?1:(P-T)/v)*H[P-v|0]/2):L),$+=1-u+1e9*(Math.sin(P)+1)%2*u,O+=1-u+1e9*(Math.sin(P)**2+1)%2*u,a+=o+=500*c*C/S**3,Y&&++Y>d*S&&(a+=p*C/S,A+=p*C/S,Y=0),m&&++F>m*S&&(a=A,o=_,F=1,Y=Y||1);return U.getChannelData(0).set(H),B.buffer=U,B.start(),B},j=new AudioContext;let H=0,B=1,U=2,D=3,z=0,R=1,X=2,W=3,N=4,q=1,V=(e,t)=>{e.facing=t},J=(e,t,a)=>{e.x=t,e.y=a},K=e=>[e.x,e.y],Q=(e,t,a)=>{e.vx=t,e.vy=a},Z=(e,t,a)=>{e.ax=t,e.ay=a},ee=(e,t)=>{e.anim=t},te=e=>t(e.x,e.y,e.w,e.h),ae=0,ne=1,re=2,ie=3,le=0,se=1,oe=2,ce=3,pe=4,de=5,me=6,ue=7,he=["Strike","Charge","Break","Defend","Heal","Item","Flee"],ye=e=>{let t=[];for(let a=0;a<4;a++)t.push([e,28*a+80]);return t},fe=ye(40),we=ye(200),ge=(e,t,a)=>{a=a||0;let n=Ke(),r=[ha(n/2-50,n-20*he.length,100,he,be,e.inv.filter(e=>!!e.onUse).length?[]:[de],!0,20)],i=(e=>{let t=[];for(let a=0;a<e.length;a++){let{unit:n,name:r}=e[a];n&&(n.name=r,n.i=a,n.allegiance=0,Ua(n),V(n.actor,B),t.push(n))}return Xa(t),t})(e.characters),l=(e=>{let t=[];for(let a=0;a<e.length;a++){let n=Ze(e[a]).unit;n.i=a,n.allegiance=1,V(n.actor,H),Ua(n),t.push(n)}return t})(t.enemies),s={party:e,allies:i,enemies:l,rounds:[],roundIndex:0,actionMenuStack:r,text:"",aiSeed:(3,Math.floor(3*Math.random())+1),completionState:ie};Be(s,a);let o=Pe(i.concat(l));return $e(s,o),s},Se=(e,t)=>0===t?fe[e]:we[e],Ie=async e=>new Promise(t=>{let a=e.enemies,[n,r]=Se(0,1),i=e.enemies.map((e,t)=>t).filter(t=>!Da(e.enemies[t])),l=ha(2*n-In,2*r+bn/2,100,Array(a.length).fill(""),n=>{e.actionMenuStack.shift(),t(n>=0?a[n]:null)},i,!1,56);l.i=-1,ya(l,1),e.actionMenuStack.unshift(l)}),be=async e=>{let t=ve(),a=Oe(t);switch(e){case le:{let e=await Ie(t);e&&u(le,a,e);break}case se:u(se,a,null);break;case ce:u(ce,a,null);break;case pe:u(pe,a,null);break;case de:{let e=await(async e=>new Promise(t=>{let a={},n=e.party,r=0,i=n.inv.filter((e,t)=>(a[r]=t,r++,!!e.onUse)).map(e=>e.name),l=Ke(),s=ha(l/2-50,l-l/2,100,i,e=>{t(n.inv[a[e]])},[],!0,20);s.i=-1,ya(s,1),e.actionMenuStack.unshift(s)}))(t);e&&u(de,a,null,e),t.actionMenuStack.shift();break}case oe:{let e=await Ie(t);e||u(oe,a,e);break}case me:u(me,a,null);break;default:console.error("Action",e,"Is not implemented yet.")}},ke=null,xe=e=>{ke=e},ve=()=>ke,Ce=!1,Me=e=>{Ce=e},Te=()=>Ce,_e=()=>{},Ae=e=>{_e=e},Ee=()=>_e,$e=(e,t)=>{e.rounds.push(t)},Oe=e=>e.rounds[e.roundIndex],Pe=e=>({turnOrder:e,currentIndex:0}),Fe=e=>{e.currentIndex++},Ge=e=>{e.roundIndex++},Le=e=>e.turnOrder[e.currentIndex]||null,Ye=e=>null===Le(e),je=e=>i(e.enemies)||i(e.allies)||e.completionState!==ie,He=e=>he[e],Be=(e,t)=>{if(0===t)return;let a=1===t?e.allies:e.enemies;for(let e=0;e<a.length;e++)a[e].cS.spd+=5},Ue=null,De=1,ze=0,Re=(e,t)=>{let a=document.createElement("canvas");return a.width=e,a.height=t,[a,a.getContext("2d"),e,t]},Xe=()=>{var e;if(Ue)return Ue;{let[t,a]=Re(512,512);return t.id="canv",a.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Ue=t,t}},We=()=>Xe().getContext("2d"),Ne=e=>{De=e},qe=()=>De,Ve=e=>{ze=e},Je=()=>ze,Ke=()=>512,Qe=(e,t)=>{t.aText=e},Ze=(e,t)=>{let{sprI:a,spr:n,stats:r,label:i,action:l,col:s,plAi:o,name:c}=e,p={sprite:"actors",spriteIndex:a,facing:H,anim:z,isGround:!1,dpCol:!1,plAi:0,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return p.plAi=o||0,n&&(p.sprite=n),{name:t||c,actor:p,label:i||"",action:l,col:s,aText:"",unit:r?Ya(c,p,e,0,0):void 0}},et=!1,tt=null,at=()=>et,nt=e=>{et=e},rt=e=>tt=e,it=1,lt=2,st=3,ot=4,ct=(e,t,a,n,r)=>({hp:e,dmg:t,def:a,mag:n,spd:r,iCnt:n,cCnt:0}),pt={name:"Bomb",dsc:"It destroys all enemies!",onUse:async e=>{let t=ve();ba(t.party,e),t.completionState=ae,Sn("actionStrike")}},dt={name:"Statue's Legs",dsc:"Good for running."},mt={name:"Statue's Voice",dsc:"For yelling."},ut={name:"Statue's Mind",dsc:"Arguably necessary"},ht={name:"Radiant Stone",dsc:"Gleaming marble.",onUse:()=>{}},yt={name:"",stats:{bS:ct(90,25,16,5,20),ai:0},sprI:0},ft=(ct(85,25,13,6,15),ct(80,19,18,4,6),ct(75,23,12,7,10),{name:"Golem",stats:{bS:ct(35,22,40,0,5),ai:lt},sprI:8}),wt={name:"Fairy",stats:{bS:ct(30,23,9,2,15),ai:it},sprI:4},gt={name:"Ape",stats:{bS:ct(20,40,5,0,15),ai:lt},sprI:6},St={name:"Breaker",stats:{bS:ct(35,30,14,1,14),ai:st},sprI:7},It={name:"Old Guy",stats:{bS:ct(200,30,40,10,17),ai:ot},sprI:15},bt=Object.assign(Object.assign({},It),{name:"Old Guy (clone)"}),kt={enemies:[wt,ft,wt,St]},xt={enemies:[gt,gt,wt]},vt={enemies:[gt,wt,ft,ft]},Ct={enemies:[St,gt,ft]},Mt={enemies:[St,gt,wt]},Tt={enemies:[wt,gt,gt,ft]},_t={enemies:[It,bt]},At={name:"Old Man",sprI:15,action:async e=>{T(e);let t="\n'Hello there.'\n'You've arrived with your wits about.'\n'That's very good. You'll need them.'\n'These status are all...'\n'...missing something.'\n:)\n'Perhaps you should find what is not found...'\n  ".split("\n");await C(t),_n()}},Et={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{_(e,dt,"The Runner.")}},$t={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{_(e,ut,"The Thinker.")}},Ot={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{_(e,mt,"The Speaker.")}},Pt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Probably nothing is in these pots.")},Ft={name:"Sign",spr:"terrain",sprI:5,action:()=>M("SPIKES are dangerous.")},Gt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointless.")},Lt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointy.")},Yt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("How do you get up this cliff?")},jt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("The SHRINE of LEGS.")},Ht={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Seek. Seek. Lest.")},Bt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{let e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await C(e),_n()}},Ut={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{let e="\nThis pot seems different from the others!\nYou check the pot.\n...\nThere's nothing inside.\n  ".split("\n");await C(e),_n()}},Dt={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ct(85,25,13,6,15),ai:0},action:async e=>{let t="\nYou check the pot...\nThere's a man inside.\n'Hello! You look very appealing!'\n'I'm coming with you!'\nThe Pot joins your party.\n  ".split("\n");await C(t),_n();let a=Ka(),n=a.party,r=Za(a);Ta(r,e),Sa(n,e)}},zt={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ct(85,25,13,6,15),ai:lt},action:async e=>{let t="\nYou check the pot...\n  ".split("\n");await C(t),await E(mt,e),_n()}},Rt={name:"Jin",sprI:3,stats:{bS:ct(75,23,12,7,10),ai:0},action:async e=>{T(e);let t=[""];t=nn("talked_to_jin")?"\n'Hello friend!'\n'I have misplaced some treasure.'\n'If you bring it to me, I'd accompany you.'\n    ".split("\n"):"\n'Have you found my treasure yet?'\n      ".split("\n"),await C(t),_n();let a=Ka(),{party:n}=a;if(ka(n,ht)){let t="\n'I'll take that! Let's be on our way!'\n      ".split("\n");ba(n,ht),Sa(n,e);let r=Za(a);Ta(r,e),await C(t),_n()}}},Xt={name:"",sprI:8,col:async e=>{await A(e,Tt,[pt])},plAi:q},Wt={name:"",sprI:8,col:async e=>{await A(e,vt,[pt])},plAi:q},Nt={name:"",sprI:8,col:async e=>{await A(e,kt,[pt])},plAi:q},qt={name:"",sprI:8,col:async e=>{await A(e,xt,[pt])},plAi:q},Vt={name:"",sprI:8,col:async e=>{await A(e,Ct,[pt])},plAi:q},Jt={name:"",sprI:8,col:async e=>{await A(e,Mt,[pt])},plAi:q},Kt={name:"",sprI:8,col:async e=>{await A(e,xt,[pt])},plAi:q},Qt={name:"",spr:"terrain",sprI:6,col:async()=>{let e=Ka();e.pause=!0,Sn("spikes"),await s(1e3),e.pause=!1,en(Ka())}},Zt={name:"",spr:"terrain",sprI:1},ea={name:"Shining Stone",spr:"terrain",sprI:11,action:e=>E(ht,e)},ta={name:"Item",spr:"terrain",sprI:11,action:e=>E(pt,e)},aa={name:"Orange",sprI:0,stats:{bS:ct(5,23,12,7,10),ai:lt},action:async e=>{T(e);let t="\n'I am the strongest man!'\n'Fight me and I will join you!'\n    ".split("\n"),a="\n'Wow, you are tough! Onward, then!'\nOrange has joined your party.\n    ".split("\n");await C(t),_n();let n={enemies:[aa]},r=Ka();if((await A(e,n)).completionState===ae){Sa(r.party,e),await C(a),_n();let t=e.unit;ja(t.cS,t.bS,99)}}},na={name:"Item",spr:"terrain",sprI:11,action:e=>E(dt,e)},ra={name:"Item",spr:"terrain",sprI:11,action:e=>E(ut,e)},ia={},la="ArrowRight",sa="ArrowLeft",oa="ArrowDown",ca=" ",pa=e=>{if(1===e.length&&(e=e.toUpperCase()),!ia[e]){if(ia[e]=!0,"Q"===e&&(window.running=!1),at())return;let t=ve();if(t){if(Te()){let a=t.actionMenuStack[0];e===oa?ya(a,1):"ArrowUp"===e?ya(a,-1):"Enter"===e||"X"===e||e===ca?fa(a):"Escape"===e&&t.actionMenuStack.length>1&&wa(a)}}else if("X"===e||"Enter"===e){let e=tt;e&&e()}}},da=-1,ma=e=>{if(1===e.length&&(e=e.toUpperCase()),e===oa){let e=Ka(),t=ga(e.party).actor;t.dpCol&&(clearTimeout(da),da=setTimeout(()=>{t.dpCol=!1},150))}ia[e]=!1},ua=e=>(1===e.length&&(e=e.toUpperCase()),ia[e]),ha=(e,t,a,n,r,i,l,s)=>({x:e,y:t,w:a,h:(s=s||16)*n.length,i:0,cb:r,disabledItems:i,items:n,lineHeight:s,bg:!!l}),ya=(e,t,a)=>{let n=e.items.length,r=0,i=0,l=e.i;do{if(r++,r>30)break;i=l+t,i<0?i=n-1:i>=n&&(i=0),l=i}while(e.disabledItems.includes(i));e.i=i,a||Sn("menuMove")},fa=e=>{e.cb(e.i),Sn("menuConfirm")},wa=e=>{e.cb(-1),Sn("menuCancel")},ga=e=>e.characters[0],Sa=(e,t)=>{t.unit.ai=0,e.characters.push(t)},Ia=(e,t)=>{let a=Object.assign({},t);e.inv.push(a),En(e.inv,!0)},ba=(e,t)=>{let a=e.inv.indexOf(t);a>-1&&e.inv.splice(a,1),En(e.inv,!0)},ka=(e,t)=>{for(let a in e.inv){let{name:n}=e.inv[a];if(n===t.name)return e.inv[a]}return null},xa={0:[156,100,52],1:[171,82,54],2:[0,228,54],7:[255,241,232],15:[0,0,0]},va={};for(let e in xa)va[xa[e].join("")]=+e;let Ca=(e,t,a,n)=>{let r=[],i=[],[,l]=Re(16,16);mn(e,0,0,1,l);let{data:s}=l.getImageData(0,0,16,16),o=0;for(let e=0;e<s.length;e+=4){let t=va[`${s[e+0]}${s[e+1]}${s[e+2]}`]||0,l=o%16,c=Math.floor(o/16),p=null,d=G[[a,n,l,c].join(",")];d&&(p=Ze(d)),p&&(J(p.actor,16*l,16*c-16),i.push(p)),r.push({id:t,x:l,y:c,px:16*l,py:16*c,size:16}),o++}return{tiles:r,characters:i,w:16,h:16,bgSprite:t}},Ma=e=>[16*e.w,16*e.h],Ta=(e,t)=>{let a=e.characters.indexOf(t);a>-1&&e.characters.splice(a,1)},_a=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),Aa=e=>[0,1,7].includes(e.id),Ea=(e,t,a,n,r)=>[e,t,a,n,r],$a=null,Oa=e=>{let[t,a,n,r]=Re(e.width,e.height),i=n/2,l=r/2;return a.translate(i,l),a.rotate(Math.PI/2),a.drawImage(e,-i,-l),t},Pa=e=>{let[t,a,n]=Re(e.width,e.height);return a.translate(n,0),a.scale(-1,1),a.drawImage(e,0,0),t},Fa=e=>{let[,,,t,a]=e,[n,r]=Re(t,a);return mn(e,0,0,1,r),n},Ga=(e,t,a,n,r)=>{let i=(t,a,n,r,i,l)=>e[t]=Ea(a,n,r,i,l),l=(e,t,a)=>{let l=e;for(let e=0;e<a;e++)l=Oa(l);i(`${t}_r${a}`,l,0,0,n,r)},s=t.width/n,o=t.height/r;for(let e=0;e<o;e++)for(let o=0;o<s;o++){let c=`${a}_${e*s+o}`,p=i(c,t,o*n,e*r,n,r);l(Fa(p),c,1),l(Fa(p),c,2),l(Fa(p),c,3),i(c+"_f",Pa(Fa(p)),0,0,n,r),i(c+"_fr1",Oa(Pa(Fa(p))),0,0,n,r)}},La=async()=>{let e={},t=await new Promise(e=>{let t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),a=Fa(Ea(t,0,0,64,64));Ga(e,a,"actors",16,16);let n=Fa(Ea(t,64,0,64,64));Ga(e,n,"terrain",16,16);let r=Fa(Ea(t,0,64,64,64));Ga(e,r,"map",16,16);let i=Fa(Ea(t,64,64,64,64));Ga(e,i,"monsters",16,16),$a=e},Ya=(e,t,a,n,r)=>{let i=a.stats,l={name:e,actor:t,bS:Object.assign({},i.bS),cS:Object.assign({},i.bS),i:r,allegiance:n,ai:i.ai};return V(l.actor,l.allegiance?H:B),Ua(l),l},ja=(e,t,a)=>{let{hp:n}=e,{hp:r}=t,i=n+a;i>r?i=r:i<0&&(i=0),e.hp=i},Ha=e=>{let{allegiance:t}=e,[a,n]=Se(e.i,t);J(e.actor,a+(t?-20:20),n)},Ba=e=>{let t=Ke()/2/2-8;J(e.actor,t,t)},Ua=e=>{let[t,a]=Se(e.i,e.allegiance);J(e.actor,t,a)},Da=e=>e.cS.hp>0,za=e=>{e.cS.iCnt++},Ra=e=>{e.cS.def=e.bS.def},Xa=e=>{for(let t=0;t<e.length;t++)0===e[t].cS.hp&&(e[t].cS.hp=1)},Wa=(e,t)=>{let{cS:a}=e;switch(t){case le:a.spd+=0;break;case se:a.spd-=2;break;case oe:a.spd-=1;break;case ce:a.spd+=3;break;case pe:a.spd-=1;break;case de:case me:a.spd-=2}},Na=null,qa={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},Va=()=>{let e={characters:[Ze(yt,"Runner")],inv:[],worldX:0,worldY:0},t=ga(e);J(t.actor,128,180);let a={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)a.rooms.push(Ca("map_"+e,qa[e],e%4,Math.floor(e/4)));return a},Ja=e=>{Na=e},Ka=()=>Na,Qa=(e,t,a)=>{((e,t,a)=>{a.roomI=4*t+e})((a.roomI%4+e+4)%4,(Math.floor(a.roomI/4)+t+4)%4,a);let n=Za(a),r=ga(a.party).actor,[i,l]=Ma(n),s=0,o=0;e>0&&(s=0,o=r.y),e<0&&(s=i-16,o=r.y),t>0&&(s=r.x,o=0),t<0&&(s=r.x,o=l-16),J(r,s,o),a.lastX=s,a.lastY=o},Za=e=>e.rooms[e.roomI],en=e=>{let t=ga(e.party);J(t.actor,e.lastX,e.lastY)},tn=(e,t)=>{Ka().state[e]=t},an=e=>Ka().state[e],nn=e=>void 0===an(e)&&(tn(e,!0),!0),rn="#000",ln={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},sn={},on=()=>{let e=Xe();dn(0,0,e.width,e.height,"#557","#aaf")},cn=(e,t,a,n,r,i,l)=>{(l=l||We()).lineWidth=1,l[i?"strokeStyle":"fillStyle"]=r,l[i?"strokeRect":"fillRect"](e,t,a,n)},pn=(e,t,a,n,r)=>{let{font:i,size:l,color:s,align:o,strokeColor:c}=Object.assign(Object.assign({},ln),n||{});(r=r||We()).font=`${l}px ${i}`,r.fillStyle=s,r.textAlign=o,r.textBaseline="middle",r.fillText(e,t,a),c&&(r.strokeStyle=c,r.lineWidth=.5,r.strokeText(e,t,a))},dn=(e,t,a,n,r,i)=>{let l=We(),s=`${e},${t},${a},${n},${r},${i}`;if(!sn[s]){let e=l.createLinearGradient(0,n,0,0);e.addColorStop(0,r),e.addColorStop(1,i),sn[s]=e}l.fillStyle=sn[s],l.fillRect(e,t,a,n)},mn=(e,t,a,n,r)=>{n=n||1,r=r||We();let[i,l,s,o,c]="string"==typeof e?$a[e]:e;r.drawImage(i,l,s,o,c,t,a,o*n,c*n)},un=(e,t,a)=>{a=a||1;let{x:n,y:r}=e,i=n*a,l=r*a,[s,c,p]=((e,t)=>{let{facing:a,sprite:n,spriteIndex:r,anim:i}=e,l=i,s=r<3,c=0;t||(i===R?l-=o(1,100):i===W?s?l=2-o(1,250):(l=0,c=2*o(1,100)):i===N&&(l=s?2:0));let p="";switch(a){case 0:p="_f";break;case 2:p="_r3";break;case 3:p="_fr1"}return[n+"_"+(r+l+p),0,c]})(e,t);mn(s,i+c,l+p,a)},hn=(e,t,a,n)=>{let r=Ka(),i=n||1;e.tiles.forEach(r=>{let{id:l,x:s,y:o,size:c}=r,p=(t+s*c)*i,d=(a+o*c)*i;mn(e.bgSprite,p,d,n),15!=l&&mn("terrain_"+l,p,d,n)}),e.characters.forEach(e=>{let t=e.actor;un(t,r.pause,n);let{x:a,y:l}=t,s=e.aText;s&&pn(s,a*i+16*i/2,l*i-16*i/2,{size:16,align:"center"})})},yn=e=>{on();let t=Le(Oe(e));kn(5,15,150,20),pn("Turn: "+(null==t?void 0:t.name),10,26);let{allies:a,enemies:n,actionMenuStack:r}=e,i=r[0];for(let e=0;e<a.length;e++){let[t,n]=K(a[e].actor);J(a[e].actor,t,n),un(a[e].actor,!1,2),pn(""+a[e].name,2*t+16,2*n-5,{align:"center"})}Cn(e,0),Cn(e,1);for(let e=0;e<n.length;e++){let[t,a]=K(n[e].actor);un(n[e].actor,!1,2),pn(`${n[e].name}: ${""+n[e].cS.hp}/${""+n[e].bS.hp}`,2*t+5,2*a-5,{align:"center"})}Te()&&xn(i),e.text&&vn(e.text),Mn(e)},fn=null,wn=(e,t,a)=>{e[t]=a},gn=()=>{let e={};wn(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),wn(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),wn(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),wn(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),wn(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),wn(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),wn(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),wn(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),wn(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),wn(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),wn(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),wn(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),fn=e},Sn=e=>{Y(...fn[e])},In=16,bn=16,kn=(e,t,a,n,r)=>{cn(e,t,a,n,r=r||rn),cn(e,t,a,n,"#FFF",!0)},xn=e=>{let{x:t,y:a,w:n,h:r,i:i,bg:l,items:s,lineHeight:o}=e;l&&kn(t,a,n,r),s.forEach((r,i)=>{let l="#FFF";e.disabledItems.includes(i)&&(l="#999"),pn(r,t+n/2,a+i*o+o/2,{align:"center",color:l})}),((e,t)=>{let a=We(),n=bn,r=In;a.save(),a.translate(e+2,t),a.beginPath(),a.moveTo(0,0),a.lineTo(0,n),a.lineTo(r,n/2),a.closePath(),a.fillStyle="#FFF",a.fill(),a.restore()})(t,a+o*i)},vn=e=>{let t=Ke();kn(0,90,t,50),pn(e,Ke()/2,116,{align:"center",size:20})},Cn=(e,t)=>{let a=Ke(),n=1===t?a-200:0,r=a-90;kn(n,r,200,90),((e,t)=>{let a=t-25;kn(0,a,200,25),pn("Unit",10,a+12.5),pn("HP",70,a+12.5),pn("Chg",117,a+12.5),pn("Brk/Hl",150,a+12.5)})(0,r);let i=1===t?e.enemies:e.allies;for(let e=0;e<i.length;e++){let a=i[e],{name:l,bS:s,cS:o}=a;0===t?(pn(l.slice(0,8),n+10,r+15+20*e),pn(`${o.hp}/${s.hp}`,n+70,r+15+20*e),pn(""+o.cCnt,n+125,r+15+20*e),pn(""+o.iCnt,n+168,r+15+20*e)):pn(l.slice(0,8),n+100,r+15+20*e,{align:"center"})}},Mn=e=>{let{turnOrder:t}=Oe(e),a=t.length,n=35*a,r=Ke()-Ke()/3-n/2;kn(r-5,5,n+5,80);for(let n=0;n<a;n++,r+=35){let{name:a,actor:i}=t[n],{sprite:s,spriteIndex:o}=i,c=10+(Oe(e).currentIndex===n?20:10);kn(r,c,30,40,l(e,t[n])?"#29ADFF":"#FF004D");let p=l(e,t[n])?c-5:c+40+8;pn(a.slice(0,5),r+15,p,{size:12,align:"center",strokeColor:"#FFF"}),mn(`${s}_${o}`,r,c+5,2)}},Tn=null,_n=()=>{let e=document.getElementById("dialogBox");window.removeEventListener("keypress",Tn),e.style.opacity="0",e.style.width="0",nt(!1)},An=(e,t)=>{let a=document.getElementById("dialogBox");window.removeEventListener("keypress",Tn),a.innerHTML=`<div style="width:476px">${e}</div>`,a.style.opacity="1",a.style.width="512px",Tn=e=>{let a=e.key.length>1?e.key:e.key.toUpperCase();a!==ca&&"X"!==a&&"Enter"!==a||(window.removeEventListener("keypress",Tn),t())},setTimeout(()=>{window.addEventListener("keypress",Tn)},25),nt(!0)},En=(e,t)=>{let a=document.getElementById("itemBox");a.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){let n=document.createElement("span");n.innerHTML=e[t].name+(t<e.length-1?",":""),n.className="item",a.appendChild(n)}a.style.display=t?"flex":"none"}})();