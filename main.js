(()=>{window.running=!0,window.addEventListener("load",async()=>{await Ln(),wa(),L(),(async()=>{const e=Vn();Jn(e),window.world=e,ca(0,0,Je(),Je(),sa);const t="\n  Press X to continue...\n  ".split("\n");await C(t),Ta();const n=e.party,a=performance.now();let s=a;const o=t=>{const i=(t-s)/18;Ne(i>2?2:i),qe(t-a),s=t,ra();const r=xe();if(r)ua(r);else{const t=Zn(e),a=gn(n).actor;P(e),ma(t,0,0,2),da(a,e.pause,2)}window.running&&requestAnimationFrame(o)};o(a)})()});const e=e=>Math.abs(e)/e,t=(e,t,n,a)=>[e,t,e+n,t+a],n=(e,t)=>[e,t],a=(e,t)=>e.map((e,n)=>((e,t)=>{const[n,a]=e,[s,o,i,r]=t;return n>s&&n<i&&a>o&&a<r})(e,t)?n:-1).filter(e=>e>-1),s=e=>{const[t,a,s,o]=e,i=s-t,r=t+i/2,c=a+(o-a)/2;return[n(r,o),n(r,a),n(t+i/4,c),n(s-i/4,c)]},o=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),i=(e,t)=>e.allies.includes(t),r=async e=>new Promise(t=>{setTimeout(t,e)}),c=(e,t)=>Math.floor(Ve()%((e+1)*t)/t),l=e=>{let t=e[0];for(let n=0;n<e.length;n++)e[n].cS.hp<t.cS.hp&&(t=e[n]);return t},p=async e=>new Promise(async t=>{for(ke(e),Ce(!1);!je(e);)await h(e);e.completionState=o(e.allies)?ae:o(e.enemies)?ne:se,ke(null),t()}),h=async e=>{const t=$e(e);for(y(t);!Le(t);)await d(e,t),Oe(t);const n=f(t);Ae(e,n),Fe(e)},d=async(e,t)=>{const n=Ge(t);if(Un(n)&&!je(e)){if(n.cS.def!==n.bS.def&&Rn(n),0!==n.cS.spd)return Yn(n),new Promise(a=>{_e(a);const s=e.actionMenuStack[0];i(e,n)?(n.cS.iCnt<=0?s.disabledItems.push(2,4):s.disabledItems=s.disabledItems.filter(e=>2!==e&&4!==e),s.i=-1,yn(s,1,!0),Ce(!0)):setTimeout(()=>{((e,t,n)=>{const a=l(e.allies),{roundIndex:s,aiSeed:o}=e;switch(n.ai){case st:n.cS.cCnt<n.cS.iCnt?(m(ie,t,null),((e,t)=>{e.text=t.cS.cCnt/t.cS.iCnt<.2?t.name+" begins to glow ominously.":t.name+" shines threateningly."})(e,n)):m(oe,t,a);break;case ot:m(oe,t,a);break;case it:m(s%(o+2)==0?re:oe,t,a);break;case rt:let i,r=l(e.allies);s%(o+2)==0?n.cS.iCnt<2?(i=de,m(i,t,null)):(i=re,r=l(e.allies),m(i,t,r)):(i=n.cS.cCnt<2?ie:oe,m(i,t,r))}})(e,t,n)},1e3)});n.cS.spd=n.bS.spd}},m=async(e,t,n,a)=>{Ce(!1);const s=xe(),o=Ge(t);switch(Bn(o),ee(o.actor,N),s.text=He(e),await r(1e3),Nn(o,e),e){case oe:const t=w(o,n);if(s.text="Did "+-t+" damage.",ga("actionStrike"),ee(n.actor,W),await r(800),ee(n.actor,z),!Un(n)){const e=i(s,n)?D:U;V(n.actor,e)}break;case ie:g(o),ga("actionCharge");break;case ce:I(o),ga("actionDefend");break;case le:b(o);break;case re:S(o,n);break;case he:k();break;case de:s.text="Powers replenished.",x(o);break;case pe:a&&a.onUse&&a.onUse(a);break;default:console.error("No action:",e,"exists.")}await r(1250),Dn(o),ee(o.actor,z),s.text="",await r(500),Ee()(),u(t)&&zn(o)},u=e=>{const{turnOrder:t}=e;let n=!1;for(let e=0;e<t.length;e++)Un(t[e])||(t.splice(e,1),n=!0);return n},y=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},f=e=>Pe(e.turnOrder),w=(e,t)=>{const{cS:n,bS:a}=t,{def:s}=n,{dmg:o}=e.bS,{cCnt:i}=e.cS,r=-Math.floor(Math.max((i>0?o*(i+1):o)-s,1));return e.cS.cCnt=0,Hn(n,a,r),r},g=e=>{const{cS:t}=e;t.cCnt++},S=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},b=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},I=e=>{const{cS:t}=e;t.def*=1.5},k=()=>{xe().completionState=se},x=e=>{e.cS.iCnt=e.bS.mag};window.addEventListener("keydown",e=>{tt()||pn(e.key)}),window.addEventListener("keyup",e=>{dn(e.key)});const v=async(e,t)=>(t||ga("cutscene"),new Promise(t=>{_a(e,t)})),C=async(e,t)=>{ga(t||"menuConfirm"),v("",!0);const n=Kn();n.pause=!0,await r(250);for(let t=0;t<e.length;t++){const n=e[t].trim();n&&await v(n)}ga("menuCancel"),n.pause=!1},M=async e=>{const t=(e=>[`This sign says: "${e}"`])(e);await C(t),Ta()},T=e=>{const t=Kn(),n=gn(t.party),a=e.actor;V(a,n.actor.x<a.x?Y:B)},_=async(e,t,n)=>{let a=[""];const s=Kn().party,o=kn(s,t),i=t.name+"_fixed";if(na(i)?a=["You have fixed this statue."]:o?(await C(`\nYou place the '${o.name}' inside the statue.\n...\nSomething awakens inside it.\n`.split("\n")),In(s,o),await r(150),ga("item"),e.actor.spriteIndex=12,await r(2e3),a=["You have fixed the statue!"],ta(i,!0)):a=`\nThere's a plaque beneath this statue.\nIt says, "${n}"\nThis statue appears to be missing a something...\n`.split("\n"),await C(a),Ta(),na(pt+"_fixed")&&na(ht+"_fixed")&&na(dt+"_fixed")){const e="\n'Mwahaha'\n'You've done exactly as I've asked.'\n'Now that I've become unbound, I will return to my rightful place and rule over this world!'".split("\n");await C(e),Ta();const t=we(s,Tt);return await p(t),void(t.completionState===ne?(await C(["Y THO"]),Ta(),window.location.reload()):(await C(["Game Over"]),window.location.reload()))}},E=async(e,t,n)=>{const a=Kn();a.pause=!0;const s=a.party,o=gn(a.party),[i,r]=K(o.actor),c=we(s,t);await p(c);const l=Zn(a);if(Tn(l,e),J(o.actor,i,r),Q(o.actor,0,0),c.completionState===ne){if(n)for(let e in n)await A(n[e])}else if(c.completionState===se)for(let e=0;e<s.characters.length;e++)s.characters[e].unit.cS.spd-=3;else await C(["Game Over"]),window.location.reload();return a.pause=!1,c},A=async(e,t)=>{const n=Kn(),{name:a,dsc:s}=e,o=["You acquired: "+a,s];n.pause=!0,await C(o,"item"),Ta();const i=Zn(n);t&&Tn(i,t),bn(n.party,e)},$=(e,t)=>{const n=e[t];n<0?e[t]+=1.2:n>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},P=e=>{if(e.pause)return;const t=Zn(e),{characters:n}=t;n.forEach(e=>{F(e.actor,t)}),O(e.party,t,e)},O=(e,t,n)=>{const o=gn(e).actor,{ax:i,ay:r,isGround:c}=o;ee(o,z),at(null);let l=i,p=r;const h=c?1.2:.04;mn(rn)&&(l=-h,V(o,Y),ee(o,R)),mn(on)&&(l=h,V(o,B),ee(o,R)),mn(ln)&&o.isGround&&(ga("jump"),p=-5.6,o.vy=0,o.isGround=!1),mn(cn)&&(o.disablePlatformCollision=!0),o.isGround||ee(o,X),Z(o,l,p);const[d,m]=F(o,t);(d||m)&&Qn(d,m,n);const u=s(te(o));for(let e in t.characters){const n=t.characters[e],s=n.actor;Ke("",n);const o=te(s);let i=!1;a(u,o).forEach(()=>{i=!0});const r=n.label||n.name;i&&(r&&Ke(r,n),at(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},F=(n,o)=>{if(n.plAi===q){const{ax:e}=n;let t=e;ee(n,z),n.facing===Y?(ee(n,R),t=-.5):(ee(n,R),t=.5),Z(n,t,0)}(e=>{const t=We();e.ay+=e.isGround?1e-4*t:.185})(n);let i=0,r=0;const c=We();let{x:l,y:p,vx:h,vy:d,ax:m,ay:u,w:y,h:f}=n,w=h+m*c,g=d+u*c;Math.abs(w)>1.2&&(w=1.2*e(w)),Math.abs(g)>3.6&&(g=3.6*e(g)),Q(n,w,g);let S=l+h*c,b=p+d*c;const[I,k]=Mn(o);return S<0?(S=0,i=-1):S+y>I&&(S=I-y,i=1),b<0?(b=0,r=-1):b+f>k&&(b=k-f,r=1),J(n,S,b),((e,n)=>{let o,i,r=!1,c=0;const l=_n(n);do{c++,o=!1,i=!1;const n=s(t(e.x,e.y,e.w,e.h)),p={0:null,1:null,2:null,3:null};l.forEach(s=>{const r=t(s.px,s.py,s.size,s.size);En(s)?a(n,r).forEach(e=>{o=!0,p[e]=s}):(e.y+e.h/2<s.py||e.plAi===q)&&a(n,r).forEach(t=>{0!==t||e.disablePlatformCollision||(i=!0,o=!0,p[t]=s),2===t&&e.plAi===q&&(o=!0,p[t]=s),3===t&&e.plAi===q&&(o=!0,p[t]=s)})});const h=p[1],d=p[2],m=p[3],u=1;p[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),r=!0):h&&(i||(e.y+=u,e.vy=0)),d?(e.x+=u,e.plAi===q&&V(e,B)):m&&(e.x-=u,e.plAi===q&&V(e,Y))}while(o&&c<10);r===e.isGround||r||(e.vy=0),e.isGround=r})(n,o),0===m&&$(n,"vx"),0===u&&$(n,"vy"),Z(n,0,0),[i,r]},G={},L=()=>{G["1,1,13,15"]=_t,G["1,1,11,11"]=At,G["1,1,4,9"]=Et,G["1,1,5,13"]=$t,G["0,1,9,15"]=Pt,G["0,1,7,11"]=Dt,G["0,1,9,11"]=Yt,G["0,1,11,11"]=Yt,G["0,1,13,11"]=Yt,G["0,1,8,7"]=Yt,G["0,1,10,7"]=Yt,G["0,1,12,7"]=Yt,G["0,1,14,7"]=Ut,G["0,1,7,3"]=Yt,G["0,1,9,3"]=Yt,G["0,1,11,3"]=Yt,G["0,1,13,3"]=Bt,G["2,2,2,15"]=zt,G["2,2,2,12"]=Kt,G["2,2,1,12"]=Kt,G["2,1,5,15"]=Kt,G["2,1,3,15"]=Kt,G["2,1,4,15"]=Kt,G["2,1,3,13"]=Kt,G["2,1,9,9"]=Kt,G["2,1,1,15"]=Ot,G["2,1,8,5"]=Kt,G["2,1,10,15"]=Kt,G["2,0,2,2"]=Ft,G["3,0,2,3"]=Gt,G["3,0,4,10"]=Kt,G["3,0,11,14"]=Kt,G["3,1,2,7"]=Kt,G["3,0,1,14"]=Kt,G["3,0,14,7"]=Kt,G["3,1,12,7"]=Kt,G["3,1,3,14"]=Kt,G["3,2,1,5"]=Kt,G["3,1,14,10"]=Kt,G["3,1,9,12"]=Kt,G["3,1,6,12"]=Kt,G["3,2,2,8"]=Kt,G["3,2,11,6"]=Kt,G["3,2,11,12"]=Kt,G["3,0,7,3"]=Kt,G["3,2,14,12"]=Kt,G["3,3,3,15"]=Kt,G["3,3,14,7"]=Kt,G["3,0,7,9"]=Kt,G["3,1,4,5"]=Kt,G["3,2,4,7"]=Kt,G["3,2,7,7"]=Kt,G["3,2,5,7"]=Kt,G["3,2,5,13"]=Kt,G["3,3,8,5"]=Kt,G["3,3,7,5"]=Kt,G["3,1,7,12"]=Kt,G["3,1,6,4"]=Kt,G["3,3,8,15"]=Lt,G["3,3,1,3"]=en,G["0,3,3,15"]=Kt,G["0,3,3,11"]=Kt,G["0,3,8,4"]=Kt,G["0,3,5,3"]=Kt,G["0,3,11,10"]=Kt,G["0,3,12,6"]=Kt,G["0,3,14,12"]=Kt,G["0,3,7,15"]=Kt,G["0,3,1,6"]=Kt,G["0,0,11,5"]=Kt,G["0,0,12,15"]=Kt,G["0,0,7,5"]=Kt,G["0,0,6,15"]=Kt,G["0,0,3,5"]=Kt,G["0,0,3,15"]=Kt,G["0,0,9,15"]=Kt,G["0,0,4,9"]=Kt,G["0,0,6,9"]=Kt,G["0,0,8,9"]=Kt,G["0,0,10,9"]=Kt,G["0,0,12,9"]=Kt,G["1,0,9,14"]=nn,G["1,0,2,15"]=jt,G["1,0,9,8"]=en,G["2,0,3,9"]=Qt,G["2,0,4,9"]=Qt,G["2,0,5,9"]=Qt,G["2,0,6,8"]=Qt,G["2,0,2,8"]=Qt,G["2,0,8,9"]=en,G["0,2,4,15"]=en,G["1,1,8,8"]=tn,G["2,2,2,3"]=Zt,G["2,2,3,12"]=Kt,G["2,2,11,3"]=en,G["2,3,9,15"]=Kt,G["2,3,8,15"]=Kt,G["2,3,7,15"]=Kt,G["2,3,6,15"]=Kt,G["2,3,5,15"]=Kt,G["2,3,4,15"]=Kt,G["2,3,3,15"]=Kt,G["2,3,2,15"]=Kt,G["2,3,10,15"]=Kt,G["2,3,11,15"]=Kt,G["2,3,12,15"]=Kt,G["2,3,13,15"]=Kt,G["2,3,1,15"]=Kt,G["1,3,10,10"]=Ht,G["2,3,15,12"]=Qt,G["3,3,0,12"]=Qt,G["2,2,11,7"]=Xt,G["2,2,5,4"]=Nt,G["1,3,2,15"]=Wt,G["1,3,7,15"]=qt,G["1,3,9,15"]=Vt,G["1,3,11,15"]=Jt,G["2,1,12,7"]=Rt,G["0,0,15,9"]=Qt,G["1,0,0,9"]=Qt,G["1,3,14,15"]=an};var j,H;j=(e=1,t=.05,n=220,a=0,s=0,o=.1,i=0,r=1,c=0,l=0,p=0,h=0,d=0,m=0,u=0,y=0,f=0,w=1,g=0,S=44100,b=99+a*S,I=s*S,k=o*S,x=g*S,v=f*S,C=2*Math.PI,M=(e=>0<e?1:-1),T=b+x+I+k+v,_=(c*=500*C/S**2),E=(n*=(1+2*t*Math.random()-t)*C/S),A=M(u)*C/4,$=0,P=0,O=0,F=0,G=0,L=0,j=1,Y=[],B=H.createBufferSource(),D=H.createBuffer(1,T,S))=>{for(B.connect(H.destination);O<T;Y[O++]=L)++G>100*y&&(G=0,L=$*n*Math.sin(P*u*C/S-A),L=M(L=i?1<i?2<i?3<i?Math.sin((L%C)**3):Math.max(Math.min(Math.tan(L),1),-1):1-(2*L/C%2+2)%2:1-4*Math.abs(Math.round(L/C)-L/C):Math.sin(L))*Math.abs(L)**r*e*.3*(O<b?O/b:O<b+x?1-(O-b)/x*(1-w):O<b+x+I?w:O<T-v?(T-O-v)/k*w:0),L=v?L/2+(v>O?0:(O<T-v?1:(O-T)/v)*Y[O-v|0]/2):L),$+=1-m+1e9*(Math.sin(O)+1)%2*m,P+=1-m+1e9*(Math.sin(O)**2+1)%2*m,n+=c+=500*l*C/S**3,j&&++j>h*S&&(n+=p*C/S,E+=p*C/S,j=0),d&&++F>d*S&&(n=E,c=_,F=1,j=j||1);return D.getChannelData(0).set(Y),B.buffer=D,B.start(),B},H=new AudioContext;const Y=0,B=1,D=2,U=3,z=0,R=1,X=2,N=3,W=4,q=1,V=(e,t)=>{e.facing=t},J=(e,t,n)=>{e.x=t,e.y=n},K=e=>[e.x,e.y],Q=(e,t,n)=>{e.vx=t,e.vy=n},Z=(e,t,n)=>{e.ax=t,e.ay=n},ee=(e,t)=>{e.anim=t},te=e=>t(e.x,e.y,e.w,e.h),ne=0,ae=1,se=2,oe=0,ie=1,re=2,ce=3,le=4,pe=5,he=6,de=7,me=["Strike","Charge","Break","Defend","Heal","Item","Flee"],ue=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,28*n+80]);return t},ye=ue(40),fe=ue(200),we=(e,t,n)=>{n=n||0;const a=Je(),s=[un(a/2-50,a-20*me.length,100,me,be,e.inv.filter(e=>!!e.onUse).length?[]:[pe],!0,20)],o=(e=>{const t=[];for(let n=0;n<e.length;n++){const{unit:a,name:s}=e[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,Dn(a),V(a.actor,B),t.push(a)}return Xn(t),t})(e.characters),i=(e=>{const t=[];for(let n=0;n<e.length;n++){const a=Qe(e[n]).unit;a.i=n,a.allegiance=1,V(a.actor,Y),Dn(a),t.push(a)}return t})(t.enemies),r={party:e,allies:o,enemies:i,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:(3,Math.floor(3*Math.random())+1),completionState:3};Ye(r,n);const c=Pe(o.concat(i));return Ae(r,c),r},ge=(e,t)=>0===t?ye[e]:fe[e],Se=async e=>new Promise(t=>{const n=e.enemies,[a,s]=ge(0,1),o=e.enemies.map((e,t)=>t).filter(t=>!Un(e.enemies[t])),i=un(2*a-Sa,2*s+ba/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},o,!1,56);i.i=-1,yn(i,1),e.actionMenuStack.unshift(i)}),be=async e=>{const t=xe(),n=$e(t);switch(e){case oe:{let e=await Se(t);e&&m(oe,n,e);break}case ie:m(ie,n,null);break;case ce:m(ce,n,null);break;case le:m(le,n,null);break;case pe:{const e=await(async e=>new Promise(t=>{const n={},a=e.party;let s=0;const o=a.inv.filter((e,t)=>(n[s]=t,s++,!!e.onUse)).map(e=>e.name),i=Je(),r=un(i/2-50,i-i/2,100,o,e=>{t(a.inv[n[e]])},[],!0,20);r.i=-1,yn(r,1),e.actionMenuStack.unshift(r)}))(t);e&&m(pe,n,null,e),t.actionMenuStack.shift();break}case re:{const e=await Se(t);e||m(re,n,e);break}case he:m(he,n,null);break;default:console.error("Action",e,"Is not implemented yet.")}};let Ie=null;const ke=e=>{Ie=e},xe=()=>Ie;let ve=!1;const Ce=e=>{ve=e},Me=()=>ve;let Te=()=>{};const _e=e=>{Te=e},Ee=()=>Te,Ae=(e,t)=>{e.rounds.push(t)},$e=e=>e.rounds[e.roundIndex],Pe=e=>({turnOrder:e,currentIndex:0}),Oe=e=>{e.currentIndex++},Fe=e=>{e.roundIndex++},Ge=e=>e.turnOrder[e.currentIndex]||null,Le=e=>null===Ge(e),je=e=>o(e.enemies)||o(e.allies)||3!==e.completionState,He=e=>me[e],Ye=(e,t)=>{if(0===t)return;const n=1===t?e.allies:e.enemies;for(let e=0;e<n.length;e++)n[e].cS.spd+=5};let Be=null,De=1,Ue=0;const ze=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},Re=()=>{var e;if(Be)return Be;{const[t,n]=ze(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Be=t,t}},Xe=()=>Re().getContext("2d"),Ne=e=>{De=e},We=()=>De,qe=e=>{Ue=e},Ve=()=>Ue,Je=()=>512,Ke=(e,t)=>{t.aText=e},Qe=(e,t)=>{const{sprI:n,spr:a,stats:s,label:o,action:i,col:r,plAi:c,name:l}=e,p={sprite:"actors",spriteIndex:n,facing:Y,anim:z,isGround:!1,disablePlatformCollision:!1,plAi:0,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return p.plAi=c||0,a&&(p.sprite=a),{name:t||l,actor:p,label:o||"",action:i,col:r,aText:"",unit:s?jn(l,p,e,0,0):void 0}};let Ze=!1,et=null;const tt=()=>Ze,nt=e=>{Ze=e},at=e=>et=e,st=1,ot=2,it=3,rt=4,ct=(e,t,n,a,s)=>({hp:e,dmg:t,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),lt={name:"Bomb",dsc:"It destroys all enemies!",onUse:async e=>{const t=xe();In(t.party,e),t.completionState=ne,ga("actionStrike")}},pt={name:"Statue's Legs",dsc:"Good for running."},ht={name:"Statue's Voice",dsc:"The sound a mouth makes.  Not the game show."},dt={name:"Statue's MIND",dsc:"Arguably necessary to have."},mt={name:"Radiant Stone",dsc:"A gleaming marble radiating shifting hues",onUse:()=>{}},ut={name:"",stats:{bS:ct(90,25,16,5,20),ai:0},sprI:0},yt=(ct(85,25,13,6,15),ct(80,19,18,4,6),ct(75,23,12,7,10),{name:"Golem",stats:{bS:ct(35,22,40,0,5),ai:ot},sprI:5}),ft={name:"Fairy",stats:{bS:ct(30,23,9,2,15),ai:st},sprI:4},wt={name:"Ape",stats:{bS:ct(20,40,5,0,15),ai:ot},sprI:6},gt={name:"Breaker",stats:{bS:ct(35,30,14,1,14),ai:it},sprI:7},St={name:"Old Guy",stats:{bS:ct(200,30,40,10,17),ai:rt},sprI:15},bt=Object.assign(Object.assign({},St),{name:"Old Guy (clone)"}),It={enemies:[ft,yt,ft,gt]},kt={enemies:[wt,wt,ft]},xt={enemies:[wt,ft,yt,yt]},vt={enemies:[gt,wt,yt]},Ct={enemies:[gt,wt,ft]},Mt={enemies:[ft,wt,wt,yt]},Tt={enemies:[St,bt]},_t={name:"Old Man",sprI:15,action:async e=>{T(e);const t="\n'Hello there.'\n'I see you've arrived with your wits about you.'\n'That's very good.  You'll need them.'\n'If you examine the statues in this cave, you'll notice that they're all...'\n'...missing something.'\n:)\n'It may be prudent for you to find what is not found and restore them.'\n  ".split("\n");await C(t),Ta()}},Et={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{_(e,pt,"The Runner.")}},At={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{_(e,dt,"The Thinker.")}},$t={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{_(e,ht,"The Speaker.")}},Pt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Probably nothing is in these pots.")},Ot={name:"Sign",spr:"terrain",sprI:5,action:()=>M("SPIKES are dangerous.")},Ft={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointless.")},Gt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointy.")},Lt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("(There is a picture of an arrow pointing upwards followed by a `?`)")},jt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("The SHRINE of LEGS.")},Ht={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Seek seek lest")},Yt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await C(e),Ta()}},Bt={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const e="\nThis pot seems different from the others!\nYou check the pot.\n...\nThere's nothing inside.\n  ".split("\n");await C(e),Ta()}},Dt={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ct(85,25,13,6,15),ai:0},action:async e=>{const t="\nThere's something strange about this pot...\nYou check the pot...\nThere's a man inside.\n'Hello! This pot is lovely, but you look more appealing.'\n'I'm coming with you!'\nThe Pot joins your party.\n  ".split("\n");await C(t),Ta();const n=Kn(),a=n.party,s=Zn(n);Tn(s,e),Sn(a,e)}},Ut={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ct(85,25,13,6,15),ai:ot},action:async e=>{const t="\nYou check the pot...\n  ".split("\n");await C(t),await A(ht,e),await C(["How did that get in there?"]),Ta()}},zt={name:"Jin",sprI:3,stats:{bS:ct(75,23,12,7,10),ai:0},action:async e=>{T(e);let t=[""];t=aa("talked_to_jin")?"\n'Hello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.'\n    ".split("\n"):"\n'Have you found my treasure yet?'\n      ".split("\n"),await C(t),Ta();const n=Kn(),{party:a}=n;if(kn(a,mt)){const t="\n'Excellent! I'll take that. Let's be on our way!'\n      ".split("\n");In(a,mt),Sn(a,e);const s=Zn(n);Tn(s,e),await C(t),Ta()}}},Rt={name:"",sprI:8,col:async e=>{await E(e,Mt,[lt])},plAi:q},Xt={name:"",sprI:8,col:async e=>{await E(e,xt,[lt])},plAi:q},Nt={name:"",sprI:8,col:async e=>{await E(e,It,[lt])},plAi:q},Wt={name:"",sprI:8,col:async e=>{await E(e,kt,[lt])},plAi:q},qt={name:"",sprI:8,col:async e=>{await E(e,vt,[lt])},plAi:q},Vt={name:"",sprI:8,col:async e=>{await E(e,Ct,[lt])},plAi:q},Jt={name:"",sprI:8,col:async e=>{await E(e,kt,[lt])},plAi:q},Kt={name:"",spr:"terrain",sprI:6,col:async()=>{const e=Kn();e.pause=!0,ga("spikes"),await r(1e3),e.pause=!1,ea(Kn())}},Qt={name:"",spr:"terrain",sprI:1},Zt={name:"Shining Stone",spr:"terrain",sprI:11,action:e=>A(mt,e)},en={name:"Item",spr:"terrain",sprI:11,action:e=>A(lt,e)},tn={name:"Orange",sprI:0,stats:{bS:ct(5,23,12,7,10),ai:ot},action:async e=>{T(e);const t="\n'I am the strongest man!'\n'Fight me and I will join you!'\n    ".split("\n"),n="\n'Wow, you are tough! Onward, then!'\nOrange has joined your party.\n    ".split("\n");await C(t),Ta();const a={enemies:[tn]},s=Kn();if((await E(e,a)).completionState===ne){Sn(s.party,e),await C(n),Ta();const t=e.unit;Hn(t.cS,t.bS,99)}}},nn={name:"Item",spr:"terrain",sprI:11,action:e=>A(pt,e)},an={name:"Item",spr:"terrain",sprI:11,action:e=>A(dt,e)},sn={},on="ArrowRight",rn="ArrowLeft",cn="ArrowDown",ln=" ",pn=e=>{if(1===e.length&&(e=e.toUpperCase()),!sn[e]){if(sn[e]=!0,"Q"===e&&(window.running=!1),tt())return;const t=xe();if(Me()&&t){const n=t.actionMenuStack[0];e===cn?yn(n,1):"ArrowUp"===e?yn(n,-1):"Enter"===e||"X"===e||e===ln?fn(n):"Escape"===e&&t.actionMenuStack.length>1&&wn(n)}else if("X"===e||"Enter"===e){const e=et;e&&e()}}};let hn=-1;const dn=e=>{if(1===e.length&&(e=e.toUpperCase()),e===cn){const e=Kn(),t=gn(e.party).actor;t.disablePlatformCollision&&(clearTimeout(hn),hn=setTimeout(()=>{t.disablePlatformCollision=!1},150))}sn[e]=!1},mn=e=>(1===e.length&&(e=e.toUpperCase()),sn[e]),un=(e,t,n,a,s,o,i,r)=>({x:e,y:t,w:n,h:(r=r||16)*a.length,i:0,cb:s,disabledItems:o,items:a,lineHeight:r,bg:!!i}),yn=(e,t,n)=>{const a=e.items.length;let s=0,o=0,i=e.i;do{if(s++,s>30)break;o=i+t,o<0?o=a-1:o>=a&&(o=0),i=o}while(e.disabledItems.includes(o));e.i=o,n||ga("menuMove")},fn=e=>{e.cb(e.i),ga("menuConfirm")},wn=e=>{e.cb(-1),ga("menuCancel")},gn=e=>e.characters[0],Sn=(e,t)=>{t.unit.ai=0,e.characters.push(t)},bn=(e,t)=>{const n=Object.assign({},t);e.inv.push(n),Ea(e.inv,!0)},In=(e,t)=>{const n=e.inv.indexOf(t);n>-1&&e.inv.splice(n,1),Ea(e.inv,!0)},kn=(e,t)=>{for(let n in e.inv){const{name:a}=e.inv[n];if(a===t.name)return e.inv[n]}return null},xn={0:[156,100,52],1:[171,82,54],2:[0,228,54],7:[255,241,232],15:[0,0,0]},vn={};for(let e in xn)vn[xn[e].join("")]=+e;const Cn=(e,t,n,a)=>{const s=[],o=[],[,i]=ze(16,16);ha(e,0,0,1,i);const{data:r}=i.getImageData(0,0,16,16);let c=0;for(let e=0;e<r.length;e+=4){let t=vn[`${r[e+0]}${r[e+1]}${r[e+2]}`]||0;const i=c%16,l=Math.floor(c/16);let p=null;const h=G[[n,a,i,l].join(",")];h&&(p=Qe(h)),p&&(J(p.actor,16*i,16*l-16),o.push(p)),s.push({id:t,x:i,y:l,px:16*i,py:16*l,size:16}),c++}return{tiles:s,characters:o,w:16,h:16,bgSprite:t}},Mn=e=>[16*e.w,16*e.h],Tn=(e,t)=>{const n=e.characters.indexOf(t);n>-1&&e.characters.splice(n,1)},_n=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),En=e=>[0,1,7].includes(e.id),An=(e,t,n,a,s)=>[e,t,n,a,s];let $n=null;const Pn=e=>{const[t,n,a,s]=ze(e.width,e.height),o=a/2,i=s/2;return n.translate(o,i),n.rotate(Math.PI/2),n.drawImage(e,-o,-i),t},On=e=>{const[t,n,a]=ze(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},Fn=e=>{const[,,,t,n]=e,[a,s]=ze(t,n);return ha(e,0,0,1,s),a},Gn=(e,t,n,a,s)=>{const o=(t,n,a,s,o,i)=>e[t]=An(n,a,s,o,i),i=(e,t,n)=>{let i=e;for(let e=0;e<n;e++)i=Pn(i);o(`${t}_r${n}`,i,0,0,a,s)},r=t.width/a,c=t.height/s;for(let e=0;e<c;e++)for(let c=0;c<r;c++){const l=`${n}_${e*r+c}`,p=o(l,t,c*a,e*s,a,s);i(Fn(p),l,1),i(Fn(p),l,2),i(Fn(p),l,3),o(l+"_f",On(Fn(p)),0,0,a,s),o(l+"_fr1",Pn(On(Fn(p))),0,0,a,s)}},Ln=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=Fn(An(t,0,0,64,64));Gn(e,n,"actors",16,16);const a=Fn(An(t,64,0,64,64));Gn(e,a,"terrain",16,16);const s=Fn(An(t,0,64,64,64));Gn(e,s,"map",16,16);const o=Fn(An(t,64,64,64,64));Gn(e,o,"monsters",16,16),$n=e},jn=(e,t,n,a,s)=>{const{stats:o}=n;if(!o)throw Error(`CharacterDef '${e}' has no stats!`);const i={name:e,actor:t,bS:Object.assign({},o.bS),cS:Object.assign({},o.bS),i:s,allegiance:a,ai:o.ai};return V(i.actor,i.allegiance?Y:B),Dn(i),i},Hn=(e,t,n)=>{const{hp:a}=e,{hp:s}=t;let o=a+n;o>s?o=s:o<0&&(o=0),e.hp=o},Yn=e=>{const{allegiance:t}=e,[n,a]=ge(e.i,t);J(e.actor,n+(t?-20:20),a)},Bn=e=>{const t=Je()/2/2-8;J(e.actor,t,t)},Dn=e=>{const[t,n]=ge(e.i,e.allegiance);J(e.actor,t,n)},Un=e=>e.cS.hp>0,zn=e=>{e.cS.iCnt++},Rn=e=>{e.cS.def=e.bS.def},Xn=e=>{for(let t=0;t<e.length;t++)0===e[t].cS.hp&&(e[t].cS.hp=1)},Nn=(e,t)=>{const{cS:n}=e;switch(t){case oe:n.spd+=0;break;case ie:n.spd-=2;break;case re:n.spd-=1;break;case ce:n.spd+=3;break;case le:n.spd-=1;break;case pe:case he:n.spd-=2}};let Wn=null;const qn={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},Vn=()=>{const e={characters:[Qe(ut,"Runner")],inv:[],worldX:0,worldY:0},t=gn(e);J(t.actor,128,180);const n={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)n.rooms.push(Cn("map_"+e,qn[e],e%4,Math.floor(e/4)));return n},Jn=e=>{Wn=e},Kn=()=>Wn,Qn=(e,t,n)=>{((e,t,n)=>{n.roomI=4*t+e})((n.roomI%4+e+4)%4,(Math.floor(n.roomI/4)+t+4)%4,n);const a=Zn(n),s=gn(n.party).actor,[o,i]=Mn(a);let r=0,c=0;e>0&&(r=0,c=s.y),e<0&&(r=o-16,c=s.y),t>0&&(r=s.x,c=0),t<0&&(r=s.x,c=i-16),J(s,r,c),n.lastX=r,n.lastY=c},Zn=e=>e.rooms[e.roomI],ea=e=>{const t=gn(e.party);J(t.actor,e.lastX,e.lastY)},ta=(e,t)=>{Kn().state[e]=t},na=e=>Kn().state[e],aa=e=>void 0===na(e)&&(ta(e,!0),!0),sa="#000",oa={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},ia={},ra=()=>{const e=Re();pa(0,0,e.width,e.height,"#557","#aaf")},ca=(e,t,n,a,s,o,i)=>{(i=i||Xe()).lineWidth=1,i[o?"strokeStyle":"fillStyle"]=s,i[o?"strokeRect":"fillRect"](e,t,n,a)},la=(e,t,n,a,s)=>{const{font:o,size:i,color:r,align:c,strokeColor:l}=Object.assign(Object.assign({},oa),a||{});(s=s||Xe()).font=`${i}px ${o}`,s.fillStyle=r,s.textAlign=c,s.textBaseline="middle",s.fillText(e,t,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(e,t,n))},pa=(e,t,n,a,s,o)=>{const i=Xe(),r=`${e},${t},${n},${a},${s},${o}`;if(!ia[r]){const e=i.createLinearGradient(0,a,0,0);e.addColorStop(0,s),e.addColorStop(1,o),ia[r]=e}i.fillStyle=ia[r],i.fillRect(e,t,n,a)},ha=(e,t,n,a,s)=>{a=a||1,s=s||Xe();const[o,i,r,c,l]="string"==typeof e?$n[e]:e;s.drawImage(o,i,r,c,l,t,n,c*a,l*a)},da=(e,t,n)=>{n=n||1;const{x:a,y:s}=e,o=a*n,i=s*n,[r,l,p]=((e,t)=>{let{facing:n,sprite:a,spriteIndex:s,anim:o}=e,i=o,r=s<3,l=0;t||(o===R?i-=c(1,100):o===N?r?i=2-c(1,250):(i=0,l=2*c(1,100)):o===W&&(i=r?2:0));let p="";switch(n){case 0:p="_f";break;case 2:p="_r3";break;case 3:p="_fr1"}return[a+"_"+(s+i+p),0,l]})(e,t);ha(r,o+l,i+p,n)},ma=(e,t,n,a)=>{const s=Kn(),o=a||1;e.tiles.forEach(s=>{const{id:i,x:r,y:c,size:l}=s,p=(t+r*l)*o,h=(n+c*l)*o;ha(e.bgSprite,p,h,a),15!=i&&ha("terrain_"+i,p,h,a)}),e.characters.forEach(e=>{const t=e.actor;da(t,s.pause,a);const{x:n,y:i}=t,r=e.aText;r&&la(r,n*o+16*o/2,i*o-16*o/2,{size:16,align:"center"})})},ua=e=>{ra();const t=Ge($e(e));Ia(5,15,150,20),la("Turn: "+(null==t?void 0:t.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=e,o=s[0];for(let e=0;e<n.length;e++){const[t,a]=K(n[e].actor);J(n[e].actor,t,a),da(n[e].actor,!1,2),la(""+n[e].name,2*t+16,2*a-5,{align:"center"})}va(e,0),va(e,1);for(let e=0;e<a.length;e++){const[t,n]=K(a[e].actor);da(a[e].actor,!1,2),la(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}Me()&&ka(o),e.text&&xa(e.text),Ca(e)};let ya=null;const fa=(e,t,n)=>{e[t]=n},wa=()=>{const e={};fa(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),fa(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),fa(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),fa(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),fa(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),fa(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),fa(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),fa(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),fa(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),fa(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),fa(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),fa(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),fa(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),ya=e},ga=e=>{j(...ya[e])},Sa=16,ba=16,Ia=(e,t,n,a,s)=>{ca(e,t,n,a,s=s||sa),ca(e,t,n,a,"#FFF",!0)},ka=e=>{const{x:t,y:n,w:a,h:s,i:o,bg:i,items:r,lineHeight:c}=e;i&&Ia(t,n,a,s),r.forEach((s,o)=>{let i="#FFF";e.disabledItems.includes(o)&&(i="#999"),la(s,t+a/2,n+o*c+c/2,{align:"center",color:i})}),((e,t)=>{const n=Xe(),a=ba,s=Sa;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+c*o)},xa=e=>{const t=Je();Ia(0,90,t,50),la(e,Je()/2,116,{align:"center",size:20})},va=(e,t)=>{const n=Je(),a=1===t?n-200:0,s=n-90;Ia(a,s,200,90),((e,t)=>{const n=t-25;Ia(0,n,200,25),la("Unit",10,n+12.5),la("HP",70,n+12.5),la("Chg",117,n+12.5),la("Brk/Hl",150,n+12.5)})(0,s);const o=1===t?e.enemies:e.allies;for(let e=0;e<o.length;e++){const n=o[e],{name:i,bS:r,cS:c}=n;0===t?(la(i.slice(0,8),a+10,s+15+20*e),la(`${c.hp}/${r.hp}`,a+70,s+15+20*e),la(""+c.cCnt,a+125,s+15+20*e),la(""+c.iCnt,a+168,s+15+20*e)):la(i.slice(0,8),a+100,s+15+20*e,{align:"center"})}},Ca=e=>{const{turnOrder:t}=$e(e),n=t.length,a=35*n;let s=Je()-Je()/3-a/2;Ia(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:o}=t[a],{sprite:r,spriteIndex:c}=o,l=10+($e(e).currentIndex===a?20:10);Ia(s,l,30,40,i(e,t[a])?"#29ADFF":"#FF004D");const p=i(e,t[a])?l-5:l+40+8;la(n.slice(0,5),s+15,p,{size:12,align:"center",strokeColor:"#FFF"}),ha(`${r}_${c}`,s,l+5,2)}};let Ma=null,Ta=()=>{const e=document.getElementById("dialogBox");window.removeEventListener("keypress",Ma),e.style.opacity="0",e.style.width="0",nt(!1)};const _a=(e,t)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",Ma),n.innerHTML=`<div style="width:476px">${e}</div>`,n.style.opacity="1",n.style.width="512px",Ma=e=>{const n=e.key.length>1?e.key:e.key.toUpperCase();n!==ln&&"X"!==n&&"Enter"!==n||(window.removeEventListener("keypress",Ma),t())},setTimeout(()=>{window.addEventListener("keypress",Ma)},25),nt(!0)},Ea=(e,t)=>{const n=document.getElementById("itemBox");n.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){const a=document.createElement("span");a.innerHTML=e[t].name+(t<e.length-1?",":""),a.className="item",n.appendChild(a)}n.style.display=t?"flex":"none"}})();