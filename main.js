(()=>{window.running=!0,window.addEventListener("load",async()=>{await Me(),je(),(()=>{const e=a();o(e);const t=performance.now();let n=t;const c=a=>{Le(e);const o=(a-n)/16.666;re(o>2?2:o),se(a-t),n=a,window.running&&requestAnimationFrame(c)};c(t)})()});const e=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),t=(e,t)=>e.allies.includes(t),n=async e=>new Promise(t=>{setTimeout(t,e)}),a=()=>{const e=Ie("Jimothy",100,10,5,5,5,0,F),t=Ie("Seph",100,10,5,5,5,1,F),n=Ie("Karst",100,10,5,5,5,0,P),a=Ie("Urien",100,10,5,5,5,1,P),o=_([e,t],[n,a]),c=N([e,n,t,a]);return J(o,c),L(o),j(!1),o},o=async e=>{for(;!Y(e);)await c(e);setTimeout(()=>{a()},2e3)},c=async e=>{const t=K(e);for(i(t);!X(t);)await r(e,t),Q(t);const n=l(t);J(e,n),V(e)},r=async(e,n)=>{const a=W(n);if(Fe(a))return a.cS.def!==a.bS.def&&Pe(a),new Promise(o=>{z(o);const c=e.actionMenuStack[0];t(e,a)?(c.disabledItems=a.cS.iCnt<=0?[2,4]:[],c.i=-1,me(c,1),j(!0)):setTimeout(()=>{const t=(a=e.allies)[Math.floor(Math.random()*a.length)];var a;s(C,n,t)},1e3)});n.nextTurnOrder.push(a)},s=async(e,a,o)=>{j(!1);const c=R(),r=W(a);switch($e(r),M(r.actor,x),c.text=Z(e),await n(1e3),e){case C:const n=d(r,o);if(c.text="Did "+-n+" damage. It's somewhat effective.",!Fe(o)){const e=t(c,o)?w:p;b(o.actor,e)}break;case I:u(r);break;case v:f(r);break;case $:h(r);break;default:console.error("No action:",e,"exists.")}a.nextTurnOrder.push(r),await n(2e3),Te(r),M(r.actor,S),c.text="",await n(500),G()()},i=e=>{},l=e=>N(e.nextTurnOrder),d=(e,t)=>{const{cS:n,bS:a}=t,{def:o}=n,{dmg:c}=e.bS,r=-Math.floor(Math.max(c-o,1));return ve(n,a,r),r},u=e=>{const{cS:t}=e;t.cCnt++},h=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},f=e=>{const{cS:t}=e;t.def*=1.5};var m,g;window.addEventListener("keydown",e=>{if(ue(e.key),"q"===e.key&&(window.running=!1),B()){const t=R(),n=e.key,a=t.actionMenuStack[0];"ArrowDown"===n?(me(a,1),Be("menuMove")):"ArrowUp"===n?(me(a,-1),Be("menuMove")):"Enter"===n?(ge(a),Be("menuConfirm")):"Escape"===n&&t.actionMenuStack.length>1&&(Be("menuCancel"),we(a))}}),window.addEventListener("keyup",e=>{he(e.key)}),m=(e=1,t=.05,n=220,a=0,o=0,c=.1,r=0,s=1,i=0,l=0,d=0,u=0,h=0,f=0,m=0,w=0,p=0,S=1,x=0,b=44100,y=99+a*b,k=o*b,M=c*b,C=x*b,I=p*b,v=2*Math.PI,$=(e=>0<e?1:-1),T=y+C+k+M+I,F=(i*=500*v/b**2),P=(n*=(1+2*t*Math.random()-t)*v/b),E=$(m)*v/4,O=0,_=0,A=0,D=0,H=0,L=0,R=1,U=[],j=g.createBufferSource(),B=g.createBuffer(1,T,b))=>{for(j.connect(g.destination);A<T;U[A++]=L)++H>100*w&&(H=0,L=O*n*Math.sin(_*m*v/b-E),L=$(L=r?1<r?2<r?3<r?Math.sin((L%v)**3):Math.max(Math.min(Math.tan(L),1),-1):1-(2*L/v%2+2)%2:1-4*Math.abs(Math.round(L/v)-L/v):Math.sin(L))*Math.abs(L)**s*e*.3*(A<y?A/y:A<y+C?1-(A-y)/C*(1-S):A<y+C+k?S:A<T-I?(T-A-I)/M*S:0),L=I?L/2+(I>A?0:(A<T-I?1:(A-T)/I)*U[A-I|0]/2):L),O+=1-f+1e9*(Math.sin(A)+1)%2*f,_+=1-f+1e9*(Math.sin(A)**2+1)%2*f,n+=i+=500*l*v/b**3,R&&++R>u*b&&(n+=d*v/b,P+=d*v/b,R=0),h&&++D>h*b&&(n=P,i=F,D=1,R=R||1);return B.getChannelData(0).set(U),j.buffer=B,j.start(),j},g=new AudioContext;const w=2,p=3,S=0,x=3,b=(e,t)=>{e.facing=t},y=(e,t,n)=>{e.x=t,e.y=n},k=e=>[e.x,e.y],M=(e,t)=>{e.anim=t},C=0,I=1,v=3,$=4,T=["Strike","Charge","Interrupt","Defend","Heal","Use","Flee"],F=0,P=1,E=[[40,70],[40,100],[40,130],[40,160]],O=[[200,70],[200,100],[200,130],[200,160]],_=(e,t)=>{const n=le();return{allies:e,enemies:t,rounds:[],roundIndex:0,actionMenuStack:[fe(n/2-50,n-20*T.length,100,T,D,[],!0,20)],text:""}},A=(e,t)=>t===F?E[e]:O[e],D=async e=>{const t=R(),n=K(t);switch(e){case C:const a=await(async e=>new Promise(t=>{const n=e.enemies,[a,o]=A(0,P),c=fe(2*a-qe,2*o-16,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},e.enemies.filter(e=>!Fe(e)).map((e,t)=>t),!1,60);c.i=-1,me(c,1),e.actionMenuStack.unshift(c)}))(t);if(!a)return;Be("actionStrike"),s(C,n,a);break;case I:Be("actionCharge"),s(I,n,null);break;case v:Be("actionDefend"),s(v,n,null);break;case $:s($,n,null);break;default:console.error("Action",e,"Is not implemented yet.")}};let H=null;const L=e=>{H=e},R=()=>H;let U=!1;const j=e=>{U=e},B=()=>U;let q=()=>{};const z=e=>{q=e},G=()=>q,J=(e,t)=>{e.rounds.push(t)},K=e=>e.rounds[e.roundIndex],N=e=>({turnOrder:e,nextTurnOrder:[],currentIndex:0}),Q=e=>{e.currentIndex++},V=e=>{e.roundIndex++},W=e=>e.turnOrder[e.currentIndex]||null,X=e=>null===W(e),Y=t=>e(t.enemies)||e(t.allies),Z=e=>T[e];let ee=null,te=1,ne=0;const ae=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},oe=()=>{if(ee)return ee;{const[e,t]=ae(512,512);return e.id="canv",t.imageSmoothingEnabled=!1,document.body.appendChild(e),ee=e,e}},ce=()=>oe().getContext("2d"),re=e=>{te=e},se=e=>{ne=e},ie=()=>ne,le=()=>512,de={},ue=e=>{de[e]||(de[e]=!0)},he=e=>{de[e]=!1},fe=(e,t,n,a,o,c,r,s)=>({x:e,y:t,w:n,h:(s=s||16)*a.length,i:0,cb:o,disabledItems:c,items:a,lineHeight:s,bg:!!r}),me=(e,t)=>{const n=e.items.length;let a=0,o=0,c=e.i;do{if(a++,a>30)break;o=c+t,o<0?o=n-1:o>=n&&(o=0),c=o}while(e.disabledItems.includes(o));e.i=o},ge=e=>{e.cb(e.i)},we=e=>{e.cb(-1)},pe=(e,t,n,a,o)=>[e,t,n,a,o];let Se=null;const xe=e=>{const[t,n,a,o]=ae(e.width,e.height),c=a/2,r=o/2;return n.translate(c,r),n.rotate(Math.PI/2),n.drawImage(e,-c,-r),t},be=e=>{const[t,n,a]=ae(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},ye=e=>{const[,,,t,n]=e,[a,o]=ae(t,n);return De(e,0,0,1,o),a},ke=(e,t,n,a,o)=>{const c=(t,n,a,o,c,r)=>e[t]=pe(n,a,o,c,r),r=(e,t,n)=>{let r=e;for(let e=0;e<n;e++)r=xe(r);c(`${t}_r${n}`,r,0,0,a,o)},s=t.width/a,i=t.height/o;for(let e=0;e<i;e++)for(let i=0;i<s;i++){const l=`${n}_${e*s+i}`,d=c(l,t,i*a,e*o,a,o);r(ye(d),l,1),r(ye(d),l,2),r(ye(d),l,3),c(l+"_f",be(ye(d)),0,0,a,o),c(l+"_fr1",xe(be(ye(d))),0,0,a,o)}},Me=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=ye(pe(t,0,0,64,64));ke(e,n,"actors",16,16);const a=ye(pe(t,64,0,64,64));ke(e,a,"terrain",16,16);const o=ye(pe(t,0,64,64,64));ke(e,o,"map",16,16),Se=e},Ce=(e,t,n,a,o)=>({hp:e,dmg:t,def:n,mag:a,spd:o,iCnt:a,cCnt:0}),Ie=(e,t,n,a,o,c,r,s,i)=>{b(i=i||{sprite:"actors",spriteIndex:0,facing:0,anim:S,isGround:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16},s?0:1);const l={name:e,bS:Ce(t,n,a,o,c),cS:Ce(t,n,a,o,c),actor:i,i:r,allegiance:s};return Te(l),l},ve=(e,t,n)=>{const{hp:a}=e,{hp:o}=t;let c=a+n;c>o?c=o:c<0&&(c=0),e.hp=c},$e=e=>{const{allegiance:t}=e,[n,a]=A(e.i,t);y(e.actor,n+(t?-50:50),a)},Te=e=>{const[t,n]=A(e.i,e.allegiance);y(e.actor,t,n)},Fe=e=>e.cS.hp>0,Pe=e=>{e.cS.def=e.bS.def},Ee={font:"monospace",color:"#fff",size:14,align:"left"},Oe={},_e=(e,t,n,a,o,c,r)=>{(r=r||ce())[c?"strokeStyle":"fillStyle"]=o,r[c?"strokeRect":"fillRect"](e,t,n,a)},Ae=(e,t,n,a,o)=>{const{font:c,size:r,color:s,align:i}=Object.assign(Object.assign({},Ee),a||{});(o=o||ce()).font=`${r}px ${c}`,o.fillStyle=s,o.textAlign=i,o.textBaseline="middle",o.fillText(e,t,n)},De=(e,t,n,a,o)=>{a=a||1,o=o||ce();const[c,r,s,i,l]="string"==typeof e?Se[e]:e;o.drawImage(c,r,s,i,l,t,n,i*a,l*a)},He=(e,t)=>{t=t||1;const{x:n,y:a}=e,o=n*t,c=a*t,r=(e=>{let{facing:t,sprite:n,spriteIndex:a,anim:o}=e;1===o?o-=Math.floor(ie()%200/100):o===x&&(o=2-Math.floor(ie()%500/250));let c="";switch(t){case 0:c="_f";break;case 2:c="_r3";break;case 3:c="_fr1"}return n+"_"+(a+o+c)})(e);De(r,o,c,t)},Le=e=>{(()=>{const e=oe();((e,t,n,a,o,c)=>{const r=ce(),s=`0,0,${n},${a},#557,#aaf`;if(!Oe[s]){const e=r.createLinearGradient(0,a,0,0);e.addColorStop(0,"#557"),e.addColorStop(1,"#aaf"),Oe[s]=e}r.fillStyle=Oe[s],r.fillRect(0,0,n,a)})(0,0,e.width,e.height)})(),Ae("Round: "+(e.roundIndex+1),10,40);const t=W(K(e));Ae("Turn: "+(null==t?void 0:t.name),10,60);const{allies:n,enemies:a,actionMenuStack:o}=e,c=o[0];for(let e=0;e<n.length;e++){const[t,a]=k(n[e].actor);y(n[e].actor,t,a),He(n[e].actor,2),Ae(""+n[e].name,2*t+16,2*a-5,{align:"center"})}Ke(e,F),Ke(e,P);for(let e=0;e<a.length;e++){const[t,n]=k(a[e].actor);He(a[e].actor,2),Ae(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}B()&&Ge(c),e.text&&Je(e.text)};let Re=null;const Ue=(e,t,n)=>{e[t]=n},je=()=>{const e={};Ue(e,"menuMove",[,,1964,,,.08,1,2.14,,,462,.01,,,,,,,.02]),Ue(e,"menuConfirm",[,,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),Ue(e,"menuCancel",[,,484,.04,,.08,3,.12,74,,57,.2,,,-8.8,,,,.02]),Ue(e,"menuCancel",[,,889,,,.09,,1.47,3.7,,16,.12,-.01,,-7,.1,,.74,.01]),Ue(e,"jump",[,,223,.01,.1,.22,1,1.35,.1,,,,,.4,,,,.55,.09]),Ue(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),Ue(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),Ue(e,"actionCharge",[,,978,.06,.47,.82,,1.45,9.6,,23,.03,.1,,,.1,,.92,.08]),Ue(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),Re=e},Be=e=>{m(...Re[e])},qe=16,ze=(e,t,n,a)=>{_e(e,t,n,a,"#000"),_e(e,t,n,a,"#FFF",!0)},Ge=e=>{const{x:t,y:n,w:a,h:o,i:c,bg:r,items:s,lineHeight:i}=e;r&&ze(t,n,a,o),s.forEach((o,c)=>{let r="#FFF";e.disabledItems.includes(c)&&(r="#999"),Ae(o,t+a/2,n+c*i+i/2,{align:"center",color:r})}),((e,t)=>{const n=ce(),a=qe;n.save(),n.translate(e-qe/2,t-8),n.beginPath(),n.moveTo(0,0),n.lineTo(0,16),n.lineTo(a,8),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t-qe,n+c*i+i/2)},Je=e=>{const t=le();ze(0,0,t,30),Ae(e,le()/2,16,{align:"center"})},Ke=(e,t)=>{const n=le(),a=t===P?n-200:0,o=n-90;ze(a,o,200,90),((e,t)=>{le();const n=t-25;ze(0,n,200,25),Ae("Unit",10,n+12.5),Ae("HP",80,n+12.5),Ae("Chg",140,n+12.5),Ae("Int",170,n+12.5)})(0,o);const c=t===P?e.enemies:e.allies;for(let e=0;e<c.length;e++){const n=c[e],{name:r,bS:s,cS:i}=n;t===F?(Ae(r.slice(0,8),a+10,o+15+20*e),Ae(`${i.hp}/${s.hp}`,a+80,o+15+20*e),Ae(""+i.cCnt,a+145,o+15+20*e),Ae(""+i.iCnt,a+175,o+15+20*e)):Ae(r.slice(0,8),a+100,o+15+20*e,{align:"center"})}}})();