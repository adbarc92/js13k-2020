(()=>{window.running=!0,window.addEventListener("load",async()=>{await An(),ha(),L(),(async()=>{const e=zn();Rn(e),window.world=e,na(0,0,qe(),qe(),Qn);const t="\n  Press X to continue...\n  ".split("\n");await v(t),Ia();const n=e.party,a=performance.now();let s=a;const r=t=>{const o=(t-s)/18;Re(o>2?2:o),Ne(t-a),s=t,ta();const i=Ie();if(i)ca(i);else{const t=Wn(e),a=mn(n).actor;$(e),ia(t,0,0,2),oa(a,e.pause,2)}window.running&&requestAnimationFrame(r)};r(a)})()});const e=e=>Math.abs(e)/e,t=(e,t,n,a)=>[e,t,e+n,t+a],n=(e,t)=>[e,t],a=(e,t)=>e.map((e,n)=>((e,t)=>{const[n,a]=e,[s,r,o,i]=t;return n>s&&n<o&&a>r&&a<i})(e,t)?n:-1).filter(e=>e>-1),s=e=>{const[t,a,s,r]=e,o=s-t,i=t+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(t+o/4,c),n(s-o/4,c)]},r=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),o=(e,t)=>e.allies.includes(t),i=async e=>new Promise(t=>{setTimeout(t,e)}),c=(e,t)=>Math.floor(We()%((e+1)*t)/t),l=e=>{let t=e[0];for(let n=0;n<e.length;n++)e[n].cS.hp<t.cS.hp&&(t=e[n]);return t},p=async e=>{const t=_e(e);for(u(t);!Oe(t);)await h(e,t),$e(t);const n=y(t);Ee(e,n),Pe(e)},h=async(e,t)=>{const n=Fe(t);if(Hn(n)&&!Le(e)){if(n.cS.def!==n.bS.def&&Gn(n),0!==n.cS.spd)return Fn(n),new Promise(a=>{Me(a);const s=e.actionMenuStack[0];o(e,n)?(n.cS.iCnt<=0?s.disabledItems.push(2,4):s.disabledItems=s.disabledItems.filter(e=>2!==e&&4!==e),s.i=-1,ln(s,1,!0),xe(!0)):setTimeout(()=>{((e,t,n)=>{const a=l(e.allies),{roundIndex:s,aiSeed:r}=e;switch(n.ai){case nt:n.cS.cCnt<n.cS.iCnt?(m(se,t,null),((e,t)=>{e.text=t.cS.cCnt/t.cS.iCnt<.2?t.name+" begins to glow ominously.":t.name+" shines threateningly."})(e,n)):m(ae,t,a);break;case at:m(ae,t,a);break;case st:m(s%(r+2)==0?re:ae,t,a);break;case rt:let o,i=l(e.allies);s%(r+2)==0?n.cS.iCnt<2?(o=pe,m(o,t,null)):(o=re,i=l(e.allies),m(o,t,i)):(o=n.cS.cCnt<2?se:ae,m(o,t,i))}})(e,t,n)},1e3)});n.cS.spd=n.bS.spd}},m=async(e,t,n,a)=>{xe(!1);const s=Ie(),r=Fe(t);switch(On(r),Z(r.actor,X),s.text=He(e),await i(1e3),Dn(r,e),e){case ae:const t=f(r,n);if(s.text="Did "+-t+" damage.",ma("actionStrike"),Z(n.actor,N),await i(800),Z(n.actor,Y),!Hn(n)){const e=o(s,n)?D:U;q(n.actor,e)}break;case se:g(r),ma("actionCharge");break;case oe:b(r),ma("actionDefend");break;case ie:S(r);break;case re:w(r,n);break;case le:I();break;case pe:s.text="Powers replenished.",k(r);break;case ce:a&&a.onUse&&a.onUse(a);break;default:console.error("No action:",e,"exists.")}await i(1250),Ln(r),Z(r.actor,Y),s.text="",await i(500),Te()(),d(t)&&Bn(r)},d=e=>{const{turnOrder:t}=e;let n=!1;for(let e=0;e<t.length;e++)Hn(t[e])||(t.splice(e,1),n=!0);return n},u=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},y=e=>Ae(e.turnOrder),f=(e,t)=>{const{cS:n,bS:a}=t,{def:s}=n,{dmg:r}=e.bS,{cCnt:o}=e.cS,i=-Math.floor(Math.max((o>0?r*(o+1):r)-s,1));return e.cS.cCnt=0,Pn(n,a,i),i},g=e=>{const{cS:t}=e;t.cCnt++},w=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},S=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},b=e=>{const{cS:t}=e;t.def*=1.5},I=()=>{Ie().completionState=ne},k=e=>{e.cS.iCnt=e.bS.mag};window.addEventListener("keydown",e=>{Ze()||an(e.key)}),window.addEventListener("keyup",e=>{rn(e.key)});const x=async(e,t)=>(t||ma("cutscene"),new Promise(t=>{ka(e,t)})),v=async(e,t)=>{ma(t||"menuConfirm"),x("",!0);const n=Xn();n.pause=!0,await i(250);for(let t=0;t<e.length;t++){const n=e[t].trim();n&&await x(n)}ma("menuCancel"),n.pause=!1},C=async e=>{const t=(e=>[`This sign says: "${e}"`])(e);await v(t),Ia()},M=e=>{const t=Xn(),n=mn(t.party),a=e.actor;q(a,n.actor.x<a.x?G:j)},T=async(e,t,n)=>{let a=[""];const s=Xn().party,r=fn(s,t),o=t.name+"_fixed";Jn(o)?a=["You have fixed this statue."]:r?(await v(`\nYou place the '${r.name}' inside the statue.\n...\nSomething awakens inside it.\n`.split("\n")),yn(s,r),await i(150),ma("item"),e.actor.spriteIndex=12,await i(2e3),a=["You have fixed the statue!"],Vn(o,!0)):a=`\nThere's a plaque beneath this statue.\nIt says, "${n}"\nThis statue appears to be missing a something...\n`.split("\n"),await v(a),Ia()},E=async(e,t,n)=>{const a=Xn();a.pause=!0;const s=a.party,r=mn(a.party),[o,i]=J(r.actor),c=ye(s,t);await(async e=>new Promise(async t=>{for(be(e),xe(!1);!Le(e);)await p(e);be(null),t()}))(c);const l=Wn(a);if(In(l,e),V(r.actor,o,i),K(r.actor,0,0),c.completionState===te){if(n)for(let e in n)await _(n[e])}else if(c.completionState===ne)for(let e=0;e<s.characters.length;e++)s.characters[e].unit.cS.spd-=3;else await v(["Game Over"]),window.location.reload();a.pause=!1},_=async(e,t)=>{const n=Xn(),{name:a,dsc:s}=e,r=["You acquired: "+a,s];n.pause=!0,await v(r,"item"),Ia();const o=Wn(n);t&&In(o,t),un(n.party,e)},A=(e,t)=>{const n=e[t];n<0?e[t]+=1.2:n>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},$=e=>{if(e.pause)return;const t=Wn(e),{characters:n}=t;n.forEach(e=>{F(e.actor,t)}),P(e.party,t,e)},P=(e,t,n)=>{const r=mn(e).actor,{ax:o,ay:i,isGround:c}=r;Z(r,Y),tt(null);let l=o,p=i;const h=c?1.2:.04;on(en)&&(l=-h,q(r,G),Z(r,z)),on(Zt)&&(l=h,q(r,j),Z(r,z)),on(nn)&&r.isGround&&(ma("jump"),p=-5.6,r.vy=0,r.isGround=!1),on(tn)&&(r.disablePlatformCollision=!0),r.isGround||Z(r,R),Q(r,l,p);const[m,d]=F(r,t);(m||d)&&Nn(m,d,n);const u=s(ee(r));for(let e in t.characters){const n=t.characters[e],s=n.actor;Ve("",n);const r=ee(s);let o=!1;a(u,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&Ve(i,n),tt(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},F=(n,r)=>{if(n.plAi===W){const{ax:e}=n;let t=e;Z(n,Y),n.facing===G?(Z(n,z),t=-.5):(Z(n,z),t=.5),Q(n,t,0)}(e=>{const t=Xe();e.ay+=e.isGround?1e-4*t:.185})(n);let o=0,i=0;const c=Xe();let{x:l,y:p,vx:h,vy:m,ax:d,ay:u,w:y,h:f}=n,g=h+d*c,w=m+u*c;Math.abs(g)>1.2&&(g=1.2*e(g)),Math.abs(w)>3.6&&(w=3.6*e(w)),K(n,g,w);let S=l+h*c,b=p+m*c;const[I,k]=bn(r);return S<0?(S=0,o=-1):S+y>I&&(S=I-y,o=1),b<0?(b=0,i=-1):b+f>k&&(b=k-f,i=1),V(n,S,b),((e,n)=>{let r,o,i=!1,c=0;const l=kn(n);do{c++,r=!1,o=!1;const n=s(t(e.x,e.y,e.w,e.h)),p={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=t(s.px,s.py,s.size,s.size);xn(s)?a(n,i).forEach(e=>{r=!0,p[e]=s}):(e.y+e.h/2<s.py||e.plAi===W)&&a(n,i).forEach(t=>{0!==t||e.disablePlatformCollision||(o=!0,r=!0,p[t]=s),2===t&&e.plAi===W&&(r=!0,p[t]=s),3===t&&e.plAi===W&&(r=!0,p[t]=s)})});const h=p[1],m=p[2],d=p[3],u=1;p[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),i=!0):h&&(o||(e.y+=u,e.vy=0)),m?(e.x+=u,e.plAi===W&&q(e,j)):d&&(e.x-=u,e.plAi===W&&q(e,G))}while(r&&c<10);i===e.isGround||i||(e.vy=0),e.isGround=i})(n,r),0===d&&A(n,"vx"),0===u&&A(n,"vy"),Q(n,0,0),[o,i]},O={},L=()=>{O["1,1,13,15"]=xt,O["1,1,11,11"]=Ct,O["1,1,4,9"]=vt,O["1,1,5,13"]=Mt,O["0,1,9,15"]=Tt,O["0,1,7,11"]=Ot,O["0,1,9,11"]=Ot,O["0,1,11,11"]=Ot,O["0,1,13,11"]=Ot,O["0,1,8,7"]=Ot,O["0,1,10,7"]=Ot,O["0,1,12,7"]=Ot,O["0,1,14,7"]=Ht,O["0,1,7,3"]=Ot,O["0,1,9,3"]=Ot,O["0,1,11,3"]=Ot,O["0,1,13,3"]=Lt,O["2,2,2,15"]=Bt,O["2,2,2,12"]=Xt,O["2,2,1,12"]=Xt,O["2,1,5,15"]=Xt,O["2,1,3,15"]=Xt,O["2,1,4,15"]=Xt,O["2,1,3,13"]=Xt,O["2,1,9,9"]=Xt,O["2,1,1,15"]=Et,O["2,1,8,5"]=Xt,O["2,1,10,15"]=Xt,O["2,0,2,2"]=_t,O["3,0,2,3"]=At,O["3,0,4,10"]=Xt,O["3,0,11,14"]=Xt,O["3,1,2,7"]=Xt,O["3,0,1,14"]=Xt,O["3,0,14,7"]=Xt,O["3,1,12,7"]=Xt,O["3,1,3,14"]=Xt,O["3,2,1,5"]=Xt,O["3,1,14,10"]=Xt,O["3,1,9,12"]=Xt,O["3,1,6,12"]=Xt,O["3,2,2,8"]=Xt,O["3,2,11,6"]=Xt,O["3,2,11,12"]=Xt,O["3,0,7,3"]=Xt,O["3,2,14,12"]=Xt,O["3,3,3,15"]=Xt,O["3,3,14,7"]=Xt,O["3,0,7,9"]=Xt,O["3,1,4,5"]=Xt,O["3,2,4,7"]=Xt,O["3,2,7,7"]=Xt,O["3,2,5,7"]=Xt,O["3,2,5,13"]=Xt,O["3,3,8,5"]=Xt,O["3,3,7,5"]=Xt,O["3,1,7,12"]=Xt,O["3,1,6,4"]=Xt,O["3,3,8,15"]=$t,O["3,3,1,3"]=qt,O["0,3,3,15"]=Xt,O["0,3,3,11"]=Xt,O["0,3,8,4"]=Xt,O["0,3,5,3"]=Xt,O["0,3,11,10"]=Xt,O["0,3,12,6"]=Xt,O["0,3,14,12"]=Xt,O["0,3,7,15"]=Xt,O["0,3,1,6"]=Xt,O["0,0,11,5"]=Xt,O["0,0,12,15"]=Xt,O["0,0,7,5"]=Xt,O["0,0,6,15"]=Xt,O["0,0,3,5"]=Xt,O["0,0,3,15"]=Xt,O["0,0,9,15"]=Xt,O["0,0,4,9"]=Xt,O["0,0,6,9"]=Xt,O["0,0,8,9"]=Xt,O["0,0,10,9"]=Xt,O["0,0,12,9"]=Xt,O["1,0,9,14"]=Jt,O["1,0,2,15"]=Pt,O["1,0,9,8"]=qt,O["2,0,3,9"]=Nt,O["2,0,4,9"]=Nt,O["2,0,5,9"]=Nt,O["2,0,6,8"]=Nt,O["2,0,2,8"]=Nt,O["2,0,8,9"]=qt,O["0,2,4,15"]=qt,O["1,1,8,8"]=Vt,O["2,2,2,3"]=Wt,O["2,2,3,12"]=Xt,O["2,2,11,3"]=qt,O["2,3,9,15"]=Xt,O["2,3,8,15"]=Xt,O["2,3,7,15"]=Xt,O["2,3,6,15"]=Xt,O["2,3,5,15"]=Xt,O["2,3,4,15"]=Xt,O["2,3,3,15"]=Xt,O["2,3,2,15"]=Xt,O["2,3,10,15"]=Xt,O["2,3,11,15"]=Xt,O["2,3,12,15"]=Xt,O["2,3,13,15"]=Xt,O["2,3,1,15"]=Xt,O["1,3,10,10"]=Ft,O["2,3,15,12"]=Nt,O["3,3,0,12"]=Nt,O["2,2,11,7"]=jt,O["2,2,5,4"]=Dt,O["1,3,2,15"]=Ut,O["1,3,7,15"]=Yt,O["1,3,9,15"]=zt,O["1,3,11,15"]=Rt,O["2,1,12,7"]=Gt,O["0,0,15,9"]=Nt,O["1,0,0,9"]=Nt,O["1,3,14,15"]=Kt};var H,B;H=(e=1,t=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,p=0,h=0,m=0,d=0,u=0,y=0,f=0,g=1,w=0,S=44100,b=99+a*S,I=s*S,k=r*S,x=w*S,v=f*S,C=2*Math.PI,M=(e=>0<e?1:-1),T=b+x+I+k+v,E=(c*=500*C/S**2),_=(n*=(1+2*t*Math.random()-t)*C/S),A=M(u)*C/4,$=0,P=0,F=0,O=0,L=0,H=0,G=1,j=[],D=B.createBufferSource(),U=B.createBuffer(1,T,S))=>{for(D.connect(B.destination);F<T;j[F++]=H)++L>100*y&&(L=0,H=$*n*Math.sin(P*u*C/S-A),H=M(H=o?1<o?2<o?3<o?Math.sin((H%C)**3):Math.max(Math.min(Math.tan(H),1),-1):1-(2*H/C%2+2)%2:1-4*Math.abs(Math.round(H/C)-H/C):Math.sin(H))*Math.abs(H)**i*e*.3*(F<b?F/b:F<b+x?1-(F-b)/x*(1-g):F<b+x+I?g:F<T-v?(T-F-v)/k*g:0),H=v?H/2+(v>F?0:(F<T-v?1:(F-T)/v)*j[F-v|0]/2):H),$+=1-d+1e9*(Math.sin(F)+1)%2*d,P+=1-d+1e9*(Math.sin(F)**2+1)%2*d,n+=c+=500*l*C/S**3,G&&++G>h*S&&(n+=p*C/S,_+=p*C/S,G=0),m&&++O>m*S&&(n=_,c=E,O=1,G=G||1);return U.getChannelData(0).set(j),D.buffer=U,D.start(),D},B=new AudioContext;const G=0,j=1,D=2,U=3,Y=0,z=1,R=2,X=3,N=4,W=1,q=(e,t)=>{e.facing=t},V=(e,t,n)=>{e.x=t,e.y=n},J=e=>[e.x,e.y],K=(e,t,n)=>{e.vx=t,e.vy=n},Q=(e,t,n)=>{e.ax=t,e.ay=n},Z=(e,t)=>{e.anim=t},ee=e=>t(e.x,e.y,e.w,e.h),te=0,ne=2,ae=0,se=1,re=2,oe=3,ie=4,ce=5,le=6,pe=7,he=["Strike","Charge","Break","Defend","Heal","Item","Flee"],me=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,28*n+80]);return t},de=me(40),ue=me(200),ye=(e,t,n)=>{n=n||0;const a=qe(),s=[cn(a/2-50,a-20*he.length,100,he,we,e.inv.filter(e=>!!e.onUse).length?[]:[ce],!0,20)],r=(e=>{const t=[];for(let n=0;n<e.length;n++){const{unit:a,name:s}=e[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,Ln(a),q(a.actor,j),t.push(a)}return jn(t),t})(e.characters),o=(e=>{const t=[];for(let n=0;n<e.length;n++){const a=Je(e[n]).unit;a.i=n,a.allegiance=1,q(a.actor,G),Ln(a),t.push(a)}return t})(t.enemies),i={party:e,allies:r,enemies:o,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:(3,Math.floor(3*Math.random())+1),completionState:3};Be(i,n);const c=Ae(r.concat(o));return Ee(i,c),i},fe=(e,t)=>0===t?de[e]:ue[e],ge=async e=>new Promise(t=>{const n=e.enemies,[a,s]=fe(0,1),r=e.enemies.map((e,t)=>t).filter(t=>!Hn(e.enemies[t])),o=cn(2*a-da,2*s+ua/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},r,!1,56);o.i=-1,ln(o,1),e.actionMenuStack.unshift(o)}),we=async e=>{const t=Ie(),n=_e(t);switch(e){case ae:{let e=await ge(t);e&&m(ae,n,e);break}case se:m(se,n,null);break;case oe:m(oe,n,null);break;case ie:m(ie,n,null);break;case ce:{const e=await(async e=>new Promise(t=>{const n={},a=e.party;let s=0;const r=a.inv.filter((e,t)=>(n[s]=t,s++,!!e.onUse)).map(e=>e.name),o=qe(),i=cn(o/2-50,o-o/2,100,r,e=>{t(a.inv[n[e]])},[],!0,20);i.i=-1,ln(i,1),e.actionMenuStack.unshift(i)}))(t);e&&m(ce,n,null,e),t.actionMenuStack.shift();break}case re:{const e=await ge(t);e||m(re,n,e);break}case le:m(le,n,null);break;default:console.error("Action",e,"Is not implemented yet.")}};let Se=null;const be=e=>{Se=e},Ie=()=>Se;let ke=!1;const xe=e=>{ke=e},ve=()=>ke;let Ce=()=>{};const Me=e=>{Ce=e},Te=()=>Ce,Ee=(e,t)=>{e.rounds.push(t)},_e=e=>e.rounds[e.roundIndex],Ae=e=>({turnOrder:e,currentIndex:0}),$e=e=>{e.currentIndex++},Pe=e=>{e.roundIndex++},Fe=e=>e.turnOrder[e.currentIndex]||null,Oe=e=>null===Fe(e),Le=e=>r(e.enemies)||r(e.allies)||3!==e.completionState,He=e=>he[e],Be=(e,t)=>{if(0===t)return;const n=1===t?e.allies:e.enemies;for(let e=0;e<n.length;e++)n[e].cS.spd+=5};let Ge=null,je=1,De=0;const Ue=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},Ye=()=>{var e;if(Ge)return Ge;{const[t,n]=Ue(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Ge=t,t}},ze=()=>Ye().getContext("2d"),Re=e=>{je=e},Xe=()=>je,Ne=e=>{De=e},We=()=>De,qe=()=>512,Ve=(e,t)=>{t.aText=e},Je=(e,t)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,plAi:c,name:l}=e,p={sprite:"actors",spriteIndex:n,facing:G,anim:Y,isGround:!1,disablePlatformCollision:!1,plAi:0,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return p.plAi=c||0,a&&(p.sprite=a),{name:t||l,actor:p,label:r||"",action:o,col:i,aText:"",unit:s?$n(l,p,e,0,0):void 0}};let Ke=!1,Qe=null;const Ze=()=>Ke,et=e=>{Ke=e},tt=e=>Qe=e,nt=1,at=2,st=3,rt=4,ot=(e,t,n,a,s)=>({hp:e,dmg:t,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),it={name:"Bomb",dsc:"It destroys all enemies!",onUse:async e=>{const t=Ie();yn(t.party,e),t.completionState=te,ma("actionStrike")}},ct={name:"Statue's Legs",dsc:"Good for running."},lt={name:"Statue's Voice",dsc:"The sound a mouth makes.  Not the game show."},pt={name:"Statue's MIND",dsc:"Arguably necessary to have."},ht={name:"Radiant Stone",dsc:"A gleaming marble radiating shifting hues",onUse:()=>{}},mt={name:"",stats:{bS:ot(90,25,16,5,20),ai:0},sprI:0},dt=(ot(85,25,13,6,15),ot(80,19,18,4,6),ot(75,23,12,7,10),{name:"Golem",stats:{bS:ot(35,22,40,0,5),ai:at},sprI:5}),ut={name:"Fairy",stats:{bS:ot(30,23,9,2,15),ai:nt},sprI:4},yt={name:"Ape",stats:{bS:ot(20,40,5,0,15),ai:at},sprI:6},ft={name:"Breaker",stats:{bS:ot(35,30,14,1,14),ai:st},sprI:7},gt=(ot(200,30,40,10,17),{enemies:[ut,dt,ut,ft]}),wt={enemies:[yt,yt,ut]},St={enemies:[yt,ut,dt,dt]},bt={enemies:[ft,yt,dt]},It={enemies:[ft,yt,ut]},kt={enemies:[ut,yt,yt,dt]},xt={name:"Old Man",sprI:15,action:async e=>{M(e);const t="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\n:)\nIt may be prudent for you to find what is not found and restore them.\n  ".split("\n");await v(t),Ia()}},vt={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{T(e,ct,"The Runner.")}},Ct={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{T(e,pt,"The Thinker.")}},Mt={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{T(e,lt,"The Speaker.")}},Tt={name:"Sign",spr:"terrain",sprI:5,action:()=>C("Probably nothing is in these pots.")},Et={name:"Sign",spr:"terrain",sprI:5,action:()=>C("SPIKES are dangerous.")},_t={name:"Sign",spr:"terrain",sprI:5,action:()=>C("This fall is pointless.")},At={name:"Sign",spr:"terrain",sprI:5,action:()=>C("This fall is pointy.")},$t={name:"Sign",spr:"terrain",sprI:5,action:()=>C("(There is a picture of an arrow pointing upwards followed by a `?`)")},Pt={name:"Sign",spr:"terrain",sprI:5,action:()=>C("The SHRINE of LEGS.")},Ft={name:"Sign",spr:"terrain",sprI:5,action:()=>C("Seek seek lest")},Ot={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await v(e),Ia()}},Lt={name:"Pot!",spr:"terrain",sprI:4,stats:{bS:ot(85,25,13,6,15),ai:0},action:async e=>{const t="\nThere's something strange about this pot...\nYou check the pot...\nThere's a man inside.\n'Hello!' He says. 'This pot is lovely, but you look more appealing.'\n'I'm coming with you!'\nThe pot joins your party.\n  ".split("\n");await v(t),Ia();const n=Xn();dn(n.party,e)}},Ht={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ot(85,25,13,6,15),ai:at},action:async e=>{const t="\nYou check the pot...\n  ".split("\n");await v(t),await _(lt,e),await v(["How did that get in there?"]),Ia()}},Bt={name:"Jin",sprI:3,stats:{bS:ot(75,23,12,7,10),ai:0},action:async e=>{M(e);let t=[""];t=Kn("talked_to_jin")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\n      ".split("\n"),await v(t),Ia();const{party:n}=Xn();if(fn(n,ht)){const t="\n      Excellent! I'll take that. Let's be on our way!\n      ".split("\n");yn(n,ht),dn(n,e),await v(t),Ia()}}},Gt={name:"",sprI:8,col:async e=>{await E(e,kt,[it])},plAi:W},jt={name:"",sprI:8,col:async e=>{await E(e,St,[it])},plAi:W},Dt={name:"",sprI:8,col:async e=>{await E(e,gt,[it])},plAi:W},Ut={name:"",sprI:8,col:async e=>{await E(e,wt,[it])},plAi:W},Yt={name:"",sprI:8,col:async e=>{await E(e,bt,[it])},plAi:W},zt={name:"",sprI:8,col:async e=>{await E(e,It,[it])},plAi:W},Rt={name:"",sprI:8,col:async e=>{await E(e,wt,[it])},plAi:W},Xt={name:"",spr:"terrain",sprI:6,col:async()=>{const e=Xn();e.pause=!0,ma("spikes"),await i(1e3),e.pause=!1,qn(Xn())}},Nt={name:"",spr:"terrain",sprI:1},Wt={name:"Shining Stone",spr:"terrain",sprI:11,action:e=>_(ht,e)},qt={name:"Item",spr:"terrain",sprI:11,action:e=>_(it,e)},Vt={name:"Orange",sprI:0,stats:{bS:ot(75,23,12,7,10),ai:at},action:async e=>{M(e);const t="\nI am the strongest man!\nFight me and I will join you!\n    ".split("\n"),n="\n    Onward, then!\n    ".split("\n");await v(t),Ia();const a={enemies:[Vt]};await E(e,a);const s=Xn();dn(s.party,e),await v(n),Ia()}},Jt={name:"Item",spr:"terrain",sprI:11,action:e=>_(ct,e)},Kt={name:"Item",spr:"terrain",sprI:11,action:e=>_(pt,e)},Qt={},Zt="ArrowRight",en="ArrowLeft",tn="ArrowDown",nn=" ",an=e=>{if(1===e.length&&(e=e.toUpperCase()),!Qt[e]){if(Qt[e]=!0,"Q"===e&&(window.running=!1),Ze())return;const t=Ie();if(ve()&&t){const n=t.actionMenuStack[0];e===tn?ln(n,1):"ArrowUp"===e?ln(n,-1):"Enter"===e||"X"===e||e===nn?pn(n):"Escape"===e&&t.actionMenuStack.length>1&&hn(n)}else if("X"===e||"Enter"===e){const e=Qe;e&&e()}}};let sn=-1;const rn=e=>{if(1===e.length&&(e=e.toUpperCase()),e===tn){const e=Xn(),t=mn(e.party).actor;t.disablePlatformCollision&&(clearTimeout(sn),sn=setTimeout(()=>{t.disablePlatformCollision=!1},150))}Qt[e]=!1},on=e=>(1===e.length&&(e=e.toUpperCase()),Qt[e]),cn=(e,t,n,a,s,r,o,i)=>({x:e,y:t,w:n,h:(i=i||16)*a.length,i:0,cb:s,disabledItems:r,items:a,lineHeight:i,bg:!!o}),ln=(e,t,n)=>{const a=e.items.length;let s=0,r=0,o=e.i;do{if(s++,s>30)break;r=o+t,r<0?r=a-1:r>=a&&(r=0),o=r}while(e.disabledItems.includes(r));e.i=r,n||ma("menuMove")},pn=e=>{e.cb(e.i),ma("menuConfirm")},hn=e=>{e.cb(-1),ma("menuCancel")},mn=e=>e.characters[0],dn=(e,t)=>{t.unit.ai=0,e.characters.push(t)},un=(e,t)=>{const n=Object.assign({},t);e.inv.push(n),xa(e.inv,!0)},yn=(e,t)=>{const n=e.inv.indexOf(t);n>-1&&e.inv.splice(n,1),xa(e.inv,!0)},fn=(e,t)=>{for(let n in e.inv){const{name:a}=e.inv[n];if(a===t.name)return e.inv[n]}return null},gn={0:[156,100,52],1:[171,82,54],2:[0,228,54],7:[255,241,232],15:[0,0,0]},wn={};for(let e in gn)wn[gn[e].join("")]=+e;const Sn=(e,t,n,a)=>{const s=[],r=[],[,o]=Ue(16,16);ra(e,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let e=0;e<i.length;e+=4){let t=wn[`${i[e+0]}${i[e+1]}${i[e+2]}`]||0;const o=c%16,l=Math.floor(c/16);let p=null;const h=O[[n,a,o,l].join(",")];h&&(p=Je(h)),p&&(V(p.actor,16*o,16*l-16),r.push(p)),s.push({id:t,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:t}},bn=e=>[16*e.w,16*e.h],In=(e,t)=>{const n=e.characters.indexOf(t);n>-1&&e.characters.splice(n,1)},kn=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),xn=e=>[0,1,7].includes(e.id),vn=(e,t,n,a,s)=>[e,t,n,a,s];let Cn=null;const Mn=e=>{const[t,n,a,s]=Ue(e.width,e.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(e,-r,-o),t},Tn=e=>{const[t,n,a]=Ue(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},En=e=>{const[,,,t,n]=e,[a,s]=Ue(t,n);return ra(e,0,0,1,s),a},_n=(e,t,n,a,s)=>{const r=(t,n,a,s,r,o)=>e[t]=vn(n,a,s,r,o),o=(e,t,n)=>{let o=e;for(let e=0;e<n;e++)o=Mn(o);r(`${t}_r${n}`,o,0,0,a,s)},i=t.width/a,c=t.height/s;for(let e=0;e<c;e++)for(let c=0;c<i;c++){const l=`${n}_${e*i+c}`,p=r(l,t,c*a,e*s,a,s);o(En(p),l,1),o(En(p),l,2),o(En(p),l,3),r(l+"_f",Tn(En(p)),0,0,a,s),r(l+"_fr1",Mn(Tn(En(p))),0,0,a,s)}},An=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=En(vn(t,0,0,64,64));_n(e,n,"actors",16,16);const a=En(vn(t,64,0,64,64));_n(e,a,"terrain",16,16);const s=En(vn(t,0,64,64,64));_n(e,s,"map",16,16);const r=En(vn(t,64,64,64,64));_n(e,r,"monsters",16,16),Cn=e},$n=(e,t,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${e}' has no stats!`);const o={name:e,actor:t,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return q(o.actor,o.allegiance?G:j),Ln(o),o},Pn=(e,t,n)=>{const{hp:a}=e,{hp:s}=t;let r=a+n;r>s?r=s:r<0&&(r=0),e.hp=r},Fn=e=>{const{allegiance:t}=e,[n,a]=fe(e.i,t);V(e.actor,n+(t?-20:20),a)},On=e=>{const t=qe()/2/2-8;V(e.actor,t,t)},Ln=e=>{const[t,n]=fe(e.i,e.allegiance);V(e.actor,t,n)},Hn=e=>e.cS.hp>0,Bn=e=>{e.cS.iCnt++},Gn=e=>{e.cS.def=e.bS.def},jn=e=>{for(let t=0;t<e.length;t++)0===e[t].cS.hp&&(e[t].cS.hp=1)},Dn=(e,t)=>{const{cS:n}=e;switch(t){case ae:n.spd+=0;break;case se:n.spd-=2;break;case re:n.spd-=1;break;case oe:n.spd+=3;break;case ie:n.spd-=1;break;case ce:case le:n.spd-=2}};let Un=null;const Yn={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},zn=()=>{const e={characters:[Je(mt,"Runner")],inv:[],worldX:0,worldY:0},t=mn(e);V(t.actor,128,180);const n={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)n.rooms.push(Sn("map_"+e,Yn[e],e%4,Math.floor(e/4)));return n},Rn=e=>{Un=e},Xn=()=>Un,Nn=(e,t,n)=>{((e,t,n)=>{n.roomI=4*t+e})((n.roomI%4+e+4)%4,(Math.floor(n.roomI/4)+t+4)%4,n);const a=Wn(n),s=mn(n.party).actor,[r,o]=bn(a);let i=0,c=0;e>0&&(i=0,c=s.y),e<0&&(i=r-16,c=s.y),t>0&&(i=s.x,c=0),t<0&&(i=s.x,c=o-16),V(s,i,c),n.lastX=i,n.lastY=c},Wn=e=>e.rooms[e.roomI],qn=e=>{const t=mn(e.party);V(t.actor,e.lastX,e.lastY)},Vn=(e,t)=>{Xn().state[e]=t},Jn=e=>Xn().state[e],Kn=e=>void 0===Jn(e)&&(Vn(e,!0),!0),Qn="#000",Zn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},ea={},ta=()=>{const e=Ye();sa(0,0,e.width,e.height,"#557","#aaf")},na=(e,t,n,a,s,r,o)=>{(o=o||ze()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](e,t,n,a)},aa=(e,t,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},Zn),a||{});(s=s||ze()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(e,t,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(e,t,n))},sa=(e,t,n,a,s,r)=>{const o=ze(),i=`${e},${t},${n},${a},${s},${r}`;if(!ea[i]){const e=o.createLinearGradient(0,a,0,0);e.addColorStop(0,s),e.addColorStop(1,r),ea[i]=e}o.fillStyle=ea[i],o.fillRect(e,t,n,a)},ra=(e,t,n,a,s)=>{a=a||1,s=s||ze();const[r,o,i,c,l]="string"==typeof e?Cn[e]:e;s.drawImage(r,o,i,c,l,t,n,c*a,l*a)},oa=(e,t,n)=>{n=n||1;const{x:a,y:s}=e,r=a*n,o=s*n,[i,l,p]=((e,t)=>{let{facing:n,sprite:a,spriteIndex:s,anim:r}=e,o=r,i=s<3,l=0;t||(r===z?o-=c(1,100):r===X?i?o=2-c(1,250):(o=0,l=2*c(1,100)):r===N&&(o=i?2:0));let p="";switch(n){case 0:p="_f";break;case 2:p="_r3";break;case 3:p="_fr1"}return[a+"_"+(s+o+p),0,l]})(e,t);ra(i,r+l,o+p,n)},ia=(e,t,n,a)=>{const s=Xn(),r=a||1;e.tiles.forEach(s=>{const{id:o,x:i,y:c,size:l}=s,p=(t+i*l)*r,h=(n+c*l)*r;ra(e.bgSprite,p,h,a),15!=o&&ra("terrain_"+o,p,h,a)}),e.characters.forEach(e=>{const t=e.actor;oa(t,s.pause,a);const{x:n,y:o}=t,i=e.aText;i&&aa(i,n*r+16*r/2,o*r-16*r/2,{size:16,align:"center"})})},ca=e=>{ta();const t=Fe(_e(e));ya(5,15,150,20),aa("Turn: "+(null==t?void 0:t.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=e,r=s[0];for(let e=0;e<n.length;e++){const[t,a]=J(n[e].actor);V(n[e].actor,t,a),oa(n[e].actor,!1,2),aa(""+n[e].name,2*t+16,2*a-5,{align:"center"})}wa(e,0),wa(e,1);for(let e=0;e<a.length;e++){const[t,n]=J(a[e].actor);oa(a[e].actor,!1,2),aa(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}ve()&&fa(r),e.text&&ga(e.text),Sa(e)};let la=null;const pa=(e,t,n)=>{e[t]=n},ha=()=>{const e={};pa(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),pa(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),pa(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),pa(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),pa(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),pa(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),pa(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),pa(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),pa(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),pa(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),pa(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),pa(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),pa(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),la=e},ma=e=>{H(...la[e])},da=16,ua=16,ya=(e,t,n,a,s)=>{na(e,t,n,a,s=s||Qn),na(e,t,n,a,"#FFF",!0)},fa=e=>{const{x:t,y:n,w:a,h:s,i:r,bg:o,items:i,lineHeight:c}=e;o&&ya(t,n,a,s),i.forEach((s,r)=>{let o="#FFF";e.disabledItems.includes(r)&&(o="#999"),aa(s,t+a/2,n+r*c+c/2,{align:"center",color:o})}),((e,t)=>{const n=ze(),a=ua,s=da;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+c*r)},ga=e=>{const t=qe();ya(0,90,t,50),aa(e,qe()/2,116,{align:"center",size:20})},wa=(e,t)=>{const n=qe(),a=1===t?n-200:0,s=n-90;ya(a,s,200,90),((e,t)=>{const n=t-25;ya(0,n,200,25),aa("Unit",10,n+12.5),aa("HP",70,n+12.5),aa("Chg",117,n+12.5),aa("Brk/Hl",150,n+12.5)})(0,s);const r=1===t?e.enemies:e.allies;for(let e=0;e<r.length;e++){const n=r[e],{name:o,bS:i,cS:c}=n;0===t?(aa(o.slice(0,8),a+10,s+15+20*e),aa(`${c.hp}/${i.hp}`,a+70,s+15+20*e),aa(""+c.cCnt,a+125,s+15+20*e),aa(""+c.iCnt,a+168,s+15+20*e)):aa(o.slice(0,8),a+100,s+15+20*e,{align:"center"})}},Sa=e=>{const{turnOrder:t}=_e(e),n=t.length,a=35*n;let s=qe()-qe()/3-a/2;ya(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:r}=t[a],{sprite:i,spriteIndex:c}=r,l=10+(_e(e).currentIndex===a?20:10);ya(s,l,30,40,o(e,t[a])?"#29ADFF":"#FF004D");const p=o(e,t[a])?l-5:l+40+8;aa(n.slice(0,5),s+15,p,{size:12,align:"center",strokeColor:"#FFF"}),ra(`${i}_${c}`,s,l+5,2)}};let ba=null,Ia=()=>{const e=document.getElementById("dialogBox");window.removeEventListener("keypress",ba),e.style.opacity="0",e.style.width="0",et(!1)};const ka=(e,t)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",ba),n.innerHTML=`<div style="width:476px">${e}</div>`,n.style.opacity="1",n.style.width="512px",ba=e=>{const n=e.key.length>1?e.key:e.key.toUpperCase();n!==nn&&"X"!==n&&"Enter"!==n||(window.removeEventListener("keypress",ba),t())},setTimeout(()=>{window.addEventListener("keypress",ba)},25),et(!0)},xa=(e,t)=>{const n=document.getElementById("itemBox");n.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){const a=document.createElement("span");a.innerHTML=e[t].name+(t<e.length-1?",":""),a.className="item",n.appendChild(a)}n.style.display=t?"flex":"none"}})();