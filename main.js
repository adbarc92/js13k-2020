(()=>{window.running=!0,window.addEventListener("load",async()=>{await Ga(),wn(),L(),(async()=>{let e=qa();Va(e),window.world=e,on(0,0,Je(),Je(),nn);let t="\n  Press X to continue...\n  ".split("\n");await C(t),Tn();let a=e.party,n=performance.now(),r=n,i=t=>{let l=(t-r)/18;Ne(l>2?2:l),qe(t-n),r=t,sn();let s=xe();if(s)mn(s);else{let t=Qa(e),n=wa(a).actor;O(e),un(t,0,0,2),hn(n,e.pause,2)}window.running&&requestAnimationFrame(i)};i(n)})()});let e=e=>Math.abs(e)/e,t=(e,t,a,n)=>[e,t,e+a,t+n],a=(e,t)=>[e,t],n=(e,t)=>e.map((e,a)=>((e,t)=>{let[a,n]=e,[r,i,l,s]=t;return a>r&&a<l&&n>i&&n<s})(e,t)?a:-1).filter(e=>e>-1),r=e=>{let[t,n,r,i]=e,l=r-t,s=t+l/2,o=n+(i-n)/2;return[a(s,i),a(s,n),a(t+l/4,o),a(r-l/4,o)]},i=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),l=(e,t)=>e.allies.includes(t),s=async e=>new Promise(t=>{setTimeout(t,e)}),o=(e,t)=>Math.floor(Ve()%((e+1)*t)/t),c=e=>{let t=e[0];for(let a=0;a<e.length;a++)e[a].cS.hp<t.cS.hp&&(t=e[a]);return t},p=async e=>new Promise(async t=>{for(ke(e),Ce(!1);!Ye(e);)await d(e);e.completionState=i(e.allies)?ne:i(e.enemies)?ae:re,ke(null),t()}),d=async e=>{let t=$e(e);for(y(t);!Le(t);)await h(e,t),Pe(t);let a=f(t);Ee(e,a),Fe(e)},h=async(e,t)=>{let a=Ge(t);if(Ua(a)&&!Ye(e)){if(a.cS.def!==a.bS.def&&za(a),0!==a.cS.spd)return Ha(a),new Promise(n=>{_e(n);let r=e.actionMenuStack[0];l(e,a)?(a.cS.iCnt<=0?r.disabledItems.push(2,4):r.disabledItems=r.disabledItems.filter(e=>2!==e&&4!==e),r.i=-1,ma(r,1,!0),Ce(!0)):setTimeout(()=>{((e,t,a)=>{let n=c(e.allies),{roundIndex:r,aiSeed:i}=e;switch(a.ai){case rt:a.cS.cCnt<a.cS.iCnt?u(le,t,null):u(ie,t,n);break;case it:u(ie,t,n);break;case lt:u(r%(i+2)==0?se:ie,t,n);break;case st:let l,s=c(e.allies);r%(i+2)==0?a.cS.iCnt<2?(l=he,u(l,t,null)):(l=se,s=c(e.allies),u(l,t,s)):(l=a.cS.cCnt<2?le:ie,u(l,t,s))}})(e,t,a)},1e3)});a.cS.spd=a.bS.spd}},u=async(e,t,a,n)=>{Ce(!1);let r=xe(),i=Ge(t);switch(ja(i),ee(i.actor,N),r.text=He(e),await s(1e3),Xa(i,e),e){case ie:let t=w(i,a);if(r.text="Did "+-t+" damage.",gn("actionStrike"),ee(a.actor,W),await s(800),ee(a.actor,z),!Ua(a)){let e=l(r,a)?U:D;V(a.actor,e)}break;case le:g(i),gn("actionCharge");break;case oe:b(i),gn("actionDefend");break;case ce:I(i);break;case se:S(i,a);break;case de:k();break;case he:r.text="Powers replenished.",x(i);break;case pe:n&&n.onUse&&n.onUse(n);break;default:console.error("No action:",e,"exists.")}await s(1250),Ba(i),ee(i.actor,z),r.text="",await s(500),Ae()(),m(t)&&Da(i)},m=e=>{let{turnOrder:t}=e,a=!1;for(let e=0;e<t.length;e++)Ua(t[e])||(t.splice(e,1),a=!0);return a},y=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},f=e=>Oe(e.turnOrder),w=(e,t)=>{let{cS:a,bS:n}=t,{def:r}=a,{dmg:i}=e.bS,{cCnt:l}=e.cS,s=-Math.floor(Math.max((l>0?i*(l+1):i)-r,1));return e.cS.cCnt=0,Ya(a,n,s),s},g=e=>{let{cS:t}=e;t.cCnt++},S=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},I=e=>{let{cS:t,bS:a}=e;t.iCnt--,t.hp=a.hp},b=e=>{let{cS:t}=e;t.def*=1.5},k=()=>{xe().completionState=re},x=e=>{e.cS.iCnt=e.bS.mag};window.addEventListener("keydown",e=>{tt()||ca(e.key)}),window.addEventListener("keyup",e=>{da(e.key)});let v=async(e,t)=>(t||gn("cutscene"),new Promise(t=>{_n(e,t)})),C=async(e,t)=>{gn(t||"menuConfirm"),v("",!0);let a=Ja();a.pause=!0,await s(250);for(let t=0;t<e.length;t++){let a=e[t].trim();a&&await v(a)}gn("menuCancel"),a.pause=!1},M=async e=>{let t=(e=>[`SIGN: "${e}"`])(e);await C(t),Tn()},T=e=>{let t=Ja(),a=wa(t.party),n=e.actor;V(n,a.actor.x<n.x?j:B)},_=async(e,t,a)=>{let n=[""],r=Ja().party,i=ba(r,t),l=t.name+"_fixed";if(tn(l)?n=["You have fixed this statue."]:i?(await C(`\nYou place the '${i.name}' inside the statue.\n...\nIt awakens.\n`.split("\n")),Ia(r,i),await s(150),gn("item"),e.actor.spriteIndex=12,await s(2e3),n=["You have fixed the statue!"],en(l,!0)):n=`\nA plaque says: "${a}"\nThis statue is missing a something...\n`.split("\n"),await C(n),Tn(),tn(pt+"_fixed")&&tn(dt+"_fixed")&&tn(ht+"_fixed")){let e="\n'Mwahaha'\n'You've done it!'\n'Now I shall rule over this world!'".split("\n");await C(e),Tn();let t=we(r,Tt);return await p(t),void(t.completionState===ae?(await C(["Y THO"]),Tn(),window.location.reload()):(await C(["Game Over"]),window.location.reload()))}},A=async(e,t,a)=>{let n=Ja();n.pause=!0;let r=n.party,i=wa(n.party),[l,s]=K(i.actor),o=we(r,t);await p(o);let c=Qa(n);if(Ma(c,e),J(i.actor,l,s),Q(i.actor,0,0),o.completionState===ae){if(a)for(let e in a)await E(a[e])}else if(o.completionState===re)for(let e=0;e<r.characters.length;e++)r.characters[e].unit.cS.spd-=3;else await C(["Game Over"]),window.location.reload();return n.pause=!1,o},E=async(e,t)=>{let a=Ja(),{name:n,dsc:r}=e,i=["You got: "+n,r];a.pause=!0,await C(i,"item"),Tn();let l=Qa(a);t&&Ma(l,t),Sa(a.party,e)},$=(e,t)=>{let a=e[t];a<0?e[t]+=1.2:a>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},O=e=>{if(e.pause)return;let t=Qa(e),{characters:a}=t;a.forEach(e=>{F(e.actor,t)}),P(e.party,t,e)},P=(e,t,a)=>{let i=wa(e).actor,{ax:l,ay:s,isGround:o}=i;ee(i,z),nt(null);let c=l,p=s,d=o?1.2:.04;ha(la)&&(c=-d,V(i,j),ee(i,R)),ha(ia)&&(c=d,V(i,B),ee(i,R)),ha(oa)&&i.isGround&&(gn("jump"),p=-5.6,i.vy=0,i.isGround=!1),ha(sa)&&(i.dpCol=!0),i.isGround||ee(i,X),Z(i,c,p);let[h,u]=F(i,t);(h||u)&&Ka(h,u,a);let m=r(te(i));for(let e in t.characters){let a=t.characters[e],r=a.actor;Ke("",a);let i=te(r),l=!1;n(m,i).forEach(()=>{l=!0});let s=a.label||a.name;l&&(s&&Ke(s,a),nt(()=>{a.action&&a.action(a)}),a.col&&a.col(a))}},F=(a,i)=>{if(a.plAi===q){let{ax:e}=a,t=e;ee(a,z),a.facing===j?(ee(a,R),t=-.5):(ee(a,R),t=.5),Z(a,t,0)}(e=>{let t=We();e.ay+=e.isGround?1e-4*t:.185})(a);let l=0,s=0,o=We(),{x:c,y:p,vx:d,vy:h,ax:u,ay:m,w:y,h:f}=a,w=d+u*o,g=h+m*o;Math.abs(w)>1.2&&(w=1.2*e(w)),Math.abs(g)>3.6&&(g=3.6*e(g)),Q(a,w,g);let S=c+d*o,I=p+h*o,[b,k]=Ca(i);return S<0?(S=0,l=-1):S+y>b&&(S=b-y,l=1),I<0?(I=0,s=-1):I+f>k&&(I=k-f,s=1),J(a,S,I),((e,a)=>{let i,l,s=!1,o=0,c=Ta(a);do{o++,i=!1,l=!1;let a=r(t(e.x,e.y,e.w,e.h)),p={0:null,1:null,2:null,3:null};c.forEach(r=>{let s=t(r.px,r.py,r.size,r.size);_a(r)?n(a,s).forEach(e=>{i=!0,p[e]=r}):(e.y+e.h/2<r.py||e.plAi===q)&&n(a,s).forEach(t=>{0!==t||e.dpCol||(l=!0,i=!0,p[t]=r),2===t&&e.plAi===q&&(i=!0,p[t]=r),3===t&&e.plAi===q&&(i=!0,p[t]=r)})});let d=p[1],h=p[2],u=p[3],m=1;p[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),s=!0):d&&(l||(e.y+=m,e.vy=0)),h?(e.x+=m,e.plAi===q&&V(e,B)):u&&(e.x-=m,e.plAi===q&&V(e,j))}while(i&&o<10);s===e.isGround||s||(e.vy=0),e.isGround=s})(a,i),0===u&&$(a,"vx"),0===m&&$(a,"vy"),Z(a,0,0),[l,s]},G={},L=()=>{G["1,1,13,15"]=_t,G["1,1,11,11"]=Et,G["1,1,4,9"]=At,G["1,1,5,13"]=$t,G["0,1,9,15"]=Ot,G["0,1,7,11"]=Ut,G["0,1,9,11"]=jt,G["0,1,11,11"]=jt,G["0,1,13,11"]=jt,G["0,1,8,7"]=jt,G["0,1,10,7"]=jt,G["0,1,12,7"]=jt,G["0,1,14,7"]=Dt,G["0,1,7,3"]=jt,G["0,1,9,3"]=jt,G["0,1,11,3"]=jt,G["0,1,13,3"]=Bt,G["2,2,2,15"]=zt,G["2,2,2,12"]=Kt,G["2,2,1,12"]=Kt,G["2,1,5,15"]=Kt,G["2,1,3,15"]=Kt,G["2,1,4,15"]=Kt,G["2,1,3,13"]=Kt,G["2,1,9,9"]=Kt,G["2,1,1,15"]=Pt,G["2,1,8,5"]=Kt,G["2,1,10,15"]=Kt,G["2,0,2,2"]=Ft,G["3,0,2,3"]=Gt,G["3,0,4,10"]=Kt,G["3,0,11,14"]=Kt,G["3,1,2,7"]=Kt,G["3,0,1,14"]=Kt,G["3,1,12,7"]=Kt,G["3,1,3,14"]=Kt,G["3,2,1,5"]=Kt,G["3,1,14,10"]=Kt,G["3,1,9,12"]=Kt,G["3,1,6,12"]=Kt,G["3,2,2,8"]=Kt,G["3,2,11,6"]=Kt,G["3,2,11,12"]=Kt,G["3,0,7,3"]=Kt,G["3,2,14,12"]=Kt,G["3,3,3,15"]=Kt,G["3,3,14,7"]=Kt,G["3,0,7,9"]=Kt,G["3,1,4,5"]=Kt,G["3,2,4,7"]=Kt,G["3,2,7,7"]=Kt,G["3,2,5,7"]=Kt,G["3,2,5,13"]=Kt,G["3,3,8,5"]=Kt,G["3,3,7,5"]=Kt,G["3,1,7,12"]=Kt,G["3,1,6,4"]=Kt,G["3,3,8,15"]=Lt,G["3,3,1,3"]=ea,G["0,3,3,15"]=Kt,G["0,3,3,11"]=Kt,G["0,3,8,4"]=Kt,G["0,3,5,3"]=Kt,G["0,3,11,10"]=Kt,G["0,3,12,6"]=Kt,G["0,3,14,12"]=Kt,G["0,3,7,15"]=Kt,G["0,3,1,6"]=Kt,G["0,0,11,5"]=Kt,G["0,0,12,15"]=Kt,G["0,0,7,5"]=Kt,G["0,0,6,15"]=Kt,G["0,0,3,5"]=Kt,G["0,0,3,15"]=Kt,G["0,0,9,15"]=Kt,G["0,0,4,9"]=Kt,G["0,0,6,9"]=Kt,G["0,0,8,9"]=Kt,G["0,0,10,9"]=Kt,G["0,0,12,9"]=Kt,G["1,0,9,14"]=aa,G["1,0,2,15"]=Yt,G["1,0,9,8"]=ea,G["2,0,3,9"]=Qt,G["2,0,4,9"]=Qt,G["2,0,5,9"]=Qt,G["2,0,6,8"]=Qt,G["2,0,2,8"]=Qt,G["2,0,8,9"]=ea,G["1,1,8,8"]=ta,G["2,2,2,3"]=Zt,G["2,2,3,12"]=Kt,G["2,2,11,3"]=ea,G["2,3,9,15"]=Kt,G["2,3,8,15"]=Kt,G["2,3,7,15"]=Kt,G["2,3,6,15"]=Kt,G["2,3,5,15"]=Kt,G["2,3,4,15"]=Kt,G["2,3,3,15"]=Kt,G["2,3,2,15"]=Kt,G["2,3,10,15"]=Kt,G["2,3,11,15"]=Kt,G["2,3,12,15"]=Kt,G["2,3,13,15"]=Kt,G["2,3,1,15"]=Kt,G["1,3,10,10"]=Ht,G["2,3,15,12"]=Qt,G["3,3,0,12"]=Qt,G["2,2,11,7"]=Xt,G["2,2,5,4"]=Nt,G["1,3,2,15"]=Wt,G["1,3,7,15"]=qt,G["1,3,9,15"]=Vt,G["1,3,11,15"]=Jt,G["2,1,12,7"]=Rt,G["0,0,15,9"]=Qt,G["1,0,0,9"]=Qt,G["1,3,14,15"]=na};var Y,H;Y=(e=1,t=.05,a=220,n=0,r=0,i=.1,l=0,s=1,o=0,c=0,p=0,d=0,h=0,u=0,m=0,y=0,f=0,w=1,g=0,S=44100,I=99+n*S,b=r*S,k=i*S,x=g*S,v=f*S,C=2*Math.PI,M=(e=>0<e?1:-1),T=I+x+b+k+v,_=(o*=500*C/S**2),A=(a*=(1+2*t*Math.random()-t)*C/S),E=M(m)*C/4,$=0,O=0,P=0,F=0,G=0,L=0,Y=1,j=[],B=H.createBufferSource(),U=H.createBuffer(1,T,S))=>{for(B.connect(H.destination);P<T;j[P++]=L)++G>100*y&&(G=0,L=$*a*Math.sin(O*m*C/S-E),L=M(L=l?1<l?2<l?3<l?Math.sin((L%C)**3):Math.max(Math.min(Math.tan(L),1),-1):1-(2*L/C%2+2)%2:1-4*Math.abs(Math.round(L/C)-L/C):Math.sin(L))*Math.abs(L)**s*e*.3*(P<I?P/I:P<I+x?1-(P-I)/x*(1-w):P<I+x+b?w:P<T-v?(T-P-v)/k*w:0),L=v?L/2+(v>P?0:(P<T-v?1:(P-T)/v)*j[P-v|0]/2):L),$+=1-u+1e9*(Math.sin(P)+1)%2*u,O+=1-u+1e9*(Math.sin(P)**2+1)%2*u,a+=o+=500*c*C/S**3,Y&&++Y>d*S&&(a+=p*C/S,A+=p*C/S,Y=0),h&&++F>h*S&&(a=A,o=_,F=1,Y=Y||1);return U.getChannelData(0).set(j),B.buffer=U,B.start(),B},H=new AudioContext;let j=0,B=1,U=2,D=3,z=0,R=1,X=2,N=3,W=4,q=1,V=(e,t)=>{e.facing=t},J=(e,t,a)=>{e.x=t,e.y=a},K=e=>[e.x,e.y],Q=(e,t,a)=>{e.vx=t,e.vy=a},Z=(e,t,a)=>{e.ax=t,e.ay=a},ee=(e,t)=>{e.anim=t},te=e=>t(e.x,e.y,e.w,e.h),ae=0,ne=1,re=2,ie=0,le=1,se=2,oe=3,ce=4,pe=5,de=6,he=7,ue=["Strike","Charge","Break","Defend","Heal","Item","Flee"],me=e=>{let t=[];for(let a=0;a<4;a++)t.push([e,28*a+80]);return t},ye=me(40),fe=me(200),we=(e,t,a)=>{a=a||0;let n=Je(),r=[ua(n/2-50,n-20*ue.length,100,ue,Ie,e.inv.filter(e=>!!e.onUse).length?[]:[pe],!0,20)],i=(e=>{let t=[];for(let a=0;a<e.length;a++){let{unit:n,name:r}=e[a];n&&(n.name=r,n.i=a,n.allegiance=0,Ba(n),V(n.actor,B),t.push(n))}return Ra(t),t})(e.characters),l=(e=>{let t=[];for(let a=0;a<e.length;a++){let n=Qe(e[a]).unit;n.i=a,n.allegiance=1,V(n.actor,j),Ba(n),t.push(n)}return t})(t.enemies),s={party:e,allies:i,enemies:l,rounds:[],roundIndex:0,actionMenuStack:r,text:"",aiSeed:(3,Math.floor(3*Math.random())+1),completionState:3};je(s,a);let o=Oe(i.concat(l));return Ee(s,o),s},ge=(e,t)=>0===t?ye[e]:fe[e],Se=async e=>new Promise(t=>{let a=e.enemies,[n,r]=ge(0,1),i=e.enemies.map((e,t)=>t).filter(t=>!Ua(e.enemies[t])),l=ua(2*n-Sn,2*r+In/2,100,Array(a.length).fill(""),n=>{e.actionMenuStack.shift(),t(n>=0?a[n]:null)},i,!1,56);l.i=-1,ma(l,1),e.actionMenuStack.unshift(l)}),Ie=async e=>{let t=xe(),a=$e(t);switch(e){case ie:{let e=await Se(t);e&&u(ie,a,e);break}case le:u(le,a,null);break;case oe:u(oe,a,null);break;case ce:u(ce,a,null);break;case pe:{let e=await(async e=>new Promise(t=>{let a={},n=e.party,r=0,i=n.inv.filter((e,t)=>(a[r]=t,r++,!!e.onUse)).map(e=>e.name),l=Je(),s=ua(l/2-50,l-l/2,100,i,e=>{t(n.inv[a[e]])},[],!0,20);s.i=-1,ma(s,1),e.actionMenuStack.unshift(s)}))(t);e&&u(pe,a,null,e),t.actionMenuStack.shift();break}case se:{let e=await Se(t);e||u(se,a,e);break}case de:u(de,a,null);break;default:console.error("Action",e,"Is not implemented yet.")}},be=null,ke=e=>{be=e},xe=()=>be,ve=!1,Ce=e=>{ve=e},Me=()=>ve,Te=()=>{},_e=e=>{Te=e},Ae=()=>Te,Ee=(e,t)=>{e.rounds.push(t)},$e=e=>e.rounds[e.roundIndex],Oe=e=>({turnOrder:e,currentIndex:0}),Pe=e=>{e.currentIndex++},Fe=e=>{e.roundIndex++},Ge=e=>e.turnOrder[e.currentIndex]||null,Le=e=>null===Ge(e),Ye=e=>i(e.enemies)||i(e.allies)||3!==e.completionState,He=e=>ue[e],je=(e,t)=>{if(0===t)return;let a=1===t?e.allies:e.enemies;for(let e=0;e<a.length;e++)a[e].cS.spd+=5},Be=null,Ue=1,De=0,ze=(e,t)=>{let a=document.createElement("canvas");return a.width=e,a.height=t,[a,a.getContext("2d"),e,t]},Re=()=>{var e;if(Be)return Be;{let[t,a]=ze(512,512);return t.id="canv",a.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Be=t,t}},Xe=()=>Re().getContext("2d"),Ne=e=>{Ue=e},We=()=>Ue,qe=e=>{De=e},Ve=()=>De,Je=()=>512,Ke=(e,t)=>{t.aText=e},Qe=(e,t)=>{let{sprI:a,spr:n,stats:r,label:i,action:l,col:s,plAi:o,name:c}=e,p={sprite:"actors",spriteIndex:a,facing:j,anim:z,isGround:!1,dpCol:!1,plAi:0,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return p.plAi=o||0,n&&(p.sprite=n),{name:t||c,actor:p,label:i||"",action:l,col:s,aText:"",unit:r?La(c,p,e,0,0):void 0}},Ze=!1,et=null,tt=()=>Ze,at=e=>{Ze=e},nt=e=>et=e,rt=1,it=2,lt=3,st=4,ot=(e,t,a,n,r)=>({hp:e,dmg:t,def:a,mag:n,spd:r,iCnt:n,cCnt:0}),ct={name:"Bomb",dsc:"It destroys all enemies!",onUse:async e=>{let t=xe();Ia(t.party,e),t.completionState=ae,gn("actionStrike")}},pt={name:"Statue's Legs",dsc:"Good for running."},dt={name:"Statue's Voice",dsc:"For yelling."},ht={name:"Statue's MIND",dsc:"Arguably necessary"},ut={name:"Radiant Stone",dsc:"Gleaming marble.",onUse:()=>{}},mt={name:"",stats:{bS:ot(90,25,16,5,20),ai:0},sprI:0},yt=(ot(85,25,13,6,15),ot(80,19,18,4,6),ot(75,23,12,7,10),{name:"Golem",stats:{bS:ot(35,22,40,0,5),ai:it},sprI:8}),ft={name:"Fairy",stats:{bS:ot(30,23,9,2,15),ai:rt},sprI:4},wt={name:"Ape",stats:{bS:ot(20,40,5,0,15),ai:it},sprI:6},gt={name:"Breaker",stats:{bS:ot(35,30,14,1,14),ai:lt},sprI:7},St={name:"Old Guy",stats:{bS:ot(200,30,40,10,17),ai:st},sprI:15},It=Object.assign(Object.assign({},St),{name:"Old Guy (clone)"}),bt={enemies:[ft,yt,ft,gt]},kt={enemies:[wt,wt,ft]},xt={enemies:[wt,ft,yt,yt]},vt={enemies:[gt,wt,yt]},Ct={enemies:[gt,wt,ft]},Mt={enemies:[ft,wt,wt,yt]},Tt={enemies:[St,It]},_t={name:"Old Man",sprI:15,action:async e=>{T(e);let t="\n'Hello there.'\n'You've arrived with your wits about.'\n'That's very good.  You'll need them.'\n'These status are all...'\n'...missing something.'\n:)\n'Perhaps you should find what is not found...'\n  ".split("\n");await C(t),Tn()}},At={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{_(e,pt,"The Runner.")}},Et={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{_(e,ht,"The Thinker.")}},$t={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{_(e,dt,"The Speaker.")}},Ot={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Probably nothing is in these pots.")},Pt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("SPIKES are dangerous.")},Ft={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointless.")},Gt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("This fall is pointy.")},Lt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("How do you get up this cliff?")},Yt={name:"Sign",spr:"terrain",sprI:5,action:()=>M("The SHRINE of LEGS.")},Ht={name:"Sign",spr:"terrain",sprI:5,action:()=>M("Seek. Seek. Lest.")},jt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{let e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await C(e),Tn()}},Bt={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{let e="\nThis pot seems different from the others!\nYou check the pot.\n...\nThere's nothing inside.\n  ".split("\n");await C(e),Tn()}},Ut={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ot(85,25,13,6,15),ai:0},action:async e=>{let t="\nThere's something strange about this pot...\nYou check the pot...\nThere's a man inside.\n'Hello! You look very appealing!'\n'I'm coming with you!'\nThe Pot joins your party.\n  ".split("\n");await C(t),Tn();let a=Ja(),n=a.party,r=Qa(a);Ma(r,e),ga(n,e)}},Dt={name:"Pot",spr:"terrain",sprI:4,stats:{bS:ot(85,25,13,6,15),ai:it},action:async e=>{let t="\nYou check the pot...\n  ".split("\n");await C(t),await E(dt,e),await C(["How did that get in there?"]),Tn()}},zt={name:"Jin",sprI:3,stats:{bS:ot(75,23,12,7,10),ai:0},action:async e=>{T(e);let t=[""];t=an("talked_to_jin")?"\n'Hello friend!'\n'I have misplaced some treasure.'\n'If you'd bring it to me, I'd accompany you.'\n    ".split("\n"):"\n'Have you found my treasure yet?'\n      ".split("\n"),await C(t),Tn();let a=Ja(),{party:n}=a;if(ba(n,ut)){let t="\n'I'll take that! Let's be on our way!'\n      ".split("\n");Ia(n,ut),ga(n,e);let r=Qa(a);Ma(r,e),await C(t),Tn()}}},Rt={name:"",sprI:8,col:async e=>{await A(e,Mt,[ct])},plAi:q},Xt={name:"",sprI:8,col:async e=>{await A(e,xt,[ct])},plAi:q},Nt={name:"",sprI:8,col:async e=>{await A(e,bt,[ct])},plAi:q},Wt={name:"",sprI:8,col:async e=>{await A(e,kt,[ct])},plAi:q},qt={name:"",sprI:8,col:async e=>{await A(e,vt,[ct])},plAi:q},Vt={name:"",sprI:8,col:async e=>{await A(e,Ct,[ct])},plAi:q},Jt={name:"",sprI:8,col:async e=>{await A(e,kt,[ct])},plAi:q},Kt={name:"",spr:"terrain",sprI:6,col:async()=>{let e=Ja();e.pause=!0,gn("spikes"),await s(1e3),e.pause=!1,Za(Ja())}},Qt={name:"",spr:"terrain",sprI:1},Zt={name:"Shining Stone",spr:"terrain",sprI:11,action:e=>E(ut,e)},ea={name:"Item",spr:"terrain",sprI:11,action:e=>E(ct,e)},ta={name:"Orange",sprI:0,stats:{bS:ot(5,23,12,7,10),ai:it},action:async e=>{T(e);let t="\n'I am the strongest man!'\n'Fight me and I will join you!'\n    ".split("\n"),a="\n'Wow, you are tough! Onward, then!'\nOrange has joined your party.\n    ".split("\n");await C(t),Tn();let n={enemies:[ta]},r=Ja();if((await A(e,n)).completionState===ae){ga(r.party,e),await C(a),Tn();let t=e.unit;Ya(t.cS,t.bS,99)}}},aa={name:"Item",spr:"terrain",sprI:11,action:e=>E(pt,e)},na={name:"Item",spr:"terrain",sprI:11,action:e=>E(ht,e)},ra={},ia="ArrowRight",la="ArrowLeft",sa="ArrowDown",oa=" ",ca=e=>{if(1===e.length&&(e=e.toUpperCase()),!ra[e]){if(ra[e]=!0,"Q"===e&&(window.running=!1),tt())return;let t=xe();if(Me()&&t){let a=t.actionMenuStack[0];e===sa?ma(a,1):"ArrowUp"===e?ma(a,-1):"Enter"===e||"X"===e||e===oa?ya(a):"Escape"===e&&t.actionMenuStack.length>1&&fa(a)}else if("X"===e||"Enter"===e){let e=et;e&&e()}}},pa=-1,da=e=>{if(1===e.length&&(e=e.toUpperCase()),e===sa){let e=Ja(),t=wa(e.party).actor;t.dpCol&&(clearTimeout(pa),pa=setTimeout(()=>{t.dpCol=!1},150))}ra[e]=!1},ha=e=>(1===e.length&&(e=e.toUpperCase()),ra[e]),ua=(e,t,a,n,r,i,l,s)=>({x:e,y:t,w:a,h:(s=s||16)*n.length,i:0,cb:r,disabledItems:i,items:n,lineHeight:s,bg:!!l}),ma=(e,t,a)=>{let n=e.items.length,r=0,i=0,l=e.i;do{if(r++,r>30)break;i=l+t,i<0?i=n-1:i>=n&&(i=0),l=i}while(e.disabledItems.includes(i));e.i=i,a||gn("menuMove")},ya=e=>{e.cb(e.i),gn("menuConfirm")},fa=e=>{e.cb(-1),gn("menuCancel")},wa=e=>e.characters[0],ga=(e,t)=>{t.unit.ai=0,e.characters.push(t)},Sa=(e,t)=>{let a=Object.assign({},t);e.inv.push(a),An(e.inv,!0)},Ia=(e,t)=>{let a=e.inv.indexOf(t);a>-1&&e.inv.splice(a,1),An(e.inv,!0)},ba=(e,t)=>{for(let a in e.inv){let{name:n}=e.inv[a];if(n===t.name)return e.inv[a]}return null},ka={0:[156,100,52],1:[171,82,54],2:[0,228,54],7:[255,241,232],15:[0,0,0]},xa={};for(let e in ka)xa[ka[e].join("")]=+e;let va=(e,t,a,n)=>{let r=[],i=[],[,l]=ze(16,16);dn(e,0,0,1,l);let{data:s}=l.getImageData(0,0,16,16),o=0;for(let e=0;e<s.length;e+=4){let t=xa[`${s[e+0]}${s[e+1]}${s[e+2]}`]||0,l=o%16,c=Math.floor(o/16),p=null,d=G[[a,n,l,c].join(",")];d&&(p=Qe(d)),p&&(J(p.actor,16*l,16*c-16),i.push(p)),r.push({id:t,x:l,y:c,px:16*l,py:16*c,size:16}),o++}return{tiles:r,characters:i,w:16,h:16,bgSprite:t}},Ca=e=>[16*e.w,16*e.h],Ma=(e,t)=>{let a=e.characters.indexOf(t);a>-1&&e.characters.splice(a,1)},Ta=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),_a=e=>[0,1,7].includes(e.id),Aa=(e,t,a,n,r)=>[e,t,a,n,r],Ea=null,$a=e=>{let[t,a,n,r]=ze(e.width,e.height),i=n/2,l=r/2;return a.translate(i,l),a.rotate(Math.PI/2),a.drawImage(e,-i,-l),t},Oa=e=>{let[t,a,n]=ze(e.width,e.height);return a.translate(n,0),a.scale(-1,1),a.drawImage(e,0,0),t},Pa=e=>{let[,,,t,a]=e,[n,r]=ze(t,a);return dn(e,0,0,1,r),n},Fa=(e,t,a,n,r)=>{let i=(t,a,n,r,i,l)=>e[t]=Aa(a,n,r,i,l),l=(e,t,a)=>{let l=e;for(let e=0;e<a;e++)l=$a(l);i(`${t}_r${a}`,l,0,0,n,r)},s=t.width/n,o=t.height/r;for(let e=0;e<o;e++)for(let o=0;o<s;o++){let c=`${a}_${e*s+o}`,p=i(c,t,o*n,e*r,n,r);l(Pa(p),c,1),l(Pa(p),c,2),l(Pa(p),c,3),i(c+"_f",Oa(Pa(p)),0,0,n,r),i(c+"_fr1",$a(Oa(Pa(p))),0,0,n,r)}},Ga=async()=>{let e={},t=await new Promise(e=>{let t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),a=Pa(Aa(t,0,0,64,64));Fa(e,a,"actors",16,16);let n=Pa(Aa(t,64,0,64,64));Fa(e,n,"terrain",16,16);let r=Pa(Aa(t,0,64,64,64));Fa(e,r,"map",16,16);let i=Pa(Aa(t,64,64,64,64));Fa(e,i,"monsters",16,16),Ea=e},La=(e,t,a,n,r)=>{let i=a.stats,l={name:e,actor:t,bS:Object.assign({},i.bS),cS:Object.assign({},i.bS),i:r,allegiance:n,ai:i.ai};return V(l.actor,l.allegiance?j:B),Ba(l),l},Ya=(e,t,a)=>{let{hp:n}=e,{hp:r}=t,i=n+a;i>r?i=r:i<0&&(i=0),e.hp=i},Ha=e=>{let{allegiance:t}=e,[a,n]=ge(e.i,t);J(e.actor,a+(t?-20:20),n)},ja=e=>{let t=Je()/2/2-8;J(e.actor,t,t)},Ba=e=>{let[t,a]=ge(e.i,e.allegiance);J(e.actor,t,a)},Ua=e=>e.cS.hp>0,Da=e=>{e.cS.iCnt++},za=e=>{e.cS.def=e.bS.def},Ra=e=>{for(let t=0;t<e.length;t++)0===e[t].cS.hp&&(e[t].cS.hp=1)},Xa=(e,t)=>{let{cS:a}=e;switch(t){case ie:a.spd+=0;break;case le:a.spd-=2;break;case se:a.spd-=1;break;case oe:a.spd+=3;break;case ce:a.spd-=1;break;case pe:case de:a.spd-=2}},Na=null,Wa={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},qa=()=>{let e={characters:[Qe(mt,"Runner")],inv:[],worldX:0,worldY:0},t=wa(e);J(t.actor,128,180);let a={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)a.rooms.push(va("map_"+e,Wa[e],e%4,Math.floor(e/4)));return a},Va=e=>{Na=e},Ja=()=>Na,Ka=(e,t,a)=>{((e,t,a)=>{a.roomI=4*t+e})((a.roomI%4+e+4)%4,(Math.floor(a.roomI/4)+t+4)%4,a);let n=Qa(a),r=wa(a.party).actor,[i,l]=Ca(n),s=0,o=0;e>0&&(s=0,o=r.y),e<0&&(s=i-16,o=r.y),t>0&&(s=r.x,o=0),t<0&&(s=r.x,o=l-16),J(r,s,o),a.lastX=s,a.lastY=o},Qa=e=>e.rooms[e.roomI],Za=e=>{let t=wa(e.party);J(t.actor,e.lastX,e.lastY)},en=(e,t)=>{Ja().state[e]=t},tn=e=>Ja().state[e],an=e=>void 0===tn(e)&&(en(e,!0),!0),nn="#000",rn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},ln={},sn=()=>{let e=Re();pn(0,0,e.width,e.height,"#557","#aaf")},on=(e,t,a,n,r,i,l)=>{(l=l||Xe()).lineWidth=1,l[i?"strokeStyle":"fillStyle"]=r,l[i?"strokeRect":"fillRect"](e,t,a,n)},cn=(e,t,a,n,r)=>{let{font:i,size:l,color:s,align:o,strokeColor:c}=Object.assign(Object.assign({},rn),n||{});(r=r||Xe()).font=`${l}px ${i}`,r.fillStyle=s,r.textAlign=o,r.textBaseline="middle",r.fillText(e,t,a),c&&(r.strokeStyle=c,r.lineWidth=.5,r.strokeText(e,t,a))},pn=(e,t,a,n,r,i)=>{let l=Xe(),s=`${e},${t},${a},${n},${r},${i}`;if(!ln[s]){let e=l.createLinearGradient(0,n,0,0);e.addColorStop(0,r),e.addColorStop(1,i),ln[s]=e}l.fillStyle=ln[s],l.fillRect(e,t,a,n)},dn=(e,t,a,n,r)=>{n=n||1,r=r||Xe();let[i,l,s,o,c]="string"==typeof e?Ea[e]:e;r.drawImage(i,l,s,o,c,t,a,o*n,c*n)},hn=(e,t,a)=>{a=a||1;let{x:n,y:r}=e,i=n*a,l=r*a,[s,c,p]=((e,t)=>{let{facing:a,sprite:n,spriteIndex:r,anim:i}=e,l=i,s=r<3,c=0;t||(i===R?l-=o(1,100):i===N?s?l=2-o(1,250):(l=0,c=2*o(1,100)):i===W&&(l=s?2:0));let p="";switch(a){case 0:p="_f";break;case 2:p="_r3";break;case 3:p="_fr1"}return[n+"_"+(r+l+p),0,c]})(e,t);dn(s,i+c,l+p,a)},un=(e,t,a,n)=>{let r=Ja(),i=n||1;e.tiles.forEach(r=>{let{id:l,x:s,y:o,size:c}=r,p=(t+s*c)*i,d=(a+o*c)*i;dn(e.bgSprite,p,d,n),15!=l&&dn("terrain_"+l,p,d,n)}),e.characters.forEach(e=>{let t=e.actor;hn(t,r.pause,n);let{x:a,y:l}=t,s=e.aText;s&&cn(s,a*i+16*i/2,l*i-16*i/2,{size:16,align:"center"})})},mn=e=>{sn();let t=Ge($e(e));bn(5,15,150,20),cn("Turn: "+(null==t?void 0:t.name),10,26);let{allies:a,enemies:n,actionMenuStack:r}=e,i=r[0];for(let e=0;e<a.length;e++){let[t,n]=K(a[e].actor);J(a[e].actor,t,n),hn(a[e].actor,!1,2),cn(""+a[e].name,2*t+16,2*n-5,{align:"center"})}vn(e,0),vn(e,1);for(let e=0;e<n.length;e++){let[t,a]=K(n[e].actor);hn(n[e].actor,!1,2),cn(`${n[e].name}: ${""+n[e].cS.hp}/${""+n[e].bS.hp}`,2*t+5,2*a-5,{align:"center"})}Me()&&kn(i),e.text&&xn(e.text),Cn(e)},yn=null,fn=(e,t,a)=>{e[t]=a},wn=()=>{let e={};fn(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),fn(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),fn(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),fn(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),fn(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),fn(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),fn(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),fn(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),fn(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),fn(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),fn(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),fn(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),yn=e},gn=e=>{Y(...yn[e])},Sn=16,In=16,bn=(e,t,a,n,r)=>{on(e,t,a,n,r=r||nn),on(e,t,a,n,"#FFF",!0)},kn=e=>{let{x:t,y:a,w:n,h:r,i:i,bg:l,items:s,lineHeight:o}=e;l&&bn(t,a,n,r),s.forEach((r,i)=>{let l="#FFF";e.disabledItems.includes(i)&&(l="#999"),cn(r,t+n/2,a+i*o+o/2,{align:"center",color:l})}),((e,t)=>{let a=Xe(),n=In,r=Sn;a.save(),a.translate(e+2,t),a.beginPath(),a.moveTo(0,0),a.lineTo(0,n),a.lineTo(r,n/2),a.closePath(),a.fillStyle="#FFF",a.fill(),a.restore()})(t,a+o*i)},xn=e=>{let t=Je();bn(0,90,t,50),cn(e,Je()/2,116,{align:"center",size:20})},vn=(e,t)=>{let a=Je(),n=1===t?a-200:0,r=a-90;bn(n,r,200,90),((e,t)=>{let a=t-25;bn(0,a,200,25),cn("Unit",10,a+12.5),cn("HP",70,a+12.5),cn("Chg",117,a+12.5),cn("Brk/Hl",150,a+12.5)})(0,r);let i=1===t?e.enemies:e.allies;for(let e=0;e<i.length;e++){let a=i[e],{name:l,bS:s,cS:o}=a;0===t?(cn(l.slice(0,8),n+10,r+15+20*e),cn(`${o.hp}/${s.hp}`,n+70,r+15+20*e),cn(""+o.cCnt,n+125,r+15+20*e),cn(""+o.iCnt,n+168,r+15+20*e)):cn(l.slice(0,8),n+100,r+15+20*e,{align:"center"})}},Cn=e=>{let{turnOrder:t}=$e(e),a=t.length,n=35*a,r=Je()-Je()/3-n/2;bn(r-5,5,n+5,80);for(let n=0;n<a;n++,r+=35){let{name:a,actor:i}=t[n],{sprite:s,spriteIndex:o}=i,c=10+($e(e).currentIndex===n?20:10);bn(r,c,30,40,l(e,t[n])?"#29ADFF":"#FF004D");let p=l(e,t[n])?c-5:c+40+8;cn(a.slice(0,5),r+15,p,{size:12,align:"center",strokeColor:"#FFF"}),dn(`${s}_${o}`,r,c+5,2)}},Mn=null,Tn=()=>{let e=document.getElementById("dialogBox");window.removeEventListener("keypress",Mn),e.style.opacity="0",e.style.width="0",at(!1)},_n=(e,t)=>{let a=document.getElementById("dialogBox");window.removeEventListener("keypress",Mn),a.innerHTML=`<div style="width:476px">${e}</div>`,a.style.opacity="1",a.style.width="512px",Mn=e=>{let a=e.key.length>1?e.key:e.key.toUpperCase();a!==oa&&"X"!==a&&"Enter"!==a||(window.removeEventListener("keypress",Mn),t())},setTimeout(()=>{window.addEventListener("keypress",Mn)},25),at(!0)},An=(e,t)=>{let a=document.getElementById("itemBox");a.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){let n=document.createElement("span");n.innerHTML=e[t].name+(t<e.length-1?",":""),n.className="item",a.appendChild(n)}a.style.display=t?"flex":"none"}})();