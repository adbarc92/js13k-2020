(()=>{window.running=!0,window.addEventListener("load",async()=>{await en(),Fn(),P(),(()=>{const e=un();mn(e),window.world=e;const t=e.party,n=ze(st,"Jeremiah"),a=ze(rt,"Seph"),s=ze(ot,"Kana");jt(t,n),jt(t,a),jt(t,s);const r=re(t,nt);he(r),h(r);const o=performance.now();let i=o;const c=n=>{const a=(n-i)/16.666;Ae(a>2?2:a),Be(n-o),i=n,xn();const s=pe();if(s)En(s);else{const n=gn(e),a=Gt(t).actor;T(e),Tn(n,0,0,2),_n(a,2)}window.running&&requestAnimationFrame(c)};c(o)})()});const e=e=>Math.abs(e)/e,t=(e,t,n,a)=>[e,t,e+n,t+a],n=(e,t)=>[e,t],a=(e,t)=>e.map((e,n)=>((e,t)=>{const[n,a]=e,[s,r,o,i]=t;return n>s&&n<o&&a>r&&a<i})(e,t)?n:-1).filter(e=>e>-1),s=e=>{const[t,a,s,r]=e,o=s-t,i=t+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(t+o/4,c),n(s-o/4,c)]},r=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),o=e=>Math.floor(Math.random()*Math.floor(e)),i=(e,t)=>e.allies.includes(t),c=async e=>new Promise(t=>{setTimeout(t,e)}),l=(e,t)=>fn().pause?0:Math.floor(De()%((e+1)*t)/t),h=async e=>{for(he(e),ue(!1);!Ce(e);)await p(e);setTimeout(()=>{const t=re(e.party,tt);he(t),h(t)},2e3)},p=async e=>{const t=be(e);for(f(t);!ve(t);)await d(e,t),Ie(t);const n=y(t);we(e,n),xe(e)},d=async(e,t)=>{const n=ke(t);if(on(n)){if(n.cS.def!==n.bS.def&&ln(n),0!==n.cS.spd)return an(n),new Promise(a=>{ye(a);const s=e.actionMenuStack[0];i(e,n)?(s.disabledItems=n.cS.iCnt<=0?[2,4]:[],s.i=-1,Lt(s,1,!0),ue(!0)):setTimeout(()=>{((e,t,n)=>{const a=(s=e.allies)[o(s.length)];var s;const{roundIndex:r,aiSeed:i}=e;switch(n.ai){case qe:n.cS.cCnt<n.cS.iCnt?u(J,t,null):u(V,t,a);break;case We:u(V,t,a);break;case Ne:u(r%(i+2)==0?Q:V,t,a)}})(e,t,n)},1e3)});n.cS.spd=n.bS.spd}},u=async(e,t,n)=>{ue(!1);const a=pe(),s=ke(t);switch(sn(s),N(s.actor,H),a.text=Me(e),await c(1e3),hn(s,e),e){case V:const t=g(s,n);if(a.text="Did "+-t+" damage.",On("actionStrike"),N(n.actor,Y),await c(800),N(n.actor,G),!on(n)){const e=i(a,n)?B:D;R(n.actor,e)}break;case J:w(s),On("actionCharge");break;case Z:I(s),On("actionDefend");break;case ee:S(s);break;case Q:b(s,n);break;default:console.error("No action:",e,"exists.")}await c(2e3),rn(s),N(s.actor,G),a.text="",await c(500),ge()(),m(t)&&cn(s)},m=e=>{const{turnOrder:t}=e;let n=!1;for(let e=0;e<t.length;e++)on(t[e])||(t.splice(e,1),n=!0);return n},f=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},y=e=>Se(e.turnOrder),g=(e,t)=>{const{cS:n,bS:a}=t,{def:s}=n,{dmg:r}=e.bS,{cCnt:o}=e.cS,i=-Math.floor(Math.max((o>0?r*(o+1):r)-s,1));return e.cS.cCnt=0,nn(n,a,i),i},w=e=>{const{cS:t}=e;t.cCnt++},b=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},S=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},I=e=>{const{cS:t}=e;t.def*=1.5};window.addEventListener("keydown",e=>{Re()||$t(e.key)}),window.addEventListener("keyup",e=>{Ft(e.key)});const x=async(e,t)=>(t||On("cutscene"),new Promise(t=>{Rn(e,t)})),k=async(e,t)=>{On(t||"menuConfirm"),x("",!0);const n=fn();n.pause=!0,await c(250);for(let t=0;t<e.length;t++){const n=e[t].trim();n&&await x(n)}On("menuCancel"),n.pause=!1},v=async e=>{const t=(e=>[`This sign says: "${e}"`])(e);await k(t),Yn()},C=e=>{const t=fn(),n=Gt(t.party),a=e.actor;R(a,n.actor.x<a.x?A:L)},M=(e,t)=>{const n=e[t];n<0?e[t]+=1.2:n>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},T=e=>{if(e.pause)return;const t=gn(e),{characters:n}=t;n.forEach(e=>{E(e.actor,t)}),_(e.party,t,e)},_=(e,t,n)=>{const r=Gt(e).actor,{ax:o,ay:i,isGround:c}=r;N(r,G),Xe(null);let l=o,h=i;const p=c?1.2:.04;Ot(Tt)&&(l=-p,R(r,A),N(r,j)),Ot(Mt)&&(l=p,R(r,L),N(r,j)),Ot(Et)&&r.isGround&&(On("jump"),h=-5.1,r.vy=0,r.isGround=!1),Ot(_t)&&(r.disablePlatformCollision=!0),r.isGround||N(r,z),W(r,l,h);const[d,u]=E(r,t);(d||u)&&yn(d,u,n);const m=s(K(r));for(let e in t.characters){const n=t.characters[e],s=n.actor;je("",n);const r=K(s);let o=!1;a(m,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&je(i,n),Xe(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},E=(n,r)=>{(e=>{const t=Le();e.ay+=e.isGround?1e-4*t:.2*t})(n);let o=0,i=0;const c=Le();let{x:l,y:h,vx:p,vy:d,ax:u,ay:m,w:f,h:y}=n,g=p+u*c,w=d+m*c;Math.abs(g)>1.2&&(g=1.2*e(g)),Math.abs(w)>3.2&&(w=3.2*e(w)),q(n,g,w);let b=l+p*c,S=h+d*c;const[I,x]=Ut(r);return b<0?(b=0,o=-1):b+f>I&&(b=I-f,o=1),S<0?(S=0,i=-1):S+y>x&&(S=x-y,i=1),U(n,b,S),((e,n)=>{let r,o,i=!1,c=0;const l=qt(n);do{c++,r=!1,o=!1;const n=s(t(e.x,e.y,e.w,e.h)),h={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=t(s.px,s.py,s.size,s.size);Wt(s)?a(n,i).forEach(e=>{r=!0,h[e]=s}):e.y+e.h/2<s.py&&a(n,i).forEach(t=>{0!==t||e.disablePlatformCollision||(o=!0,r=!0,h[t]=s)})});const p=h[1],d=h[2],u=h[3],m=1;h[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),i=!0):p&&(o||(e.y+=m,e.vy=0)),d?e.x+=m:u&&(e.x-=m)}while(r&&c<10);i===e.isGround||i||(e.vy=0),e.isGround=i})(n,r),0===u&&M(n,"vx"),0===m&&M(n,"vy"),W(n,0,0),[o,i]},$={},P=()=>{$["1,1,10,15"]=it,$["1,1,11,11"]=lt,$["1,1,4,9"]=ct,$["1,1,5,15"]=ht,$["0,1,9,15"]=pt,$["0,1,7,11"]=gt,$["0,1,9,11"]=gt,$["0,1,11,11"]=gt,$["0,1,13,11"]=gt,$["0,1,8,7"]=gt,$["0,1,10,7"]=gt,$["0,1,12,7"]=gt,$["0,1,14,7"]=bt,$["0,1,7,3"]=gt,$["0,1,9,3"]=gt,$["0,1,11,3"]=gt,$["0,1,13,3"]=wt,$["2,2,2,15"]=St,$["2,2,3,3"]=kt,$["2,2,2,12"]=It,$["2,2,1,12"]=It,$["2,1,5,15"]=It,$["2,1,3,15"]=It,$["2,1,4,15"]=It,$["2,1,3,13"]=It,$["2,1,9,9"]=It,$["2,1,1,15"]=dt,$["2,1,8,5"]=It,$["2,1,10,15"]=It,$["2,0,2,2"]=ut,$["3,0,2,3"]=mt,$["3,0,4,10"]=It,$["3,0,11,14"]=It,$["3,1,2,7"]=It,$["3,0,1,14"]=It,$["3,0,14,7"]=It,$["3,1,12,7"]=It,$["3,1,3,14"]=It,$["3,2,1,5"]=It,$["3,1,14,10"]=It,$["3,1,9,12"]=It,$["3,1,6,12"]=It,$["3,2,2,8"]=It,$["3,2,11,4"]=It,$["3,2,11,12"]=It,$["3,0,7,3"]=It,$["3,2,14,12"]=It,$["3,3,3,15"]=It,$["3,3,14,7"]=It,$["3,0,7,9"]=It,$["3,1,4,5"]=It,$["3,2,4,7"]=It,$["3,2,7,7"]=It,$["3,2,5,7"]=It,$["3,2,5,13"]=It,$["3,3,8,5"]=It,$["3,3,7,5"]=It,$["3,1,7,12"]=It,$["3,1,6,4"]=It,$["3,3,8,15"]=ft,$["3,3,1,3"]=vt,$["0,3,3,15"]=It,$["0,3,3,11"]=It,$["0,3,8,4"]=It,$["0,3,5,3"]=It,$["0,3,11,10"]=It,$["0,3,12,6"]=It,$["0,3,14,12"]=It,$["0,3,7,15"]=It,$["0,3,1,6"]=It,$["0,0,11,5"]=It,$["0,0,12,15"]=It,$["0,0,7,5"]=It,$["0,0,6,15"]=It,$["0,0,3,5"]=It,$["0,0,3,15"]=It,$["0,0,9,15"]=It,$["0,0,4,9"]=It,$["0,0,6,9"]=It,$["0,0,8,9"]=It,$["0,0,10,9"]=It,$["0,0,12,9"]=It,$["1,0,11,13"]=vt,$["1,0,2,15"]=yt,$["1,0,13,8"]=vt,$["2,0,3,9"]=xt,$["2,0,4,9"]=xt,$["2,0,5,9"]=xt,$["2,0,6,8"]=xt,$["2,0,2,8"]=xt,$["2,0,8,9"]=vt,$["0,2,4,15"]=vt};var F,O;F=(e=1,t=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,h=0,p=0,d=0,u=0,m=0,f=0,y=0,g=1,w=0,b=44100,S=99+a*b,I=s*b,x=r*b,k=w*b,v=y*b,C=2*Math.PI,M=(e=>0<e?1:-1),T=S+k+I+x+v,_=(c*=500*C/b**2),E=(n*=(1+2*t*Math.random()-t)*C/b),$=M(m)*C/4,P=0,F=0,A=0,L=0,B=0,D=0,G=1,j=[],z=O.createBufferSource(),H=O.createBuffer(1,T,b))=>{for(z.connect(O.destination);A<T;j[A++]=D)++B>100*f&&(B=0,D=P*n*Math.sin(F*m*C/b-$),D=M(D=o?1<o?2<o?3<o?Math.sin((D%C)**3):Math.max(Math.min(Math.tan(D),1),-1):1-(2*D/C%2+2)%2:1-4*Math.abs(Math.round(D/C)-D/C):Math.sin(D))*Math.abs(D)**i*e*.3*(A<S?A/S:A<S+k?1-(A-S)/k*(1-g):A<S+k+I?g:A<T-v?(T-A-v)/x*g:0),D=v?D/2+(v>A?0:(A<T-v?1:(A-T)/v)*j[A-v|0]/2):D),P+=1-u+1e9*(Math.sin(A)+1)%2*u,F+=1-u+1e9*(Math.sin(A)**2+1)%2*u,n+=c+=500*l*C/b**3,G&&++G>p*b&&(n+=h*C/b,E+=h*C/b,G=0),d&&++L>d*b&&(n=E,c=_,L=1,G=G||1);return H.getChannelData(0).set(j),z.buffer=H,z.start(),z},O=new AudioContext;const A=0,L=1,B=2,D=3,G=0,j=1,z=2,H=3,Y=4,R=(e,t)=>{e.facing=t},U=(e,t,n)=>{e.x=t,e.y=n},X=e=>[e.x,e.y],q=(e,t,n)=>{e.vx=t,e.vy=n},W=(e,t,n)=>{e.ax=t,e.ay=n},N=(e,t)=>{e.anim=t},K=e=>t(e.x,e.y,e.w,e.h),V=0,J=1,Q=2,Z=3,ee=4,te=["Strike","Charge","Break","Defend","Heal","Item","Flee"],ne=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,28*n+80]);return t},ae=ne(40),se=ne(200),re=(e,t,n)=>{n=n||0;const a=Ge(),s=[At(a/2-50,a-20*te.length,100,te,ce,[],!0,20)],r=(e=>{const t=[];for(let n=0;n<e.length;n++){const{unit:a,name:s}=e[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,rn(a),t.push(a)}return t})(e.characters),i=(e=>{const t=[];for(let n=0;n<e.length;n++){const a=ze(e[n]).unit;a.i=n,a.allegiance=1,R(a.actor,A),rn(a),t.push(a)}return t})(t.enemies),c={party:e,allies:r,enemies:i,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:o(3)+1};Te(c,n);const l=Se(r.concat(i));return we(c,l),c},oe=(e,t)=>0===t?ae[e]:se[e],ie=async e=>new Promise(t=>{const n=e.enemies,[a,s]=oe(0,1),r=e.enemies.map((e,t)=>t).filter(t=>!on(e.enemies[t])),o=At(2*a-An,2*s+Ln/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},r,!1,56);o.i=-1,Lt(o,1),e.actionMenuStack.unshift(o)}),ce=async e=>{const t=pe(),n=be(t);switch(e){case V:let a=await ie(t);if(!a)return;u(V,n,a);break;case J:u(J,n,null);break;case Z:u(Z,n,null);break;case ee:u(ee,n,null);break;case Q:const s=await ie(t);if(!s)return;u(Q,n,s);break;default:console.error("Action",e,"Is not implemented yet.")}};let le=null;const he=e=>{le=e},pe=()=>le;let de=!1;const ue=e=>{de=e},me=()=>de;let fe=()=>{};const ye=e=>{fe=e},ge=()=>fe,we=(e,t)=>{e.rounds.push(t)},be=e=>e.rounds[e.roundIndex],Se=e=>({turnOrder:e,currentIndex:0}),Ie=e=>{e.currentIndex++},xe=e=>{e.roundIndex++},ke=e=>e.turnOrder[e.currentIndex]||null,ve=e=>null===ke(e),Ce=e=>r(e.enemies)||r(e.allies),Me=e=>te[e],Te=(e,t)=>{if(0===t)return;const n=1===t?e.allies:e.enemies;for(let e=0;e<n.length;e++)n[e].cS.spd+=5};let _e=null,Ee=1,$e=0;const Pe=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},Fe=()=>{var e;if(_e)return _e;{const[t,n]=Pe(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),_e=t,t}},Oe=()=>Fe().getContext("2d"),Ae=e=>{Ee=e},Le=()=>Ee,Be=e=>{$e=e},De=()=>$e,Ge=()=>512,je=(e,t)=>{t.aText=e},ze=(e,t)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,name:c}=e,l={sprite:"actors",spriteIndex:n,facing:A,anim:G,isGround:!1,disablePlatformCollision:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return a&&(l.sprite=a),{name:t||c,actor:l,label:r||"",action:o,col:i,aText:"",unit:s?tn(c,l,e,0,0):void 0}};let He=!1,Ye=null;const Re=()=>He,Ue=e=>{He=e},Xe=e=>Ye=e,qe=1,We=2,Ne=3,Ke=(e,t,n,a,s)=>({hp:e,dmg:t,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),Ve={name:"Bomb",dsc:"It destroys all enemies!",onUse:()=>{}},Je={name:"Golem",stats:{bS:Ke(30,20,30,1,5),ai:We},sprI:5},Qe={name:"Fairy",stats:{bS:Ke(20,8,5,5,15),ai:We},sprI:4},Ze={name:"Ape",stats:{bS:Ke(20,30,5,1,15),ai:We},sprI:6},et={name:"Breaker",stats:{bS:Ke(40,30,14,1,14),ai:Ne},sprI:7},tt={enemies:[Je,Je,Je]},nt={enemies:[et,Ze,Qe]},at={name:"",stats:{bS:Ke(90,24,16,5,20),ai:0},sprI:0},st={name:"",stats:{bS:Ke(85,25,13,6,15),ai:0},sprI:0},rt={name:"",stats:{bS:Ke(80,19,18,4,6),ai:0},sprI:0},ot={name:"",stats:{bS:Ke(75,23,12,7,10),ai:0},sprI:0},it={name:"Old Man",sprI:15,action:async e=>{C(e);const t="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\nIf you seek refuge from this place, it may be prudent to find what is not found.\n  ".split("\n");await k(t),Yn()}},ct={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async()=>{let e=[""];const t="This statue appears to be missing a pair of legs.";e=bn("examined_runner")?`\nThere's a plaque beneath this statue.\nIt says, "The Runner."\n${t}\n  `.split("\n"):(""+t).split("\n"),await k(e),Yn()}},lt={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async()=>{let e=[""];const t="This statue appears to be missing a brain.";e=bn("examined_thinker")?`\nThere's a plaque beneath this statue.\nIt says, "The Thinker."\n${t}\n  `.split("\n"):`\n      ${t}\n      `.split("\n"),await k(e),Yn()}},ht={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async()=>{let e=[""];const t="This statue appears to be missing a voice.";e=bn("examined_speaker")?`\nThere's a plaque beneath this statue.\nIt says, "The Speaker."\n${t}\n  `.split("\n"):(""+t).split("\n"),await k(e),Yn()}},pt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("Probably nothing is in these pots.")},dt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("SPIKES are dangerous.")},ut={name:"Sign",spr:"terrain",sprI:5,action:()=>v("This fall is pointless.")},mt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("This fall is pointy.")},ft={name:"Sign",spr:"terrain",sprI:5,action:()=>v("This cliff is tall.")},yt={name:"Sign",spr:"terrain",sprI:5,action:()=>v("The SHRINE of LEGS.")},gt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(e),Yn()}},wt={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const e="\nThere's something strange about this pot...\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(e),Yn()}},bt={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's a VOICE inside!\n  ".split("\n");await k(e),Yn()}},St={name:"Pate",sprI:3,action:async e=>{C(e);let t=[""];t=bn("talked_to_pate")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\nNo? Come back when you have!\n      ".split("\n"),await k(t),Yn()}},It={name:"",spr:"terrain",sprI:6,col:async()=>{const e=fn();e.pause=!0,On("spikes"),await c(1e3),e.pause=!1,wn(fn())}},xt={name:"",spr:"terrain",sprI:1},kt={name:"A gleaming item...",spr:"terrain",sprI:4,action:async()=>{const e="\nA gleaming marble radiating shifting hues...\n    ".split("\n");await k(e),Yn()}},vt={name:"Item",spr:"terrain",sprI:11,action:e=>(async(e,t)=>{const n=fn(),{name:a,dsc:s}=t,r=["You acquired: "+a,s];n.pause=!0,await k(r,"item"),Yn();const o=gn(n);Xt(o,e),zt(n.party,t)})(e,Ve)},Ct={},Mt="ArrowRight",Tt="ArrowLeft",_t="ArrowDown",Et=" ",$t=e=>{if(1===e.length&&(e=e.toUpperCase()),!Ct[e]){if(Ct[e]=!0,"Q"===e&&(window.running=!1),Re())return;const t=pe();if(me()&&t){const n=t.actionMenuStack[0];e===_t?Lt(n,1):"ArrowUp"===e?Lt(n,-1):"Enter"===e?Bt(n):"Escape"===e&&t.actionMenuStack.length>1&&Dt(n)}else if("X"===e||"Enter"===e){const e=Ye;e&&e()}}};let Pt=-1;const Ft=e=>{if(1===e.length&&(e=e.toUpperCase()),e===_t){const e=fn(),t=Gt(e.party).actor;t.disablePlatformCollision&&(clearTimeout(Pt),Pt=setTimeout(()=>{t.disablePlatformCollision=!1},150))}Ct[e]=!1},Ot=e=>(1===e.length&&(e=e.toUpperCase()),Ct[e]),At=(e,t,n,a,s,r,o,i)=>({x:e,y:t,w:n,h:(i=i||16)*a.length,i:0,cb:s,disabledItems:r,items:a,lineHeight:i,bg:!!o}),Lt=(e,t,n)=>{const a=e.items.length;let s=0,r=0,o=e.i;do{if(s++,s>30)break;r=o+t,r<0?r=a-1:r>=a&&(r=0),o=r}while(e.disabledItems.includes(r));e.i=r,n||On("menuMove")},Bt=e=>{e.cb(e.i),On("menuConfirm")},Dt=e=>{e.cb(-1),On("menuCancel")},Gt=e=>e.characters[0],jt=(e,t)=>{e.characters.push(t)},zt=(e,t)=>{const n=Object.assign({},t);e.inv.push(n)},Ht={0:[156,100,52],1:[171,82,54],2:[0,228,54],3:[0,135,81],4:[29,43,83],5:[95,87,79],6:[194,195,199],7:[255,241,232],8:[255,0,77],15:[0,0,0]},Yt={};for(let e in Ht)Yt[Ht[e].join("")]=+e;const Rt=(e,t,n,a)=>{const s=[],r=[],[,o]=Pe(16,16);Mn(e,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let e=0;e<i.length;e+=4){let t=Yt[`${i[e+0]}${i[e+1]}${i[e+2]}`]||0;const o=c%16,l=Math.floor(c/16);let h=null;const p=$[[n,a,o,l].join(",")];p&&(h=ze(p)),h&&(U(h.actor,16*o,16*l-16),r.push(h)),s.push({id:t,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:t}},Ut=e=>[16*e.w,16*e.h],Xt=(e,t)=>{const n=e.characters.indexOf(t);n>-1&&e.characters.splice(n)},qt=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),Wt=e=>[0,1,7].includes(e.id),Nt=(e,t,n,a,s)=>[e,t,n,a,s];let Kt=null;const Vt=e=>{const[t,n,a,s]=Pe(e.width,e.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(e,-r,-o),t},Jt=e=>{const[t,n,a]=Pe(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},Qt=e=>{const[,,,t,n]=e,[a,s]=Pe(t,n);return Mn(e,0,0,1,s),a},Zt=(e,t,n,a,s)=>{const r=(t,n,a,s,r,o)=>e[t]=Nt(n,a,s,r,o),o=(e,t,n)=>{let o=e;for(let e=0;e<n;e++)o=Vt(o);r(`${t}_r${n}`,o,0,0,a,s)},i=t.width/a,c=t.height/s;for(let e=0;e<c;e++)for(let c=0;c<i;c++){const l=`${n}_${e*i+c}`,h=r(l,t,c*a,e*s,a,s);o(Qt(h),l,1),o(Qt(h),l,2),o(Qt(h),l,3),r(l+"_f",Jt(Qt(h)),0,0,a,s),r(l+"_fr1",Vt(Jt(Qt(h))),0,0,a,s)}},en=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=Qt(Nt(t,0,0,64,64));Zt(e,n,"actors",16,16);const a=Qt(Nt(t,64,0,64,64));Zt(e,a,"terrain",16,16);const s=Qt(Nt(t,0,64,64,64));Zt(e,s,"map",16,16);const r=Qt(Nt(t,64,64,64,64));Zt(e,r,"monsters",16,16),Kt=e},tn=(e,t,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${e}' has no stats!`);const o={name:e,actor:t,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return R(o.actor,o.allegiance?A:L),rn(o),o},nn=(e,t,n)=>{const{hp:a}=e,{hp:s}=t;let r=a+n;r>s?r=s:r<0&&(r=0),e.hp=r},an=e=>{const{allegiance:t}=e,[n,a]=oe(e.i,t);U(e.actor,n+(t?-20:20),a)},sn=e=>{const t=Ge()/2/2-8;U(e.actor,t,t)},rn=e=>{const[t,n]=oe(e.i,e.allegiance);U(e.actor,t,n)},on=e=>e.cS.hp>0,cn=e=>{e.cS.iCnt++},ln=e=>{e.cS.def=e.bS.def},hn=(e,t)=>{const{cS:n}=e;switch(t){case V:n.spd+=0;break;case J:n.spd-=2;break;case Q:n.spd-=1;break;case Z:n.spd+=3;break;case ee:n.spd-=1;break;case 5:case 6:n.spd-=2}};let pn=null;const dn={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},un=()=>{const e={characters:[ze(at,"Runner")],inv:[],worldX:0,worldY:0},t=Gt(e);U(t.actor,128,180);const n={rooms:[],party:e,lastX:128,lastY:180,roomI:5,pause:!1,state:{}};for(let e=0;e<16;e++)n.rooms.push(Rt("map_"+e,dn[e],e%4,Math.floor(e/4)));return n},mn=e=>{pn=e},fn=()=>pn,yn=(e,t,n)=>{((e,t,n)=>{n.roomI=4*t+e})((n.roomI%4+e+4)%4,(Math.floor(n.roomI/4)+t+4)%4,n);const a=gn(n),s=Gt(n.party).actor,[r,o]=Ut(a);let i=0,c=0;e>0&&(i=0,c=s.y),e<0&&(i=r-16,c=s.y),t>0&&(i=s.x,c=0),t<0&&(i=s.x,c=o-16),U(s,i,c),n.lastX=i,n.lastY=c},gn=e=>e.rooms[e.roomI],wn=e=>{const t=Gt(e.party);U(t.actor,e.lastX,e.lastY)},bn=e=>void 0===(e=>fn().state[e])(e)&&(((e,t)=>{fn().state[e]=!0})(e),!0),Sn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},In={},xn=()=>{const e=Fe();Cn(0,0,e.width,e.height,"#557","#aaf")},kn=(e,t,n,a,s,r,o)=>{(o=o||Oe()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](e,t,n,a)},vn=(e,t,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},Sn),a||{});(s=s||Oe()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(e,t,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(e,t,n))},Cn=(e,t,n,a,s,r)=>{const o=Oe(),i=`${e},${t},${n},${a},${s},${r}`;if(!In[i]){const e=o.createLinearGradient(0,a,0,0);e.addColorStop(0,s),e.addColorStop(1,r),In[i]=e}o.fillStyle=In[i],o.fillRect(e,t,n,a)},Mn=(e,t,n,a,s)=>{a=a||1,s=s||Oe();const[r,o,i,c,l]="string"==typeof e?Kt[e]:e;s.drawImage(r,o,i,c,l,t,n,c*a,l*a)},Tn=(e,t,n,a)=>{const s=a||1;e.tiles.forEach(r=>{const{id:o,x:i,y:c,size:l}=r,h=(t+i*l)*s,p=(n+c*l)*s;Mn(e.bgSprite,h,p,a),15!=o&&Mn("terrain_"+o,h,p,a)}),e.characters.forEach(e=>{const t=e.actor;_n(t,a);const{x:n,y:r}=t,o=e.aText;o&&vn(o,n*s+16*s/2,r*s-16*s/2,{size:16,align:"center"})})},_n=(e,t)=>{t=t||1;const{x:n,y:a}=e,s=n*t,r=a*t,[o,i,c]=(e=>{let{facing:t,sprite:n,spriteIndex:a,anim:s}=e,r=s,o=a<3,i=0;s===j?r-=l(1,100):s===H?o?r=2-l(1,250):(r=0,i=2*l(1,100)):s===Y&&(r=o?2:0);let c="";switch(t){case 0:c="_f";break;case 2:c="_r3";break;case 3:c="_fr1"}return[n+"_"+(a+r+c),0,i]})(e);Mn(o,s+i,r+c,t)},En=e=>{xn();const t=ke(be(e));Bn(5,15,150,20),vn("Turn: "+(null==t?void 0:t.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=e,r=s[0];for(let e=0;e<n.length;e++){const[t,a]=X(n[e].actor);U(n[e].actor,t,a),_n(n[e].actor,2),vn(""+n[e].name,2*t+16,2*a-5,{align:"center"})}jn(e,0),jn(e,1);for(let e=0;e<a.length;e++){const[t,n]=X(a[e].actor);_n(a[e].actor,2),vn(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}me()&&Dn(r),e.text&&Gn(e.text),zn(e)};let $n=null;const Pn=(e,t,n)=>{e[t]=n},Fn=()=>{const e={};Pn(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),Pn(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),Pn(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),Pn(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),Pn(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),Pn(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),Pn(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),Pn(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),Pn(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),Pn(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),Pn(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),Pn(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),Pn(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),$n=e},On=e=>{F(...$n[e])},An=16,Ln=16,Bn=(e,t,n,a,s)=>{kn(e,t,n,a,s=s||"#000"),kn(e,t,n,a,"#FFF",!0)},Dn=e=>{const{x:t,y:n,w:a,h:s,i:r,bg:o,items:i,lineHeight:c}=e;o&&Bn(t,n,a,s),i.forEach((s,r)=>{let o="#FFF";e.disabledItems.includes(r)&&(o="#999"),vn(s,t+a/2,n+r*c+c/2,{align:"center",color:o})}),((e,t)=>{const n=Oe(),a=Ln,s=An;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+c*r)},Gn=e=>{const t=Ge();Bn(0,90,t,50),vn(e,Ge()/2,116,{align:"center",size:20})},jn=(e,t)=>{const n=Ge(),a=1===t?n-200:0,s=n-90;Bn(a,s,200,90),((e,t)=>{const n=t-25;Bn(0,n,200,25),vn("Unit",10,n+12.5),vn("HP",80,n+12.5),vn("Chg",140,n+12.5),vn("Int",170,n+12.5)})(0,s);const r=1===t?e.enemies:e.allies;for(let e=0;e<r.length;e++){const n=r[e],{name:o,bS:i,cS:c}=n;0===t?(vn(o.slice(0,8),a+10,s+15+20*e),vn(`${c.hp}/${i.hp}`,a+80,s+15+20*e),vn(""+c.cCnt,a+145,s+15+20*e),vn(""+c.iCnt,a+175,s+15+20*e)):vn(o.slice(0,8),a+100,s+15+20*e,{align:"center"})}},zn=e=>{const{turnOrder:t}=be(e),n=t.length,a=35*n;let s=Ge()-Ge()/3-a/2;Bn(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:r}=t[a],{sprite:o,spriteIndex:c}=r,l=10+(be(e).currentIndex===a?20:10);Bn(s,l,30,40,i(e,t[a])?"#29ADFF":"#FF004D");const h=i(e,t[a])?l-5:l+40+8;vn(n.slice(0,5),s+15,h,{size:12,align:"center",strokeColor:"#FFF"}),Mn(`${o}_${c}`,s,l+5,2)}};let Hn=null,Yn=()=>{const e=document.getElementById("dialogBox");window.removeEventListener("keypress",Hn),e.style.opacity="0",e.style.width="0",Ue(!1)};const Rn=(e,t)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",Hn),n.innerHTML=`<div style="width:476px">${e}</div>`,n.style.opacity="1",n.style.width="512px",Hn=e=>{const n=e.key.toUpperCase();n!==Et&&"X"!==n||(window.removeEventListener("keypress",Hn),t())},setTimeout(()=>{window.addEventListener("keypress",Hn)},25),Ue(!0)}})();