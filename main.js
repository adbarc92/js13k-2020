(()=>{window.running=!0,window.addEventListener("load",async()=>{await kn(),na(),O(),(()=>{const e=An();Bn(e),window.world=e;const t=e.party,n=Re(rt,"Jeremiah"),a=Re(ot,"Kana");rn(t,n),rn(t,a);const s=performance.now();let r=s;const o=n=>{const a=(n-r)/16.666;Ge(a>2?2:a),Ye(n-s),r=n,Xn();const i=ye();if(i)Zn(i);else{const n=Hn(e),a=sn(t).actor;_(e),Jn(n,0,0,2),Qn(a,2)}window.running&&requestAnimationFrame(o)};o(s)})()});const e=e=>Math.abs(e)/e,t=(e,t,n,a)=>[e,t,e+n,t+a],n=(e,t)=>[e,t],a=(e,t)=>e.map((e,n)=>((e,t)=>{const[n,a]=e,[s,r,o,i]=t;return n>s&&n<o&&a>r&&a<i})(e,t)?n:-1).filter(e=>e>-1),s=e=>{const[t,a,s,r]=e,o=s-t,i=t+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(t+o/4,c),n(s-o/4,c)]},r=e=>e.reduce((e,t)=>e&&0===t.cS.hp,!0),o=e=>Math.floor(Math.random()*Math.floor(e)),i=(e,t)=>e.allies.includes(t),c=async e=>new Promise(t=>{setTimeout(t,e)}),l=(e,t)=>Math.floor(je()%((e+1)*t)/t),h=async e=>{const t=ke(e);for(u(t);!Ee(t);)await d(e,t),Ce(t);const n=y(t);xe(e,n),Me(e)},d=async(e,t)=>{const n=Te(t);if(_n(n)&&!r(e.enemies)&&e.completionState!==Z){if(n.cS.def!==n.bS.def&&Pn(n),0!==n.cS.spd)return Mn(n),new Promise(a=>{be(a);const s=e.actionMenuStack[0];i(e,n)?(s.disabledItems=n.cS.iCnt<=0?[2,4]:[],s.i=-1,tn(s,1,!0),ge(!0)):setTimeout(()=>{((e,t,n)=>{const a=(s=e.allies)[o(s.length)];var s;const{roundIndex:r,aiSeed:i}=e;switch(n.ai){case Ve:n.cS.cCnt<n.cS.iCnt?p(te,t,null):p(ee,t,a);break;case Je:p(ee,t,a);break;case Qe:p(r%(i+2)==0?ne:ee,t,a)}})(e,t,n)},1e3)});n.cS.spd=n.bS.spd}},p=async(e,t,n)=>{ge(!1);const a=ye(),s=Te(t);switch(Tn(s),V(s.actor,z),a.text=$e(e),await c(1e3),Fn(s,e),e){case ee:const t=f(s,n);if(a.text="Did "+-t+" damage.",aa("actionStrike"),V(n.actor,R),await c(800),V(n.actor,Y),!_n(n)){const e=i(a,n)?G:H;N(n.actor,e)}break;case te:g(s),aa("actionCharge");break;case ae:b(s),aa("actionDefend");break;case se:S(s);break;case ne:w(s,n);break;default:console.error("No action:",e,"exists.")}await c(2e3),En(s),V(s.actor,Y),a.text="",await c(500),Ie()(),m(t)&&$n(s)},m=e=>{const{turnOrder:t}=e;let n=!1;for(let e=0;e<t.length;e++)_n(t[e])||(t.splice(e,1),n=!0);return n},u=e=>{(e=>{e.turnOrder=e.turnOrder.sort((e,t)=>t.cS.spd-e.cS.spd)})(e)},y=e=>ve(e.turnOrder),f=(e,t)=>{const{cS:n,bS:a}=t,{def:s}=n,{dmg:r}=e.bS,{cCnt:o}=e.cS,i=-Math.floor(Math.max((o>0?r*(o+1):r)-s,1));return e.cS.cCnt=0,Cn(n,a,i),i},g=e=>{const{cS:t}=e;t.cCnt++},w=(e,t)=>{e.cS.iCnt--,t.cS.spd=0,t.cS.cCnt=0},S=e=>{const{cS:t,bS:n}=e;t.iCnt--,t.hp=n.hp},b=e=>{const{cS:t}=e;t.def*=1.5};window.addEventListener("keydown",e=>{We()||Vt(e.key)}),window.addEventListener("keyup",e=>{Qt(e.key)});const I=async(e,t)=>(t||aa("cutscene"),new Promise(t=>{ma(e,t)})),x=async(e,t)=>{aa(t||"menuConfirm"),I("",!0);const n=Dn();n.pause=!0,await c(250);for(let t=0;t<e.length;t++){const n=e[t].trim();n&&await I(n)}aa("menuCancel"),n.pause=!1},k=async e=>{const t=(e=>[`This sign says: "${e}"`])(e);await x(t),pa()},v=e=>{const t=Dn(),n=sn(t.party),a=e.actor;N(a,n.actor.x<a.x?B:D)},C=async(e,t,n)=>{let a=[""];const s=Dn().party,r=ln(s,t),o=t.name+"_fixed";Un(o)?a=["You have fixed this statue."]:r?(await x(`\nYou place the '${r.name}' inside the statue.\n...\nSomething awakens inside it.\n`.split("\n")),cn(s,r),await c(150),aa("item"),e.actor.spriteIndex=12,await c(2e3),a=["You have fixed the statue!"],jn(o,!0)):a=`\nThere's a plaque beneath this statue.\nIt says, "${n}"\nThis statue appears to be missing a something...\n`.split("\n"),await x(a),pa()},M=async(e,t,n)=>{const a=Dn();a.pause=!0;const s=a.party,r=sn(a.party),[o,i]=W(r.actor),c=le(s,t);await(async e=>new Promise(async t=>{for(ue(e),ge(!1);!_e(e);)await h(e);ue(null),t()}))(c);const l=Hn(a);if(un(l,e),X(r.actor,o,i),q(r.actor,0,0),c.completionState===Q&&n)for(let e in n)await T(n[e]);a.pause=!1},T=async(e,t)=>{const n=Dn(),{name:a,dsc:s}=e,r=["You acquired: "+a,s];n.pause=!0,await x(r,"item"),pa();const o=Hn(n);t&&un(o,t),on(n.party,e)},E=(e,t)=>{const n=e[t];n<0?e[t]+=1.2:n>0&&(e[t]-=1.2),Math.abs(e[t])<=1.2&&(e[t]=0)},_=e=>{if(e.pause)return;const t=Hn(e),{characters:n}=t;n.forEach(e=>{P(e.actor,t)}),$(e.party,t,e)},$=(e,t,n)=>{const r=sn(e).actor,{ax:o,ay:i,isGround:c}=r;V(r,Y),Ke(null);let l=o,h=i;const d=c?1.2:.04;Zt(Wt)&&(l=-d,N(r,B),V(r,j)),Zt(Xt)&&(l=d,N(r,D),V(r,j)),Zt(Kt)&&r.isGround&&(aa("jump"),h=-5.1,r.vy=0,r.isGround=!1),Zt(qt)&&(r.disablePlatformCollision=!0),r.isGround||V(r,U),K(r,l,h);const[p,m]=P(r,t);(p||m)&&Gn(p,m,n);const u=s(J(r));for(let e in t.characters){const n=t.characters[e],s=n.actor;ze("",n);const r=J(s);let o=!1;a(u,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&ze(i,n),Ke(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},P=(n,r)=>{(e=>{const t=He();e.ay+=e.isGround?1e-4*t:.2*t})(n);let o=0,i=0;const c=He();let{x:l,y:h,vx:d,vy:p,ax:m,ay:u,w:y,h:f}=n,g=d+m*c,w=p+u*c;Math.abs(g)>1.2&&(g=1.2*e(g)),Math.abs(w)>3.2&&(w=3.2*e(w)),q(n,g,w);let S=l+d*c,b=h+p*c;const[I,x]=mn(r);return S<0?(S=0,o=-1):S+y>I&&(S=I-y,o=1),b<0?(b=0,i=-1):b+f>x&&(b=x-f,i=1),X(n,S,b),((e,n)=>{let r,o,i=!1,c=0;const l=yn(n);do{c++,r=!1,o=!1;const n=s(t(e.x,e.y,e.w,e.h)),h={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=t(s.px,s.py,s.size,s.size);fn(s)?a(n,i).forEach(e=>{r=!0,h[e]=s}):e.y+e.h/2<s.py&&a(n,i).forEach(t=>{0!==t||e.disablePlatformCollision||(o=!0,r=!0,h[t]=s)})});const d=h[1],p=h[2],m=h[3],u=1;h[0]?e.vy>0&&(e.y=16*Math.floor((e.y+8)/16),i=!0):d&&(o||(e.y+=u,e.vy=0)),p?e.x+=u:m&&(e.x-=u)}while(r&&c<10);i===e.isGround||i||(e.vy=0),e.isGround=i})(n,r),0===m&&E(n,"vx"),0===u&&E(n,"vy"),K(n,0,0),[o,i]},F={},O=()=>{F["1,1,10,15"]=gt,F["1,1,11,11"]=St,F["1,1,4,9"]=wt,F["1,1,5,15"]=bt,F["0,1,9,15"]=It,F["0,1,7,11"]=Et,F["0,1,9,11"]=Et,F["0,1,11,11"]=Et,F["0,1,13,11"]=Et,F["0,1,8,7"]=Et,F["0,1,10,7"]=Et,F["0,1,12,7"]=Et,F["0,1,14,7"]=$t,F["0,1,7,3"]=Et,F["0,1,9,3"]=Et,F["0,1,11,3"]=Et,F["0,1,13,3"]=_t,F["2,2,2,15"]=Pt,F["2,2,2,12"]=Ht,F["2,2,1,12"]=Ht,F["2,1,5,15"]=Ht,F["2,1,3,15"]=Ht,F["2,1,4,15"]=Ht,F["2,1,3,13"]=Ht,F["2,1,9,9"]=Ht,F["2,1,1,15"]=xt,F["2,1,8,5"]=Ht,F["2,1,10,15"]=Ht,F["2,0,2,2"]=kt,F["3,0,2,3"]=vt,F["3,0,4,10"]=Ht,F["3,0,11,14"]=Ht,F["3,1,2,7"]=Ht,F["3,0,1,14"]=Ht,F["3,0,14,7"]=Ht,F["3,1,12,7"]=Ht,F["3,1,3,14"]=Ht,F["3,2,1,5"]=Ht,F["3,1,14,10"]=Ht,F["3,1,9,12"]=Ht,F["3,1,6,12"]=Ht,F["3,2,2,8"]=Ht,F["3,2,11,4"]=Ht,F["3,2,11,12"]=Ht,F["3,0,7,3"]=Ht,F["3,2,14,12"]=Ht,F["3,3,3,15"]=Ht,F["3,3,14,7"]=Ht,F["3,0,7,9"]=Ht,F["3,1,4,5"]=Ht,F["3,2,4,7"]=Ht,F["3,2,7,7"]=Ht,F["3,2,5,7"]=Ht,F["3,2,5,13"]=Ht,F["3,3,8,5"]=Ht,F["3,3,7,5"]=Ht,F["3,1,7,12"]=Ht,F["3,1,6,4"]=Ht,F["3,3,8,15"]=Ct,F["3,3,1,3"]=Ut,F["0,3,3,15"]=Ht,F["0,3,3,11"]=Ht,F["0,3,8,4"]=Ht,F["0,3,5,3"]=Ht,F["0,3,11,10"]=Ht,F["0,3,12,6"]=Ht,F["0,3,14,12"]=Ht,F["0,3,7,15"]=Ht,F["0,3,1,6"]=Ht,F["0,0,11,5"]=Ht,F["0,0,12,15"]=Ht,F["0,0,7,5"]=Ht,F["0,0,6,15"]=Ht,F["0,0,3,5"]=Ht,F["0,0,3,15"]=Ht,F["0,0,9,15"]=Ht,F["0,0,4,9"]=Ht,F["0,0,6,9"]=Ht,F["0,0,8,9"]=Ht,F["0,0,10,9"]=Ht,F["0,0,12,9"]=Ht,F["1,0,11,13"]=Rt,F["1,0,2,15"]=Mt,F["1,0,13,8"]=Ut,F["2,0,3,9"]=Yt,F["2,0,4,9"]=Yt,F["2,0,5,9"]=Yt,F["2,0,6,8"]=Yt,F["2,0,2,8"]=Yt,F["2,0,8,9"]=Ut,F["0,2,4,15"]=Ut,F["1,1,8,8"]=zt,F["2,2,2,3"]=jt,F["2,2,3,12"]=Ht,F["2,2,11,3"]=Ut,F["2,3,9,15"]=Ht,F["2,3,8,15"]=Ht,F["2,3,7,15"]=Ht,F["2,3,6,15"]=Ht,F["2,3,5,15"]=Ht,F["2,3,4,15"]=Ht,F["2,3,3,15"]=Ht,F["2,3,2,15"]=Ht,F["2,3,10,15"]=Ht,F["2,3,11,15"]=Ht,F["2,3,12,15"]=Ht,F["2,3,13,15"]=Ht,F["2,3,1,15"]=Ht,F["1,3,10,10"]=Tt,F["2,3,15,12"]=Yt,F["3,3,0,12"]=Yt,F["2,2,11,7"]=Ot,F["2,2,5,4"]=Lt,F["1,3,3,15"]=At,F["1,3,6,15"]=Bt,F["1,3,9,15"]=Dt,F["1,3,12,15"]=Gt,F["2,1,12,7"]=Ft,F["0,0,15,9"]=Yt,F["1,0,0,9"]=Yt};var L,A;L=(e=1,t=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,h=0,d=0,p=0,m=0,u=0,y=0,f=0,g=1,w=0,S=44100,b=99+a*S,I=s*S,x=r*S,k=w*S,v=f*S,C=2*Math.PI,M=(e=>0<e?1:-1),T=b+k+I+x+v,E=(c*=500*C/S**2),_=(n*=(1+2*t*Math.random()-t)*C/S),$=M(u)*C/4,P=0,F=0,O=0,L=0,B=0,D=0,G=1,H=[],Y=A.createBufferSource(),j=A.createBuffer(1,T,S))=>{for(Y.connect(A.destination);O<T;H[O++]=D)++B>100*y&&(B=0,D=P*n*Math.sin(F*u*C/S-$),D=M(D=o?1<o?2<o?3<o?Math.sin((D%C)**3):Math.max(Math.min(Math.tan(D),1),-1):1-(2*D/C%2+2)%2:1-4*Math.abs(Math.round(D/C)-D/C):Math.sin(D))*Math.abs(D)**i*e*.3*(O<b?O/b:O<b+k?1-(O-b)/k*(1-g):O<b+k+I?g:O<T-v?(T-O-v)/x*g:0),D=v?D/2+(v>O?0:(O<T-v?1:(O-T)/v)*H[O-v|0]/2):D),P+=1-m+1e9*(Math.sin(O)+1)%2*m,F+=1-m+1e9*(Math.sin(O)**2+1)%2*m,n+=c+=500*l*C/S**3,G&&++G>d*S&&(n+=h*C/S,_+=h*C/S,G=0),p&&++L>p*S&&(n=_,c=E,L=1,G=G||1);return j.getChannelData(0).set(H),Y.buffer=j,Y.start(),Y},A=new AudioContext;const B=0,D=1,G=2,H=3,Y=0,j=1,U=2,z=3,R=4,N=(e,t)=>{e.facing=t},X=(e,t,n)=>{e.x=t,e.y=n},W=e=>[e.x,e.y],q=(e,t,n)=>{e.vx=t,e.vy=n},K=(e,t,n)=>{e.ax=t,e.ay=n},V=(e,t)=>{e.anim=t},J=e=>t(e.x,e.y,e.w,e.h),Q=0,Z=2,ee=0,te=1,ne=2,ae=3,se=4,re=["Strike","Charge","Break","Defend","Heal","Item","Flee"],oe=e=>{const t=[];for(let n=0;n<4;n++)t.push([e,28*n+80]);return t},ie=oe(40),ce=oe(200),le=(e,t,n)=>{n=n||0;const a=Ue(),s=[en(a/2-50,a-20*re.length,100,re,pe,[],!0,20)],r=(e=>{const t=[];for(let n=0;n<e.length;n++){const{unit:a,name:s}=e[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,En(a),N(a.actor,D),t.push(a)}return t})(e.characters),i=(e=>{const t=[];for(let n=0;n<e.length;n++){const a=Re(e[n]).unit;a.i=n,a.allegiance=1,N(a.actor,B),En(a),t.push(a)}return t})(t.enemies),c={party:e,allies:r,enemies:i,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:o(3)+1,completionState:Q};Pe(c,n);const l=ve(r.concat(i));return xe(c,l),c},he=(e,t)=>0===t?ie[e]:ce[e],de=async e=>new Promise(t=>{const n=e.enemies,[a,s]=he(0,1),r=e.enemies.map((e,t)=>t).filter(t=>!_n(e.enemies[t])),o=en(2*a-sa,2*s+ra/2,100,Array(n.length).fill(""),a=>{e.actionMenuStack.shift(),t(a>=0?n[a]:null)},r,!1,56);o.i=-1,tn(o,1),e.actionMenuStack.unshift(o)}),pe=async e=>{const t=ye(),n=ke(t);switch(e){case ee:let a=await de(t);if(!a)return;p(ee,n,a);break;case te:p(te,n,null);break;case ae:p(ae,n,null);break;case se:p(se,n,null);break;case ne:const s=await de(t);if(!s)return;p(ne,n,s);break;default:console.error("Action",e,"Is not implemented yet.")}};let me=null;const ue=e=>{me=e},ye=()=>me;let fe=!1;const ge=e=>{fe=e},we=()=>fe;let Se=()=>{};const be=e=>{Se=e},Ie=()=>Se,xe=(e,t)=>{e.rounds.push(t)},ke=e=>e.rounds[e.roundIndex],ve=e=>({turnOrder:e,currentIndex:0}),Ce=e=>{e.currentIndex++},Me=e=>{e.roundIndex++},Te=e=>e.turnOrder[e.currentIndex]||null,Ee=e=>null===Te(e),_e=e=>r(e.enemies)||r(e.allies)||e.completionState===Z,$e=e=>re[e],Pe=(e,t)=>{if(0===t)return;const n=1===t?e.allies:e.enemies;for(let e=0;e<n.length;e++)n[e].cS.spd+=5};let Fe=null,Oe=1,Le=0;const Ae=(e,t)=>{const n=document.createElement("canvas");return n.width=e,n.height=t,[n,n.getContext("2d"),e,t]},Be=()=>{var e;if(Fe)return Fe;{const[t,n]=Ae(512,512);return t.id="canv",n.imageSmoothingEnabled=!1,null===(e=document.getElementById("innerDiv"))||void 0===e||e.appendChild(t),Fe=t,t}},De=()=>Be().getContext("2d"),Ge=e=>{Oe=e},He=()=>Oe,Ye=e=>{Le=e},je=()=>Le,Ue=()=>512,ze=(e,t)=>{t.aText=e},Re=(e,t)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,name:c}=e,l={sprite:"actors",spriteIndex:n,facing:B,anim:Y,isGround:!1,disablePlatformCollision:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return a&&(l.sprite=a),{name:t||c,actor:l,label:r||"",action:o,col:i,aText:"",unit:s?vn(c,l,e,0,0):void 0}};let Ne=!1,Xe=null;const We=()=>Ne,qe=e=>{Ne=e},Ke=e=>Xe=e,Ve=1,Je=2,Qe=3,Ze=(e,t,n,a,s)=>({hp:e,dmg:t,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),et={name:"Bomb",dsc:"It destroys all enemies!",onUse:()=>{}},tt={name:"Statue's Legs",dsc:"Good for running.",onUse:()=>{}},nt={name:"Statue's Voice",dsc:"The sound a mouth makes.  Not the game show.",onUse:()=>{}},at={name:"Statue's MIND",dsc:"Arguably necessary to have.",onUse:()=>{}},st={name:"",stats:{bS:Ze(90,25,16,5,20),ai:0},sprI:0},rt={name:"",stats:{bS:Ze(85,25,13,6,15),ai:0},sprI:0},ot=(Ze(80,19,18,4,6),{name:"",stats:{bS:Ze(75,23,12,7,10),ai:0},sprI:0}),it={name:"Golem",stats:{bS:Ze(30,20,30,1,5),ai:Je},sprI:5},ct={name:"Fairy",stats:{bS:Ze(20,8,5,5,15),ai:Je},sprI:4},lt={name:"Ape",stats:{bS:Ze(20,30,5,1,15),ai:Je},sprI:6},ht={name:"Breaker",stats:{bS:Ze(40,30,14,1,14),ai:Qe},sprI:7},dt={enemies:[ct,it,ct]},pt={enemies:[lt,lt,ct]},mt={enemies:[lt,lt,it,it]},ut={enemies:[ht,ht,ht]},yt={enemies:[ht,lt,ct]},ft={enemies:[ct]},gt={name:"Old Man",sprI:15,action:async e=>{v(e);const t="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\n:)\nIt may be prudent for you to find what is not found and restore them.\n  ".split("\n");await x(t),pa()}},wt={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async e=>{C(e,tt,"The Runner.")}},St={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async e=>{C(e,at,"The Thinker.")}},bt={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async e=>{C(e,nt,"The Speaker.")}},It={name:"Sign",spr:"terrain",sprI:5,action:()=>k("Probably nothing is in these pots.")},xt={name:"Sign",spr:"terrain",sprI:5,action:()=>k("SPIKES are dangerous.")},kt={name:"Sign",spr:"terrain",sprI:5,action:()=>k("This fall is pointless.")},vt={name:"Sign",spr:"terrain",sprI:5,action:()=>k("This fall is pointy.")},Ct={name:"Sign",spr:"terrain",sprI:5,action:()=>k("(There is a picture of an arrow pointing upwards followed by a `?`)")},Mt={name:"Sign",spr:"terrain",sprI:5,action:()=>k("The SHRINE of LEGS.")},Tt={name:"Sign",spr:"terrain",sprI:5,action:()=>k("Choose wisely")},Et={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const e="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await x(e),pa()}},_t={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const e="\nThere's something strange about this pot...\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await x(e),pa()}},$t={name:"Pot",spr:"terrain",sprI:4,action:async e=>{const t="\nYou check the pot...\n  ".split("\n");await x(t),await T(nt,e),await x(["How did that get in there?"]),pa()}},Pt={name:"Pate",sprI:3,action:async e=>{v(e);let t=[""];t=zn("talked_to_pate")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\nNo? Come back when you have!\n      ".split("\n"),await x(t),pa()}},Ft={name:"",sprI:5,col:async e=>{await M(e,ft,[et])}},Ot={name:"",sprI:5,col:async e=>{await M(e,mt,[et])}},Lt={name:"",sprI:5,col:async e=>{await M(e,dt,[et])}},At={name:"",sprI:5,col:async e=>{await M(e,pt,[et])}},Bt={name:"",sprI:5,col:async e=>{await M(e,ut,[et])}},Dt={name:"",sprI:5,col:async e=>{await M(e,yt,[et])}},Gt={name:"",sprI:5,col:async e=>{await M(e,pt,[et])}},Ht={name:"",spr:"terrain",sprI:6,col:async()=>{const e=Dn();e.pause=!0,aa("spikes"),await c(1e3),e.pause=!1,Yn(Dn())}},Yt={name:"",spr:"terrain",sprI:1},jt={name:"A gleaming item...",spr:"terrain",sprI:11,action:async()=>{const e="\nA gleaming marble radiating shifting hues...\n    ".split("\n");await x(e),pa()}},Ut={name:"Item",spr:"terrain",sprI:11,action:e=>T(et,e)},zt={name:"Orange",sprI:0,stats:{bS:Ze(75,23,12,7,10),ai:Je},action:async e=>{v(e);const t="\nI am the strongest man!\nFight me and I will join you!\n    ".split("\n"),n="\n    Onward, then!\n    ".split("\n");await x(t),pa();const a={enemies:[zt]};await M(e,a);const s=Dn();rn(s.party,e),await x(n),pa()}},Rt={name:"Item",spr:"terrain",sprI:11,action:e=>T(tt,e)},Nt={},Xt="ArrowRight",Wt="ArrowLeft",qt="ArrowDown",Kt=" ",Vt=e=>{if(1===e.length&&(e=e.toUpperCase()),!Nt[e]){if(Nt[e]=!0,"Q"===e&&(window.running=!1),We())return;const t=ye();if(we()&&t){const n=t.actionMenuStack[0];e===qt?tn(n,1):"ArrowUp"===e?tn(n,-1):"Enter"===e?nn(n):"Escape"===e&&t.actionMenuStack.length>1&&an(n)}else if("X"===e||"Enter"===e){const e=Xe;e&&e()}}};let Jt=-1;const Qt=e=>{if(1===e.length&&(e=e.toUpperCase()),e===qt){const e=Dn(),t=sn(e.party).actor;t.disablePlatformCollision&&(clearTimeout(Jt),Jt=setTimeout(()=>{t.disablePlatformCollision=!1},150))}Nt[e]=!1},Zt=e=>(1===e.length&&(e=e.toUpperCase()),Nt[e]),en=(e,t,n,a,s,r,o,i)=>({x:e,y:t,w:n,h:(i=i||16)*a.length,i:0,cb:s,disabledItems:r,items:a,lineHeight:i,bg:!!o}),tn=(e,t,n)=>{const a=e.items.length;let s=0,r=0,o=e.i;do{if(s++,s>30)break;r=o+t,r<0?r=a-1:r>=a&&(r=0),o=r}while(e.disabledItems.includes(r));e.i=r,n||aa("menuMove")},nn=e=>{e.cb(e.i),aa("menuConfirm")},an=e=>{e.cb(-1),aa("menuCancel")},sn=e=>e.characters[0],rn=(e,t)=>{t.unit.ai=0,e.characters.push(t)},on=(e,t)=>{const n=Object.assign({},t);e.inv.push(n),ua(e.inv,!0)},cn=(e,t)=>{const n=e.inv.indexOf(t);n>-1&&e.inv.splice(n,1),ua(e.inv,!0)},ln=(e,t)=>{for(let n in e.inv){const{name:a}=e.inv[n];if(a===t.name)return e.inv[n]}return null},hn={0:[156,100,52],1:[171,82,54],2:[0,228,54],3:[0,135,81],4:[29,43,83],5:[95,87,79],6:[194,195,199],7:[255,241,232],8:[255,0,77],15:[0,0,0]},dn={};for(let e in hn)dn[hn[e].join("")]=+e;const pn=(e,t,n,a)=>{const s=[],r=[],[,o]=Ae(16,16);Vn(e,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let e=0;e<i.length;e+=4){let t=dn[`${i[e+0]}${i[e+1]}${i[e+2]}`]||0;const o=c%16,l=Math.floor(c/16);let h=null;const d=F[[n,a,o,l].join(",")];d&&(h=Re(d)),h&&(X(h.actor,16*o,16*l-16),r.push(h)),s.push({id:t,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:t}},mn=e=>[16*e.w,16*e.h],un=(e,t)=>{const n=e.characters.indexOf(t);n>-1&&e.characters.splice(n,1)},yn=e=>e.tiles.filter(e=>[0,1,2,7].includes(e.id)),fn=e=>[0,1,7].includes(e.id),gn=(e,t,n,a,s)=>[e,t,n,a,s];let wn=null;const Sn=e=>{const[t,n,a,s]=Ae(e.width,e.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(e,-r,-o),t},bn=e=>{const[t,n,a]=Ae(e.width,e.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(e,0,0),t},In=e=>{const[,,,t,n]=e,[a,s]=Ae(t,n);return Vn(e,0,0,1,s),a},xn=(e,t,n,a,s)=>{const r=(t,n,a,s,r,o)=>e[t]=gn(n,a,s,r,o),o=(e,t,n)=>{let o=e;for(let e=0;e<n;e++)o=Sn(o);r(`${t}_r${n}`,o,0,0,a,s)},i=t.width/a,c=t.height/s;for(let e=0;e<c;e++)for(let c=0;c<i;c++){const l=`${n}_${e*i+c}`,h=r(l,t,c*a,e*s,a,s);o(In(h),l,1),o(In(h),l,2),o(In(h),l,3),r(l+"_f",bn(In(h)),0,0,a,s),r(l+"_fr1",Sn(bn(In(h))),0,0,a,s)}},kn=async()=>{const e={},t=await new Promise(e=>{const t=new Image;t.onload=()=>{e(t)},t.src="packed.png"}),n=In(gn(t,0,0,64,64));xn(e,n,"actors",16,16);const a=In(gn(t,64,0,64,64));xn(e,a,"terrain",16,16);const s=In(gn(t,0,64,64,64));xn(e,s,"map",16,16);const r=In(gn(t,64,64,64,64));xn(e,r,"monsters",16,16),wn=e},vn=(e,t,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${e}' has no stats!`);const o={name:e,actor:t,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return N(o.actor,o.allegiance?B:D),En(o),o},Cn=(e,t,n)=>{const{hp:a}=e,{hp:s}=t;let r=a+n;r>s?r=s:r<0&&(r=0),e.hp=r},Mn=e=>{const{allegiance:t}=e,[n,a]=he(e.i,t);X(e.actor,n+(t?-20:20),a)},Tn=e=>{const t=Ue()/2/2-8;X(e.actor,t,t)},En=e=>{const[t,n]=he(e.i,e.allegiance);X(e.actor,t,n)},_n=e=>e.cS.hp>0,$n=e=>{e.cS.iCnt++},Pn=e=>{e.cS.def=e.bS.def},Fn=(e,t)=>{const{cS:n}=e;switch(t){case ee:n.spd+=0;break;case te:n.spd-=2;break;case ne:n.spd-=1;break;case ae:n.spd+=3;break;case se:n.spd-=1;break;case 5:case 6:n.spd-=2}};let On=null;const Ln={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},An=()=>{const e={characters:[Re(st,"Runner")],inv:[],worldX:0,worldY:0},t=sn(e);X(t.actor,128,180);const n={rooms:[],party:e,lastX:128,lastY:180,roomI:1,pause:!1,state:{}};for(let e=0;e<16;e++)n.rooms.push(pn("map_"+e,Ln[e],e%4,Math.floor(e/4)));return n},Bn=e=>{On=e},Dn=()=>On,Gn=(e,t,n)=>{((e,t,n)=>{n.roomI=4*t+e})((n.roomI%4+e+4)%4,(Math.floor(n.roomI/4)+t+4)%4,n);const a=Hn(n),s=sn(n.party).actor,[r,o]=mn(a);let i=0,c=0;e>0&&(i=0,c=s.y),e<0&&(i=r-16,c=s.y),t>0&&(i=s.x,c=0),t<0&&(i=s.x,c=o-16),X(s,i,c),n.lastX=i,n.lastY=c},Hn=e=>e.rooms[e.roomI],Yn=e=>{const t=sn(e.party);X(t.actor,e.lastX,e.lastY)},jn=(e,t)=>{Dn().state[e]=t},Un=e=>Dn().state[e],zn=e=>void 0===Un(e)&&(jn(e,!0),!0),Rn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},Nn={},Xn=()=>{const e=Be();Kn(0,0,e.width,e.height,"#557","#aaf")},Wn=(e,t,n,a,s,r,o)=>{(o=o||De()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](e,t,n,a)},qn=(e,t,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},Rn),a||{});(s=s||De()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(e,t,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(e,t,n))},Kn=(e,t,n,a,s,r)=>{const o=De(),i=`${e},${t},${n},${a},${s},${r}`;if(!Nn[i]){const e=o.createLinearGradient(0,a,0,0);e.addColorStop(0,s),e.addColorStop(1,r),Nn[i]=e}o.fillStyle=Nn[i],o.fillRect(e,t,n,a)},Vn=(e,t,n,a,s)=>{a=a||1,s=s||De();const[r,o,i,c,l]="string"==typeof e?wn[e]:e;s.drawImage(r,o,i,c,l,t,n,c*a,l*a)},Jn=(e,t,n,a)=>{const s=a||1;e.tiles.forEach(r=>{const{id:o,x:i,y:c,size:l}=r,h=(t+i*l)*s,d=(n+c*l)*s;Vn(e.bgSprite,h,d,a),15!=o&&Vn("terrain_"+o,h,d,a)}),e.characters.forEach(e=>{const t=e.actor;Qn(t,a);const{x:n,y:r}=t,o=e.aText;o&&qn(o,n*s+16*s/2,r*s-16*s/2,{size:16,align:"center"})})},Qn=(e,t)=>{t=t||1;const{x:n,y:a}=e,s=n*t,r=a*t,[o,i,c]=(e=>{let{facing:t,sprite:n,spriteIndex:a,anim:s}=e,r=s,o=a<3,i=0;s===j?r-=l(1,100):s===z?o?r=2-l(1,250):(r=0,i=2*l(1,100)):s===R&&(r=o?2:0);let c="";switch(t){case 0:c="_f";break;case 2:c="_r3";break;case 3:c="_fr1"}return[n+"_"+(a+r+c),0,i]})(e);Vn(o,s+i,r+c,t)},Zn=e=>{Xn();const t=Te(ke(e));oa(5,15,150,20),qn("Turn: "+(null==t?void 0:t.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=e,r=s[0];for(let e=0;e<n.length;e++){const[t,a]=W(n[e].actor);X(n[e].actor,t,a),Qn(n[e].actor,2),qn(""+n[e].name,2*t+16,2*a-5,{align:"center"})}la(e,0),la(e,1);for(let e=0;e<a.length;e++){const[t,n]=W(a[e].actor);Qn(a[e].actor,2),qn(`${a[e].name}: ${""+a[e].cS.hp}/${""+a[e].bS.hp}`,2*t+5,2*n-5,{align:"center"})}we()&&ia(r),e.text&&ca(e.text),ha(e)};let ea=null;const ta=(e,t,n)=>{e[t]=n},na=()=>{const e={};ta(e,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),ta(e,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),ta(e,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),ta(e,"jump",[.4,0,1581,.01,,.08,4,.23,,,,,,.1,3.9,,.01,.18]),ta(e,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),ta(e,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),ta(e,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),ta(e,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),ta(e,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),ta(e,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),ta(e,"item",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),ta(e,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),ta(e,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),ea=e},aa=e=>{L(...ea[e])},sa=16,ra=16,oa=(e,t,n,a,s)=>{Wn(e,t,n,a,s=s||"#000"),Wn(e,t,n,a,"#FFF",!0)},ia=e=>{const{x:t,y:n,w:a,h:s,i:r,bg:o,items:i,lineHeight:c}=e;o&&oa(t,n,a,s),i.forEach((s,r)=>{let o="#FFF";e.disabledItems.includes(r)&&(o="#999"),qn(s,t+a/2,n+r*c+c/2,{align:"center",color:o})}),((e,t)=>{const n=De(),a=ra,s=sa;n.save(),n.translate(e+2,t),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(t,n+c*r)},ca=e=>{const t=Ue();oa(0,90,t,50),qn(e,Ue()/2,116,{align:"center",size:20})},la=(e,t)=>{const n=Ue(),a=1===t?n-200:0,s=n-90;oa(a,s,200,90),((e,t)=>{const n=t-25;oa(0,n,200,25),qn("Unit",10,n+12.5),qn("HP",80,n+12.5),qn("Chg",140,n+12.5),qn("Int",170,n+12.5)})(0,s);const r=1===t?e.enemies:e.allies;for(let e=0;e<r.length;e++){const n=r[e],{name:o,bS:i,cS:c}=n;0===t?(qn(o.slice(0,8),a+10,s+15+20*e),qn(`${c.hp}/${i.hp}`,a+80,s+15+20*e),qn(""+c.cCnt,a+145,s+15+20*e),qn(""+c.iCnt,a+175,s+15+20*e)):qn(o.slice(0,8),a+100,s+15+20*e,{align:"center"})}},ha=e=>{const{turnOrder:t}=ke(e),n=t.length,a=35*n;let s=Ue()-Ue()/3-a/2;oa(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:r}=t[a],{sprite:o,spriteIndex:c}=r,l=10+(ke(e).currentIndex===a?20:10);oa(s,l,30,40,i(e,t[a])?"#29ADFF":"#FF004D");const h=i(e,t[a])?l-5:l+40+8;qn(n.slice(0,5),s+15,h,{size:12,align:"center",strokeColor:"#FFF"}),Vn(`${o}_${c}`,s,l+5,2)}};let da=null,pa=()=>{const e=document.getElementById("dialogBox");window.removeEventListener("keypress",da),e.style.opacity="0",e.style.width="0",qe(!1)};const ma=(e,t)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",da),n.innerHTML=`<div style="width:476px">${e}</div>`,n.style.opacity="1",n.style.width="512px",da=e=>{const n=e.key.toUpperCase();n!==Kt&&"X"!==n||(window.removeEventListener("keypress",da),t())},setTimeout(()=>{window.addEventListener("keypress",da)},25),qe(!0)},ua=(e,t)=>{const n=document.getElementById("itemBox");n.innerHTML=`<span class="item">${e.length?"Items:":""}</span>`;for(let t=0;t<e.length;t++){const a=document.createElement("span");a.innerHTML=e[t].name+(t<e.length-1?",":""),a.className="item",n.appendChild(a)}n.style.display=t?"flex":"none"}})();