(()=>{window.running=!0,window.addEventListener("load",async()=>{await Je(),En(),$(),(()=>{const t=hn();dn(t),window.world=t;const e=t.party,n=zt(ae,"Jeremiah"),a=zt(se,"Seph"),s=zt(re,"Kana");Ge(e,n),Ge(e,a),Ge(e,s);const r=st(e,ee);lt(r),h(r);const o=performance.now();let i=o;const c=n=>{const a=(n-i)/16.666;At(a>2?2:a),Lt(n-o),i=n,bn();const s=ht();if(s)Mn(s);else{const n=mn(t),a=De(e).actor;M(t),Cn(n,0,0,2),vn(a,2)}window.running&&requestAnimationFrame(c)};c(o)})()});const t=t=>Math.abs(t)/t,e=(t,e,n,a)=>[t,e,t+n,e+a],n=(t,e)=>[t,e],a=(t,e)=>t.map((t,n)=>((t,e)=>{const[n,a]=t,[s,r,o,i]=e;return n>s&&n<o&&a>r&&a<i})(t,e)?n:-1).filter(t=>t>-1),s=t=>{const[e,a,s,r]=t,o=s-e,i=e+o/2,c=a+(r-a)/2;return[n(i,r),n(i,a),n(e+o/4,c),n(s-o/4,c)]},r=t=>t.reduce((t,e)=>t&&0===e.cS.hp,!0),o=t=>Math.floor(Math.random()*Math.floor(t)),i=(t,e)=>t.allies.includes(e),c=async t=>new Promise(e=>{setTimeout(e,t)}),l=(t,e)=>pn().pause?0:Math.floor(Bt()%((t+1)*e)/e),h=async t=>{for(lt(t),pt(!1);!Ct(t);)await d(t);setTimeout(()=>{const e=st(t.party,te);lt(e),h(e)},2e3)},d=async t=>{const e=wt(t);for(f(e);!kt(e);)await p(t,e),St(e);const n=y(e);gt(t,n),It(t)},p=async(t,e)=>{const n=xt(e);if(an(n)){if(n.cS.def!==n.bS.def&&rn(n),0!==n.cS.spd)return tn(n),new Promise(a=>{ft(a);const s=t.actionMenuStack[0];i(t,n)?(s.disabledItems=n.cS.iCnt<=0?[2,4]:[],s.i=-1,Oe(s,1,!0),pt(!0)):setTimeout(()=>{((t,e,n)=>{const a=(s=t.allies)[o(s.length)];var s;const{roundIndex:r,aiSeed:i}=t;switch(n.ai){case Xt:n.cS.cCnt<n.cS.iCnt?u(V,e,null):u(K,e,a);break;case qt:u(K,e,a);break;case Wt:u(r%(i+2)==0?J:K,e,a)}})(t,e,n)},1e3)});n.cS.spd=n.bS.spd}},u=async(t,e,n)=>{pt(!1);const a=ht(),s=xt(e);switch(en(s),W(s.actor,H),a.text=vt(t),await c(1e3),on(s,t),t){case K:const e=g(s,n);if(a.text="Did "+-e+" damage.",$n("actionStrike"),W(n.actor,Y),await c(800),W(n.actor,D),!an(n)){const t=i(a,n)?L:B;R(n.actor,t)}break;case V:w(s),$n("actionCharge");break;case Q:I(s),$n("actionDefend");break;case Z:S(s);break;case J:b(s,n);break;default:console.error("No action:",t,"exists.")}await c(2e3),nn(s),W(s.actor,D),a.text="",await c(500),yt()(),m(e)&&sn(s)},m=t=>{const{turnOrder:e}=t;let n=!1;for(let t=0;t<e.length;t++)an(e[t])||(e.splice(t,1),n=!0);return n},f=t=>{(t=>{t.turnOrder=t.turnOrder.sort((t,e)=>e.cS.spd-t.cS.spd)})(t)},y=t=>bt(t.turnOrder),g=(t,e)=>{const{cS:n,bS:a}=e,{def:s}=n,{dmg:r}=t.bS,{cCnt:o}=t.cS,i=-Math.floor(Math.max((o>0?r*(o+1):r)-s,1));return t.cS.cCnt=0,Ze(n,a,i),i},w=t=>{const{cS:e}=t;e.cCnt++},b=(t,e)=>{t.cS.iCnt--,e.cS.spd=0,e.cS.cCnt=0},S=t=>{const{cS:e,bS:n}=t;e.iCnt--,e.hp=n.hp},I=t=>{const{cS:e}=t;e.def*=1.5};window.addEventListener("keydown",t=>{Rt()||Ee(t.key)}),window.addEventListener("keyup",t=>{Pe(t.key)});const x=async(t,e)=>(e||$n("cutscene"),new Promise(e=>{Hn(t,e)})),k=async t=>{$n("menuConfirm"),x("",!0),await c(250);for(let e=0;e<t.length;e++){const n=t[e].trim();n&&await x(n)}$n("menuCancel")},C=t=>{const e=pn(),n=De(e.party),a=t.actor;R(a,n.actor.x<a.x?A:O)},v=(t,e)=>{const n=t[e];n<0?t[e]+=1.2:n>0&&(t[e]-=1.2),Math.abs(t[e])<=1.2&&(t[e]=0)},M=t=>{if(t.pause)return;const e=mn(t),{characters:n}=e;n.forEach(t=>{_(t.actor,e)}),T(t.party,e,t)},T=(t,e,n)=>{const r=De(t).actor,{ax:o,ay:i,isGround:c}=r;W(r,D),Ut(null);let l=o,h=i;const d=c?1.2:.04;Fe(Me)&&(l=-d,R(r,A),W(r,G)),Fe(ve)&&(l=d,R(r,O),W(r,G)),Fe(_e)&&r.isGround&&(h=-5.1,r.vy=0,r.isGround=!1),Fe(Te)&&(r.disablePlatformCollision=!0),r.isGround||W(r,z),q(r,l,h);const[p,u]=_(r,e);(p||u)&&un(p,u,n);const m=s(N(r));for(let t in e.characters){const n=e.characters[t],s=n.actor;Gt("",n);const r=N(s);let o=!1;a(m,r).forEach(()=>{o=!0});const i=n.label||n.name;o&&(i&&Gt(i,n),Ut(()=>{n.action&&n.action(n)}),n.col&&n.col(n))}},_=(n,r)=>{(t=>{const e=Ot();t.ay+=t.isGround?1e-4*e:.2*e})(n);let o=0,i=0;const c=Ot();let{x:l,y:h,vx:d,vy:p,ax:u,ay:m,w:f,h:y}=n,g=d+u*c,w=p+m*c;Math.abs(g)>1.2&&(g=1.2*t(g)),Math.abs(w)>3.2&&(w=3.2*t(w)),X(n,g,w);let b=l+d*c,S=h+p*c;const[I,x]=Re(r);return b<0?(b=0,o=-1):b+f>I&&(b=I-f,o=1),S<0?(S=0,i=-1):S+y>x&&(S=x-y,i=1),j(n,b,S),((t,n)=>{let r,o,i=!1,c=0;const l=je(n);do{c++,r=!1,o=!1;const n=s(e(t.x,t.y,t.w,t.h)),h={0:null,1:null,2:null,3:null};l.forEach(s=>{const i=e(s.px,s.py,s.size,s.size);Ue(s)?a(n,i).forEach(t=>{r=!0,h[t]=s}):t.y+t.h/2<s.py&&a(n,i).forEach(e=>{0!==e||t.disablePlatformCollision||(o=!0,r=!0,h[e]=s)})});const d=h[1],p=h[2],u=h[3],m=1;h[0]?t.vy>0&&(t.y=16*Math.floor((t.y+8)/16),i=!0):d?o||(t.y+=m,t.vy=0):p?o||(t.x+=m):u&&(o||(t.x-=m))}while(r&&c<10);i===t.isGround||i||(t.vy=0),t.isGround=i})(n,r),0===u&&v(n,"vx"),0===m&&v(n,"vy"),q(n,0,0),[o,i]},E={},$=()=>{E["1,1,10,15"]=oe,E["1,1,11,11"]=ce,E["1,1,4,9"]=ie,E["1,1,5,15"]=le,E["0,1,9,15"]=he,E["0,1,7,11"]=ye,E["0,1,9,11"]=ye,E["0,1,11,11"]=ye,E["0,1,13,11"]=ye,E["0,1,8,7"]=ye,E["0,1,10,7"]=ye,E["0,1,12,7"]=ye,E["0,1,14,7"]=we,E["0,1,7,3"]=ye,E["0,1,9,3"]=ye,E["0,1,11,3"]=ye,E["0,1,13,3"]=ge,E["2,2,2,15"]=be,E["2,2,3,3"]=xe,E["2,2,2,12"]=Se,E["2,2,1,12"]=Se,E["2,1,5,15"]=Se,E["2,1,3,15"]=Se,E["2,1,4,15"]=Se,E["2,1,3,13"]=Se,E["2,1,9,9"]=Se,E["2,1,1,15"]=de,E["2,1,8,5"]=Se,E["2,1,10,15"]=Se,E["2,0,2,2"]=pe,E["3,0,2,3"]=ue,E["3,0,4,10"]=Se,E["3,0,11,14"]=Se,E["3,1,2,7"]=Se,E["3,0,1,14"]=Se,E["3,0,14,7"]=Se,E["3,1,12,7"]=Se,E["3,1,3,14"]=Se,E["3,2,1,5"]=Se,E["3,1,14,10"]=Se,E["3,1,9,12"]=Se,E["3,1,6,12"]=Se,E["3,2,2,8"]=Se,E["3,2,11,4"]=Se,E["3,2,11,12"]=Se,E["3,0,7,3"]=Se,E["3,2,14,12"]=Se,E["3,3,3,15"]=Se,E["3,3,14,7"]=Se,E["3,0,7,9"]=Se,E["3,1,4,5"]=Se,E["3,2,4,7"]=Se,E["3,2,7,7"]=Se,E["3,2,5,7"]=Se,E["3,2,5,13"]=Se,E["3,3,8,5"]=Se,E["3,3,7,5"]=Se,E["3,1,7,12"]=Se,E["3,1,6,4"]=Se,E["3,3,8,15"]=me,E["3,3,1,3"]=ke,E["0,3,3,15"]=Se,E["0,3,3,11"]=Se,E["0,3,8,4"]=Se,E["0,3,5,3"]=Se,E["0,3,11,10"]=Se,E["0,3,12,6"]=Se,E["0,3,14,12"]=Se,E["0,3,7,15"]=Se,E["0,3,1,6"]=Se,E["0,0,11,5"]=Se,E["0,0,12,15"]=Se,E["0,0,7,5"]=Se,E["0,0,6,15"]=Se,E["0,0,3,5"]=Se,E["0,0,3,15"]=Se,E["0,0,9,15"]=Se,E["0,0,5,10"]=Se,E["0,0,7,10"]=Se,E["0,0,9,10"]=Se,E["0,0,11,10"]=Se,E["0,0,13,10"]=Se,E["1,0,11,13"]=ke,E["1,0,2,15"]=fe,E["1,0,13,8"]=ke,E["2,0,3,9"]=Ie,E["2,0,4,9"]=Ie,E["2,0,5,9"]=Ie,E["2,0,6,8"]=Ie,E["2,0,2,8"]=Ie,E["2,0,8,9"]=ke};var P,F;P=(t=1,e=.05,n=220,a=0,s=0,r=.1,o=0,i=1,c=0,l=0,h=0,d=0,p=0,u=0,m=0,f=0,y=0,g=1,w=0,b=44100,S=99+a*b,I=s*b,x=r*b,k=w*b,C=y*b,v=2*Math.PI,M=(t=>0<t?1:-1),T=S+k+I+x+C,_=(c*=500*v/b**2),E=(n*=(1+2*e*Math.random()-e)*v/b),$=M(m)*v/4,P=0,A=0,O=0,L=0,B=0,D=0,G=1,z=[],H=F.createBufferSource(),Y=F.createBuffer(1,T,b))=>{for(H.connect(F.destination);O<T;z[O++]=D)++B>100*f&&(B=0,D=P*n*Math.sin(A*m*v/b-$),D=M(D=o?1<o?2<o?3<o?Math.sin((D%v)**3):Math.max(Math.min(Math.tan(D),1),-1):1-(2*D/v%2+2)%2:1-4*Math.abs(Math.round(D/v)-D/v):Math.sin(D))*Math.abs(D)**i*t*.3*(O<S?O/S:O<S+k?1-(O-S)/k*(1-g):O<S+k+I?g:O<T-C?(T-O-C)/x*g:0),D=C?D/2+(C>O?0:(O<T-C?1:(O-T)/C)*z[O-C|0]/2):D),P+=1-u+1e9*(Math.sin(O)+1)%2*u,A+=1-u+1e9*(Math.sin(O)**2+1)%2*u,n+=c+=500*l*v/b**3,G&&++G>d*b&&(n+=h*v/b,E+=h*v/b,G=0),p&&++L>p*b&&(n=E,c=_,L=1,G=G||1);return Y.getChannelData(0).set(z),H.buffer=Y,H.start(),H},F=new AudioContext;const A=0,O=1,L=2,B=3,D=0,G=1,z=2,H=3,Y=4,R=(t,e)=>{t.facing=e},j=(t,e,n)=>{t.x=e,t.y=n},U=t=>[t.x,t.y],X=(t,e,n)=>{t.vx=e,t.vy=n},q=(t,e,n)=>{t.ax=e,t.ay=n},W=(t,e)=>{t.anim=e},N=t=>e(t.x,t.y,t.w,t.h),K=0,V=1,J=2,Q=3,Z=4,tt=["Strike","Charge","Break","Defend","Heal","Item","Flee"],et=t=>{const e=[];for(let n=0;n<4;n++)e.push([t,28*n+80]);return e},nt=et(40),at=et(200),st=(t,e,n)=>{n=n||0;const a=Dt(),s=[Ae(a/2-50,a-20*tt.length,100,tt,it,[],!0,20)],r=(t=>{const e=[];for(let n=0;n<t.length;n++){const{unit:a,name:s}=t[n];if(!a)throw Error("Character has no unit when making battle party");a.name=s,a.i=n,a.allegiance=0,nn(a),e.push(a)}return e})(t.characters),i=(t=>{const e=[];for(let n=0;n<t.length;n++){const a=zt(t[n]).unit;a.i=n,a.allegiance=1,R(a.actor,A),nn(a),e.push(a)}return e})(e.enemies),c={party:t,allies:r,enemies:i,rounds:[],roundIndex:0,actionMenuStack:s,text:"",aiSeed:o(3)+1};Mt(c,n);const l=bt(r.concat(i));return gt(c,l),c},rt=(t,e)=>0===e?nt[t]:at[t],ot=async t=>new Promise(e=>{const n=t.enemies,[a,s]=rt(0,1),r=t.enemies.map((t,e)=>e).filter(e=>!an(t.enemies[e])),o=Ae(2*a-Pn,2*s+Fn/2,100,Array(n.length).fill(""),a=>{t.actionMenuStack.shift(),e(a>=0?n[a]:null)},r,!1,56);o.i=-1,Oe(o,1),t.actionMenuStack.unshift(o)}),it=async t=>{const e=ht(),n=wt(e);switch(t){case K:let a=await ot(e);if(!a)return;u(K,n,a);break;case V:u(V,n,null);break;case Q:u(Q,n,null);break;case Z:u(Z,n,null);break;case J:const s=await ot(e);if(!s)return;u(J,n,s);break;default:console.error("Action",t,"Is not implemented yet.")}};let ct=null;const lt=t=>{ct=t},ht=()=>ct;let dt=!1;const pt=t=>{dt=t},ut=()=>dt;let mt=()=>{};const ft=t=>{mt=t},yt=()=>mt,gt=(t,e)=>{t.rounds.push(e)},wt=t=>t.rounds[t.roundIndex],bt=t=>({turnOrder:t,currentIndex:0}),St=t=>{t.currentIndex++},It=t=>{t.roundIndex++},xt=t=>t.turnOrder[t.currentIndex]||null,kt=t=>null===xt(t),Ct=t=>r(t.enemies)||r(t.allies),vt=t=>tt[t],Mt=(t,e)=>{if(0===e)return;const n=1===e?t.allies:t.enemies;for(let t=0;t<n.length;t++)n[t].cS.spd+=5};let Tt=null,_t=1,Et=0;const $t=(t,e)=>{const n=document.createElement("canvas");return n.width=t,n.height=e,[n,n.getContext("2d"),t,e]},Pt=()=>{var t;if(Tt)return Tt;{const[e,n]=$t(512,512);return e.id="canv",n.imageSmoothingEnabled=!1,null===(t=document.getElementById("innerDiv"))||void 0===t||t.appendChild(e),Tt=e,e}},Ft=()=>Pt().getContext("2d"),At=t=>{_t=t},Ot=()=>_t,Lt=t=>{Et=t},Bt=()=>Et,Dt=()=>512,Gt=(t,e)=>{e.aText=t},zt=(t,e)=>{const{sprI:n,spr:a,stats:s,label:r,action:o,col:i,name:c}=t,l={sprite:"actors",spriteIndex:n,facing:A,anim:D,isGround:!1,disablePlatformCollision:!1,x:0,y:0,vx:0,vy:0,ax:0,ay:0,w:16,h:16};return a&&(l.sprite=a),{name:e||c,actor:l,label:r||"",action:o,col:i,aText:"",unit:s?Qe(c,l,t,0,0):void 0}};let Ht=!1,Yt=null;const Rt=()=>Ht,jt=t=>{Ht=t},Ut=t=>Yt=t,Xt=1,qt=2,Wt=3,Nt=t=>`This sign says: "${t}"`,Kt=(t,e,n,a,s)=>({hp:t,dmg:e,def:n,mag:a,spd:s,iCnt:a,cCnt:0}),Vt={name:"Golem",stats:{bS:Kt(30,20,30,1,5),ai:qt},sprI:5},Jt={name:"Fairy",stats:{bS:Kt(20,8,5,5,15),ai:qt},sprI:4},Qt={name:"Ape",stats:{bS:Kt(20,30,5,1,15),ai:qt},sprI:6},Zt={name:"Breaker",stats:{bS:Kt(40,30,14,1,14),ai:Wt},sprI:7},te={enemies:[Vt,Vt,Vt]},ee={enemies:[Zt,Qt,Jt]},ne={name:"",stats:{bS:Kt(90,24,16,5,20),ai:0},sprI:0},ae={name:"",stats:{bS:Kt(85,25,13,6,15),ai:0},sprI:0},se={name:"",stats:{bS:Kt(80,19,18,4,6),ai:0},sprI:0},re={name:"",stats:{bS:Kt(75,23,12,7,10),ai:0},sprI:0},oe={name:"Old Man",sprI:15,action:async t=>{C(t);const e="\nHello there.\nI see you've arrived with your wits about you.\nThat's very good.  You'll need them.\nIf you examine the statues in this cave, you'll notice that they're all...\n...missing something.\nIf you seek refuge from this place, it may be prudent to find what is not found.\n  ".split("\n");await k(e),zn()}},ie={name:"Runner Without Legs",spr:"terrain",sprI:8,action:async()=>{let t=[""];const e="This statue appears to be missing a pair of legs.";t=yn("examined_runner")?`\nThere's a plaque beneath this statue.\nIt says, "The Runner."\n${e}\n  `.split("\n"):(""+e).split("\n"),await k(t),zn()}},ce={name:"Thinker Without Mind",spr:"terrain",sprI:8,action:async()=>{let t=[""];const e="This statue appears to be missing a brain.";t=yn("examined_thinker")?`\nThere's a plaque beneath this statue.\nIt says, "The Thinker."\n${e}\n  `.split("\n"):`\n      ${e}\n      `.split("\n"),await k(t),zn()}},le={name:"Speaker Without Voice",spr:"terrain",sprI:8,action:async()=>{let t=[""];const e="This statue appears to be missing a voice.";t=yn("examined_speaker")?`\nThere's a plaque beneath this statue.\nIt says, "The Speaker."\n${e}\n  `.split("\n"):(""+e).split("\n"),await k(t),zn()}},he={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("Probably nothing is in these pots.")];await k(t),zn()}},de={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("SPIKES are dangerous.")];await k(t),zn()}},pe={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("This fall is pointless.")];await k(t),zn()}},ue={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("This fall is pointy.")];await k(t),zn()}},me={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("This cliff is tall.")];await k(t),zn()}},fe={name:"Sign",spr:"terrain",sprI:5,action:async()=>{const t=[Nt("The SHRINE of LEGS.")];await k(t),zn()}},ye={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const t="\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(t),zn()}},ge={name:"Pot!",spr:"terrain",sprI:4,action:async()=>{const t="\nThere's something strange about this pot...\nYou check the pot...\nThere's nothing inside.\n  ".split("\n");await k(t),zn()}},we={name:"Pot",spr:"terrain",sprI:4,action:async()=>{const t="\nYou check the pot...\nThere's a VOICE inside!\n  ".split("\n");await k(t),zn()}},be={name:"Pate",sprI:3,action:async t=>{C(t);let e=[""];e=yn("talked_to_pate")?"\nHello friend!\nI seem to have misplaced some treasure.\nIf you'd kindly bring it to me.  I'd be happy to accompany you out of here.\n    ".split("\n"):"\nHave you found my treasure yet?\nNo? Come back when you have!\n      ".split("\n"),await k(e),zn()}},Se={name:"",spr:"terrain",sprI:6,col:async()=>{const t=pn();t.pause=!0,$n("spikes"),await c(1e3),t.pause=!1,fn(pn())}},Ie={name:"",spr:"terrain",sprI:1},xe={name:"A gleaming item...",spr:"terrain",sprI:4,action:async()=>{const t="\nA gleaming marble radiating shifting hues...\n    ".split("\n");await k(t),zn()}},ke={name:"Item",spr:"terrain",sprI:11,action:async()=>{const t=["You acquired: Bomb"];await k(t),zn()}},Ce={},ve="ArrowRight",Me="ArrowLeft",Te="ArrowDown",_e=" ",Ee=t=>{if(1===t.length&&(t=t.toUpperCase()),!Ce[t]){if(Ce[t]=!0,"Q"===t&&(window.running=!1),Rt())return;const e=ht();if(ut()&&e){const n=e.actionMenuStack[0];t===Te?Oe(n,1):"ArrowUp"===t?Oe(n,-1):"Enter"===t?Le(n):"Escape"===t&&e.actionMenuStack.length>1&&Be(n)}else if("X"===t||"Enter"===t){const t=Yt;t&&t()}}};let $e=-1;const Pe=t=>{if(1===t.length&&(t=t.toUpperCase()),t===Te){const t=pn(),e=De(t.party).actor;e.disablePlatformCollision&&(clearTimeout($e),$e=setTimeout(()=>{e.disablePlatformCollision=!1},150))}Ce[t]=!1},Fe=t=>(1===t.length&&(t=t.toUpperCase()),Ce[t]),Ae=(t,e,n,a,s,r,o,i)=>({x:t,y:e,w:n,h:(i=i||16)*a.length,i:0,cb:s,disabledItems:r,items:a,lineHeight:i,bg:!!o}),Oe=(t,e,n)=>{const a=t.items.length;let s=0,r=0,o=t.i;do{if(s++,s>30)break;r=o+e,r<0?r=a-1:r>=a&&(r=0),o=r}while(t.disabledItems.includes(r));t.i=r,n||$n("menuMove")},Le=t=>{t.cb(t.i),$n("menuConfirm")},Be=t=>{t.cb(-1),$n("menuCancel")},De=t=>t.characters[0],Ge=(t,e)=>{t.characters.push(e)},ze={0:[156,100,52],1:[171,82,54],2:[0,228,54],3:[0,135,81],4:[29,43,83],5:[95,87,79],6:[194,195,199],7:[255,241,232],8:[255,0,77],15:[0,0,0]},He={};for(let t in ze)He[ze[t].join("")]=+t;const Ye=(t,e,n,a)=>{const s=[],r=[],[,o]=$t(16,16);kn(t,0,0,1,o);const{data:i}=o.getImageData(0,0,16,16);let c=0;for(let t=0;t<i.length;t+=4){let e=He[`${i[t+0]}${i[t+1]}${i[t+2]}`]||0;const o=c%16,l=Math.floor(c/16);let h=null;const d=E[[n,a,o,l].join(",")];d&&(h=zt(d)),h&&(j(h.actor,16*o,16*l-16),r.push(h)),s.push({id:e,x:o,y:l,px:16*o,py:16*l,size:16}),c++}return{tiles:s,characters:r,w:16,h:16,bgSprite:e}},Re=t=>[16*t.w,16*t.h],je=t=>t.tiles.filter(t=>[0,1,2,7].includes(t.id)),Ue=t=>[0,1,7].includes(t.id),Xe=(t,e,n,a,s)=>[t,e,n,a,s];let qe=null;const We=t=>{const[e,n,a,s]=$t(t.width,t.height),r=a/2,o=s/2;return n.translate(r,o),n.rotate(Math.PI/2),n.drawImage(t,-r,-o),e},Ne=t=>{const[e,n,a]=$t(t.width,t.height);return n.translate(a,0),n.scale(-1,1),n.drawImage(t,0,0),e},Ke=t=>{const[,,,e,n]=t,[a,s]=$t(e,n);return kn(t,0,0,1,s),a},Ve=(t,e,n,a,s)=>{const r=(e,n,a,s,r,o)=>t[e]=Xe(n,a,s,r,o),o=(t,e,n)=>{let o=t;for(let t=0;t<n;t++)o=We(o);r(`${e}_r${n}`,o,0,0,a,s)},i=e.width/a,c=e.height/s;for(let t=0;t<c;t++)for(let c=0;c<i;c++){const l=`${n}_${t*i+c}`,h=r(l,e,c*a,t*s,a,s);o(Ke(h),l,1),o(Ke(h),l,2),o(Ke(h),l,3),r(l+"_f",Ne(Ke(h)),0,0,a,s),r(l+"_fr1",We(Ne(Ke(h))),0,0,a,s)}},Je=async()=>{const t={},e=await new Promise(t=>{const e=new Image;e.onload=()=>{t(e)},e.src="packed.png"}),n=Ke(Xe(e,0,0,64,64));Ve(t,n,"actors",16,16);const a=Ke(Xe(e,64,0,64,64));Ve(t,a,"terrain",16,16);const s=Ke(Xe(e,0,64,64,64));Ve(t,s,"map",16,16);const r=Ke(Xe(e,64,64,64,64));Ve(t,r,"monsters",16,16),qe=t},Qe=(t,e,n,a,s)=>{const{stats:r}=n;if(!r)throw Error(`CharacterDef '${t}' has no stats!`);const o={name:t,actor:e,bS:Object.assign({},r.bS),cS:Object.assign({},r.bS),i:s,allegiance:a,ai:r.ai};return R(o.actor,o.allegiance?A:O),nn(o),o},Ze=(t,e,n)=>{const{hp:a}=t,{hp:s}=e;let r=a+n;r>s?r=s:r<0&&(r=0),t.hp=r},tn=t=>{const{allegiance:e}=t,[n,a]=rt(t.i,e);j(t.actor,n+(e?-20:20),a)},en=t=>{const e=Dt()/2/2-8;j(t.actor,e,e)},nn=t=>{const[e,n]=rt(t.i,t.allegiance);j(t.actor,e,n)},an=t=>t.cS.hp>0,sn=t=>{t.cS.iCnt++},rn=t=>{t.cS.def=t.bS.def},on=(t,e)=>{const{cS:n}=t;switch(e){case K:n.spd+=0;break;case V:n.spd-=2;break;case J:n.spd-=1;break;case Q:n.spd+=3;break;case Z:n.spd-=1;break;case 5:case 6:n.spd-=2}};let cn=null;const ln={0:"terrain_9",1:"terrain_10",2:"terrain_10",3:"terrain_9",4:"terrain_10",5:"terrain_9",6:"terrain_9",7:"terrain_9",8:"terrain_9",9:"terrain_9",10:"terrain_9",11:"terrain_9",12:"terrain_9",13:"terrain_9",14:"terrain_9",15:"terrain_9"},hn=()=>{const t={characters:[zt(ne,"Runner")],inv:[],worldX:0,worldY:0},e=De(t);j(e.actor,128,180);const n={rooms:[],party:t,lastX:128,lastY:180,roomI:15,pause:!1,state:{}};for(let t=0;t<16;t++)n.rooms.push(Ye("map_"+t,ln[t],t%4,Math.floor(t/4)));return n},dn=t=>{cn=t},pn=()=>cn,un=(t,e,n)=>{((t,e,n)=>{n.roomI=4*e+t})((n.roomI%4+t+4)%4,(Math.floor(n.roomI/4)+e+4)%4,n);const a=mn(n),s=De(n.party).actor,[r,o]=Re(a);let i=0,c=0;t>0&&(i=0,c=s.y),t<0&&(i=r-16,c=s.y),e>0&&(i=s.x,c=0),e<0&&(i=s.x,c=o-16),j(s,i,c),n.lastX=i,n.lastY=c},mn=t=>t.rooms[t.roomI],fn=t=>{const e=De(t.party);j(e.actor,t.lastX,t.lastY)},yn=t=>void 0===(t=>pn().state[t])(t)&&(((t,e)=>{pn().state[t]=!0})(t),!0),gn={font:"monospace",color:"#fff",size:14,align:"left",strokeColor:""},wn={},bn=()=>{const t=Pt();xn(0,0,t.width,t.height,"#557","#aaf")},Sn=(t,e,n,a,s,r,o)=>{(o=o||Ft()).lineWidth=1,o[r?"strokeStyle":"fillStyle"]=s,o[r?"strokeRect":"fillRect"](t,e,n,a)},In=(t,e,n,a,s)=>{const{font:r,size:o,color:i,align:c,strokeColor:l}=Object.assign(Object.assign({},gn),a||{});(s=s||Ft()).font=`${o}px ${r}`,s.fillStyle=i,s.textAlign=c,s.textBaseline="middle",s.fillText(t,e,n),l&&(s.strokeStyle=l,s.lineWidth=.5,s.strokeText(t,e,n))},xn=(t,e,n,a,s,r)=>{const o=Ft(),i=`${t},${e},${n},${a},${s},${r}`;if(!wn[i]){const t=o.createLinearGradient(0,a,0,0);t.addColorStop(0,s),t.addColorStop(1,r),wn[i]=t}o.fillStyle=wn[i],o.fillRect(t,e,n,a)},kn=(t,e,n,a,s)=>{a=a||1,s=s||Ft();const[r,o,i,c,l]="string"==typeof t?qe[t]:t;s.drawImage(r,o,i,c,l,e,n,c*a,l*a)},Cn=(t,e,n,a)=>{const s=a||1;t.tiles.forEach(r=>{const{id:o,x:i,y:c,size:l}=r,h=(e+i*l)*s,d=(n+c*l)*s;kn(t.bgSprite,h,d,a),15!=o&&kn("terrain_"+o,h,d,a)}),t.characters.forEach(t=>{const e=t.actor;vn(e,a);const{x:n,y:r}=e,o=t.aText;o&&In(o,n*s+16*s/2,r*s-16*s/2,{size:16,align:"center"})})},vn=(t,e)=>{e=e||1;const{x:n,y:a}=t,s=n*e,r=a*e,[o,i,c]=(t=>{let{facing:e,sprite:n,spriteIndex:a,anim:s}=t,r=s,o=a<3,i=0;s===G?r-=l(1,100):s===H?o?r=2-l(1,250):(r=0,i=2*l(1,100)):s===Y&&(r=o?2:0);let c="";switch(e){case 0:c="_f";break;case 2:c="_r3";break;case 3:c="_fr1"}return[n+"_"+(a+r+c),0,i]})(t);kn(o,s+i,r+c,e)},Mn=t=>{bn();const e=xt(wt(t));An(5,15,150,20),In("Turn: "+(null==e?void 0:e.name),10,26);const{allies:n,enemies:a,actionMenuStack:s}=t,r=s[0];for(let t=0;t<n.length;t++){const[e,a]=U(n[t].actor);j(n[t].actor,e,a),vn(n[t].actor,2),In(""+n[t].name,2*e+16,2*a-5,{align:"center"})}Bn(t,0),Bn(t,1);for(let t=0;t<a.length;t++){const[e,n]=U(a[t].actor);vn(a[t].actor,2),In(`${a[t].name}: ${""+a[t].cS.hp}/${""+a[t].bS.hp}`,2*e+5,2*n-5,{align:"center"})}ut()&&On(r),t.text&&Ln(t.text),Dn(t)};let Tn=null;const _n=(t,e,n)=>{t[e]=n},En=()=>{const t={};_n(t,"menuMove",[.6,0,1248,.04,,0,2,2.23,99,.8,,,,,,,,0,.05]),_n(t,"menuConfirm",[.4,0,1469,,,.08,,.14,56,,,,,,,,.04,,.04]),_n(t,"menuCancel",[.4,,1056,.03,,.06,3,.74,,.3,-38,.04,,,6,,,,.03]),_n(t,"jump",[,,223,.01,.1,.22,1,1.35,.1,,,,,.4,,,,.55,.09]),_n(t,"explosion",[,,518,.01,.05,1.59,4,1.24,.5,.4,,,,.3,,.7,.13,.58,.01]),_n(t,"actionStrike",[,,224,,.08,.17,4,1.12,4.7,-4.2,,,,1.6,-.9,.1,.01,.82,.01]),_n(t,"actionCharge",[,0,11,.16,.34,.06,2,2.05,,60,,,,,-1.2,.5,,,.01]),_n(t,"actionDefend",[,,1396,,.1,.14,1,.91,,,,,,.1,,.1,,.71,.07]),_n(t,"turnChime",[,0,750,.08,.05,.09,1,.01,,,,,.02,,,,.15,.4,.03]),_n(t,"death",[1.1,0,170,.06,,1.17,4,.7,.8,1.5,50,,,.5,,.6,,.7]),_n(t,"item",[,,1320,.05,,.07,1,.01,,8.3,531,,.02,,,,,.49,.04,.08]),_n(t,"cutscene",[,0,286,.01,,.07,,1.24,-.2,,-278,.13,,,,,,.26,.03]),_n(t,"spikes",[,,986,.02,,.05,,.05,15,46,,,,,-.8,.3,,,.02]),Tn=t},$n=t=>{P(...Tn[t])},Pn=16,Fn=16,An=(t,e,n,a,s)=>{Sn(t,e,n,a,s=s||"#000"),Sn(t,e,n,a,"#FFF",!0)},On=t=>{const{x:e,y:n,w:a,h:s,i:r,bg:o,items:i,lineHeight:c}=t;o&&An(e,n,a,s),i.forEach((s,r)=>{let o="#FFF";t.disabledItems.includes(r)&&(o="#999"),In(s,e+a/2,n+r*c+c/2,{align:"center",color:o})}),((t,e)=>{const n=Ft(),a=Fn,s=Pn;n.save(),n.translate(t+2,e),n.beginPath(),n.moveTo(0,0),n.lineTo(0,a),n.lineTo(s,a/2),n.closePath(),n.fillStyle="#FFF",n.fill(),n.restore()})(e,n+c*r)},Ln=t=>{const e=Dt();An(0,90,e,50),In(t,Dt()/2,116,{align:"center",size:20})},Bn=(t,e)=>{const n=Dt(),a=1===e?n-200:0,s=n-90;An(a,s,200,90),((t,e)=>{const n=e-25;An(0,n,200,25),In("Unit",10,n+12.5),In("HP",80,n+12.5),In("Chg",140,n+12.5),In("Int",170,n+12.5)})(0,s);const r=1===e?t.enemies:t.allies;for(let t=0;t<r.length;t++){const n=r[t],{name:o,bS:i,cS:c}=n;0===e?(In(o.slice(0,8),a+10,s+15+20*t),In(`${c.hp}/${i.hp}`,a+80,s+15+20*t),In(""+c.cCnt,a+145,s+15+20*t),In(""+c.iCnt,a+175,s+15+20*t)):In(o.slice(0,8),a+100,s+15+20*t,{align:"center"})}},Dn=t=>{const{turnOrder:e}=wt(t),n=e.length,a=35*n;let s=Dt()-Dt()/3-a/2;An(s-5,5,a+5,80);for(let a=0;a<n;a++,s+=35){const{name:n,actor:r}=e[a],{sprite:o,spriteIndex:c}=r,l=10+(wt(t).currentIndex===a?20:10);An(s,l,30,40,i(t,e[a])?"#29ADFF":"#FF004D");const h=i(t,e[a])?l-5:l+40+8;In(n.slice(0,5),s+15,h,{size:12,align:"center",strokeColor:"#FFF"}),kn(`${o}_${c}`,s,l+5,2)}};let Gn=null,zn=()=>{const t=document.getElementById("dialogBox");window.removeEventListener("keypress",Gn),t.style.opacity="0",t.style.width="0",jt(!1)};const Hn=(t,e)=>{const n=document.getElementById("dialogBox");window.removeEventListener("keypress",Gn),n.innerHTML=`<div style="width:476px">${t}</div>`,n.style.opacity="1",n.style.width="512px",Gn=t=>{const n=t.key.toUpperCase();n!==_e&&"X"!==n||(window.removeEventListener("keypress",Gn),e())},setTimeout(()=>{window.addEventListener("keypress",Gn)},25),jt(!0)}})();